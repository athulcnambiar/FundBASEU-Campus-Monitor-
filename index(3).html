<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'DM Sans', sans-serif;
  background: #0f0f1a;
  min-height: 100vh;
  padding: 15px 15px 90px 15px;
  color: #fff;
}

/* HEADER */
header { text-align:center; margin-bottom:12px; padding-top:8px; }
header h1 {
  font-family:'Space Grotesk',sans-serif;
  font-size:1.9em; font-weight:800;
  background:linear-gradient(135deg,#a78bfa,#60a5fa,#34d399);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  letter-spacing:-1px; margin-bottom:4px;
}
header p { font-size:0.8em; color:#666; margin-bottom:8px; }
.updates-link {
  display:inline-block;
  background:rgba(167,139,250,0.15); padding:6px 14px; border-radius:20px;
  color:#a78bfa; text-decoration:none; font-size:0.8em; font-weight:600;
  border:1px solid rgba(167,139,250,0.3);
}

/* NOTIFICATION BANNER */
.notif-banner {
  display:none;
  background:linear-gradient(135deg,#1e1b4b,#1e3a5f);
  border:1px solid #4f46e5; border-radius:12px;
  padding:10px 14px; margin:10px 0;
  font-size:0.8em; color:#a5b4fc;
  align-items:center; gap:10px; flex-wrap:wrap;
}
.notif-banner.show { display:flex; }
.notif-banner-text { flex:1; }
.notif-btn {
  background:#4f46e5; border:none; color:white;
  padding:6px 14px; border-radius:8px; font-size:0.82em;
  font-weight:700; cursor:pointer; white-space:nowrap;
  font-family:'Space Grotesk',sans-serif;
}
.notif-status { font-size:0.72em; color:#818cf8; margin-top:4px; width:100%; }

/* LIVE TICKER */
.ticker-wrap {
  background:#12121f; border:1px solid #1e1e35; border-radius:12px;
  padding:7px 12px; margin:10px 0;
  display:flex; align-items:center; gap:10px; overflow:hidden;
}
.ticker-live {
  font-family:'Space Grotesk',sans-serif;
  font-size:0.62em; font-weight:800; color:#ef4444;
  letter-spacing:1.5px; white-space:nowrap;
  display:flex; align-items:center; gap:5px; flex-shrink:0;
}
.live-dot {
  width:6px; height:6px; border-radius:50%;
  background:#ef4444; animation:blink 1s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.ticker-viewport { flex:1; overflow:hidden; position:relative; }
.ticker-track {
  display:flex; gap:0; white-space:nowrap;
  animation:ticker 25s linear infinite;
}
.ticker-track:hover { animation-play-state:paused; }
@keyframes ticker { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
.tick-item { font-size:0.75em; color:#64748b; padding-right:40px; }
.tick-item b { color:#94a3b8; font-weight:500; }

/* STATS */
.stats-bar {
  display:flex; justify-content:center; gap:28px;
  margin:12px 0; flex-wrap:wrap;
}
.stat-box { text-align:center; }
.stat-num {
  font-family:'Space Grotesk',sans-serif;
  font-size:1.7em; font-weight:800; display:block; color:#fff;
}
.stat-lbl { font-size:0.72em; color:#555; }

/* SECTION LABEL */
.sec-label {
  font-family:'Space Grotesk',sans-serif;
  font-size:0.65em; font-weight:700; letter-spacing:2px;
  text-transform:uppercase; color:#444; margin:14px 0 8px 2px;
}

/* GRID */
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(155px,1fr));
  gap:10px; margin-bottom:6px;
}

/* CARDS */
.card {
  background:#1a1a2e; border-radius:16px; padding:15px;
  box-shadow:0 4px 18px rgba(0,0,0,0.4);
  cursor:pointer; border:1px solid #242438;
  transition:transform 0.2s,box-shadow 0.2s;
  -webkit-tap-highlight-color:transparent;
  position:relative; overflow:hidden;
}
.card::after {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,0.025),transparent);
  pointer-events:none;
}
.card:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(0,0,0,0.5); }
.card:active { transform:scale(0.97); }

/* card color states */
.card.food-yes  { background:linear-gradient(135deg,#064e3b,#065f46); border-color:#10b981; }
.card.food-no   { background:linear-gradient(135deg,#7f1d1d,#991b1b); border-color:#ef4444; }
.card.gym-free  { background:linear-gradient(135deg,#064e3b,#065f46); border-color:#10b981; }
.card.gym-busy  { background:linear-gradient(135deg,#78350f,#92400e); border-color:#f59e0b; }
.card.gym-shut  { background:linear-gradient(135deg,#7f1d1d,#991b1b); border-color:#ef4444; }
.card.shop-open { background:linear-gradient(135deg,#064e3b,#065f46); border-color:#10b981; }
.card.shop-shut { background:linear-gradient(135deg,#7f1d1d,#991b1b); border-color:#ef4444; }

.card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.card-title { font-family:'Space Grotesk',sans-serif; font-size:0.95em; font-weight:700; color:#e2e8f0; }
.card-icon { font-size:1.3em; }

/* BADGES */
.badge {
  display:block; padding:5px 10px; border-radius:20px;
  font-size:0.76em; font-weight:700; margin:3px 0;
  text-align:center; width:100%;
}
.b-green  { background:rgba(16,185,129,0.18); color:#34d399; border:1px solid rgba(16,185,129,0.28); }
.b-red    { background:rgba(239,68,68,0.18);  color:#f87171; border:1px solid rgba(239,68,68,0.28); }
.b-amber  { background:rgba(245,158,11,0.18); color:#fbbf24; border:1px solid rgba(245,158,11,0.28); }
.b-blue   { background:rgba(96,165,250,0.18); color:#93c5fd; border:1px solid rgba(96,165,250,0.28); }
.b-gray   { background:rgba(100,116,139,0.15);color:#64748b; border:1px solid rgba(100,116,139,0.2); }
.b-purple { background:rgba(167,139,250,0.15);color:#c4b5fd; border:1px solid rgba(167,139,250,0.25); }

/* COMMUNITY CONFIRMATION BADGE */
.comm-badge {
  display:flex; align-items:center; gap:4px;
  font-size:0.68em; font-weight:700; margin-top:4px;
  padding:3px 8px; border-radius:7px; width:fit-content;
}
.comm-confirmed { background:rgba(16,185,129,0.12); color:#34d399; border:1px solid rgba(16,185,129,0.22); }
.comm-partial   { background:rgba(245,158,11,0.12); color:#fbbf24; border:1px solid rgba(245,158,11,0.22); }
.comm-none      { background:rgba(100,116,139,0.1);  color:#475569; border:1px solid rgba(100,116,139,0.18); }

.menu-chip {
  font-size:0.7em; color:#94a3b8; margin-top:5px;
  background:rgba(255,255,255,0.04); padding:5px 8px;
  border-radius:8px; line-height:1.45;
}
.time-chip { font-size:0.65em; color:#444; margin-top:5px; text-align:center; }
.vote-chip { font-size:0.65em; color:#6366f1; margin-top:2px; text-align:center; }

/* IMMEDIATE UPDATES */
.imm-section {
  margin-top:14px; border:1px solid rgba(245,158,11,0.25);
  border-radius:18px; padding:14px; background:#130f00;
}
.imm-head {
  font-family:'Space Grotesk',sans-serif;
  font-size:0.95em; font-weight:800; color:#fbbf24;
  margin-bottom:10px; display:flex; align-items:center; gap:6px;
}
.imm-post {
  background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.2);
  border-radius:10px; padding:9px 11px; margin-bottom:8px;
  font-size:0.82em; color:#fde68a; line-height:1.45;
  animation:fadeUp 0.3s ease;
}
.imm-meta { font-size:0.65em; color:#78350f; margin-top:3px; }

/* HEARTBEAT */
.hb-section {
  margin-top:14px; border:1px solid rgba(255,77,109,0.25);
  border-radius:18px; padding:14px; background:#150009;
  position:relative; overflow:hidden;
}
.hb-section::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,#ff4d6d,#ff758c,#ff4d6d);
  background-size:200%; animation:shimmer 2s infinite;
}
@keyframes shimmer { 0%{background-position:0%} 100%{background-position:200%} }

.hb-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.hb-title {
  font-family:'Space Grotesk',sans-serif;
  font-size:0.95em; font-weight:800; color:#ff4d6d;
  display:flex; align-items:center; gap:6px;
}
.pulse-dot { width:8px; height:8px; border-radius:50%; background:#ff4d6d; animation:pulse 1.2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }

.hb-rules {
  background:rgba(255,77,109,0.07); border:1px solid rgba(255,77,109,0.18);
  border-radius:10px; padding:9px 11px; margin:8px 0;
  font-size:0.72em; color:#fca5a5; line-height:1.7;
}
.hb-rules strong { color:#ff4d6d; display:block; margin-bottom:3px; font-family:'Space Grotesk',sans-serif; }

.hb-input-row { display:flex; gap:8px; margin:8px 0 2px; }
.hb-input {
  flex:1; background:rgba(255,255,255,0.06); border:1px solid #2a1520;
  border-radius:10px; padding:9px 11px; color:white;
  font-size:0.82em; font-family:'DM Sans',sans-serif; outline:none;
}
.hb-input:focus { border-color:#ff4d6d; }
.hb-input::placeholder { color:#4a2530; }
.char-ct { font-size:0.65em; color:#4a2530; text-align:right; margin-bottom:6px; }
.char-ct.warn { color:#f59e0b; }
.btn-hb {
  background:#ff4d6d; color:white; border:none; border-radius:10px;
  padding:9px 13px; font-weight:700; font-size:0.82em; cursor:pointer;
  font-family:'Space Grotesk',sans-serif; white-space:nowrap;
}
.hb-feed { display:flex; flex-direction:column; gap:7px; margin-top:8px; max-height:280px; overflow-y:auto; }
.hb-post {
  background:rgba(255,77,109,0.07); border:1px solid rgba(255,77,109,0.18);
  border-radius:10px; padding:9px 11px;
  display:flex; gap:10px; align-items:center;
  animation:fadeUp 0.3s ease;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
.hb-post-text { font-size:0.82em; color:#fca5a5; flex:1; line-height:1.4; }
.hb-right { display:flex; flex-direction:column; align-items:center; gap:3px; min-width:42px; }
.upvote-btn {
  background:rgba(255,77,109,0.15); border:1px solid rgba(255,77,109,0.28);
  color:#ff4d6d; border-radius:8px; padding:4px 7px;
  font-size:0.75em; font-weight:700; cursor:pointer; width:100%; text-align:center;
}
.upvote-btn.voted { opacity:0.45; cursor:default; }
.timer-bar { height:2px; background:rgba(255,77,109,0.12); border-radius:2px; margin-top:5px; overflow:hidden; }
.timer-fill { height:100%; background:#ff4d6d; border-radius:2px; transition:width 1s linear; }
.hb-empty { text-align:center; color:#4a2530; font-size:0.78em; padding:16px; }

/* MODAL */
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.82); z-index:1000;
  align-items:flex-end; justify-content:center;
}
.modal.active { display:flex; }
.modal-box {
  background:#1a1a2e; border-radius:24px 24px 0 0;
  padding:22px 18px 36px; width:100%; max-width:500px;
  max-height:90vh; overflow-y:auto;
  border:1px solid #2a2a3e; border-bottom:none;
  animation:slideUp 0.28s ease;
}
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.modal-head {
  font-family:'Space Grotesk',sans-serif;
  font-size:1.2em; font-weight:800; color:#e2e8f0;
  margin-bottom:18px; display:flex; justify-content:space-between; align-items:center;
}
.modal-x {
  background:rgba(255,255,255,0.08); border:none; color:#666;
  width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:0.9em;
}
.btn-stack { display:flex; flex-direction:column; gap:9px; margin-top:10px; }
.mbtn {
  padding:13px; border:none; border-radius:11px;
  font-size:0.92em; font-weight:700; cursor:pointer;
  font-family:'Space Grotesk',sans-serif; transition:opacity 0.15s;
}
.mbtn:active { opacity:0.85; }
.mbtn.g { background:#10b981; color:white; }
.mbtn.r { background:#ef4444; color:white; }
.mbtn.a { background:#f59e0b; color:white; }
.mbtn.x { background:#1f2937; color:#6b7280; margin-top:6px; }
.m-input {
  width:100%; background:rgba(255,255,255,0.06); border:1px solid #2a2a3e;
  border-radius:10px; padding:11px; color:white;
  font-size:0.88em; font-family:'DM Sans',sans-serif; outline:none; margin-top:8px;
}
.m-input:focus { border-color:#a78bfa; }

/* REFRESH */
.refresh-btn {
  position:fixed; bottom:20px; right:20px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white; border:none; border-radius:30px;
  padding:11px 17px; font-size:0.82em; font-weight:700; cursor:pointer;
  box-shadow:0 4px 14px rgba(102,126,234,0.4); z-index:999;
  font-family:'Space Grotesk',sans-serif;
}

/* TOAST */
#toast {
  position:fixed; bottom:75px; left:50%; transform:translateX(-50%);
  background:#1e293b; color:#e2e8f0; padding:9px 18px; border-radius:12px;
  font-size:0.82em; z-index:9999; border:1px solid #334155;
  opacity:0; transition:opacity 0.3s; pointer-events:none;
  white-space:nowrap; max-width:90vw; text-align:center;
}

@media(max-width:480px){
  header h1{font-size:1.6em;}
  .grid{grid-template-columns:1fr 1fr;gap:9px;}
  .card{padding:12px;}
  .card-title{font-size:0.85em;}
}
</style>
</head>
<body>
<div id="toast"></div>

<div class="container">
  <header>
    <h1>ğŸ“ FundBASEU Tracker</h1>
    <p>Real-time campus status Â· by students, for students</p>
    <a href="https://sway.cloud.microsoft/CuEoSACHmG0wvSfR?ref=Link&loc=play" target="_blank" class="updates-link">ğŸ“¢ FundBASEU Updates â†’</a>
  </header>

  <!-- NOTIFICATION BANNER -->
  <div class="notif-banner" id="notif-banner">
    <div class="notif-banner-text">
      ğŸ”” Get meal reminders at 7:30am Â· 12:30pm Â· 5:00pm Â· 7:30pm
      <div class="notif-status" id="notif-status"></div>
    </div>
    <button class="notif-btn" id="notif-btn" onclick="requestNotifs()">Enable</button>
  </div>

  <!-- LIVE TICKER -->
  <div class="ticker-wrap">
    <div class="ticker-live"><div class="live-dot"></div>LIVE</div>
    <div class="ticker-viewport">
      <div class="ticker-track" id="ticker-track">
        <span class="tick-item"><b>Waiting for live activity...</b></span>
        <span class="tick-item"><b>Waiting for live activity...</b></span>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat-box">
      <span class="stat-num" id="liveCount">0</span>
      <span class="stat-lbl">ğŸ‘¥ Live Now</span>
    </div>
    <div class="stat-box">
      <span class="stat-num" id="totalVisitors">0</span>
      <span class="stat-lbl">ğŸ“Š Total Visitors</span>
    </div>
  </div>

  <div class="sec-label">Campus Status</div>

  <div class="grid">
    <!-- MESS -->
    <div class="card" id="mess-card" onclick="openModal('mess')">
      <div class="card-head">
        <span class="card-title">ğŸ½ï¸ Mess</span>
        <span class="card-icon">ğŸ›</span>
      </div>
      <span id="mess-avail" class="badge b-gray">Not Updated</span>
      <div id="mess-comm" class="comm-badge comm-none">â¬œ No votes yet</div>
      <span id="mess-meal" class="badge b-blue" style="margin-top:5px;"></span>
      <div id="mess-menu" class="menu-chip"></div>
      <div id="mess-votes" class="vote-chip"></div>
      <div id="mess-pending" class="vote-chip"></div>
      <div id="mess-time" class="time-chip"></div>
    </div>

    <!-- GYM -->
    <div class="card" id="gym-card" onclick="openModal('gym')">
      <div class="card-head">
        <span class="card-title">ğŸ‹ï¸ Gym</span>
        <span class="card-icon">ğŸ’ª</span>
      </div>
      <span id="gym-status" class="badge b-gray">Not Updated</span>
      <div id="gym-time" class="time-chip"></div>
    </div>

    <!-- NESCAFE -->
    <div class="card" id="nescafe-card" onclick="openModal('nescafe')">
      <div class="card-head">
        <span class="card-title">â˜• NescafÃ©</span>
        <span class="card-icon">ğŸ¥¤</span>
      </div>
      <span id="nescafe-status" class="badge b-gray">Not Updated</span>
      <div id="nescafe-comm" class="comm-badge comm-none">â¬œ No votes yet</div>
      <div id="nescafe-votes" class="vote-chip"></div>
      <div id="nescafe-pending" class="vote-chip"></div>
      <div id="nescafe-time" class="time-chip"></div>
    </div>

    <!-- NANDINI -->
    <div class="card" id="nandini-card" onclick="openModal('nandini')">
      <div class="card-head">
        <span class="card-title">ğŸ¥› Nandini</span>
        <span class="card-icon">ğŸ§ƒ</span>
      </div>
      <span id="nandini-status" class="badge b-gray">Not Updated</span>
      <div id="nandini-comm" class="comm-badge comm-none">â¬œ No votes yet</div>
      <div id="nandini-votes" class="vote-chip"></div>
      <div id="nandini-pending" class="vote-chip"></div>
      <div id="nandini-time" class="time-chip"></div>
    </div>

    <!-- BADMINTON -->
    <div class="card" id="badminton-card" onclick="openModal('badminton')">
      <div class="card-head">
        <span class="card-title">ğŸ¸ Badminton</span>
        <span class="card-icon">ğŸ¾</span>
      </div>
      <span id="badminton-status" class="badge b-gray">Not Updated</span>
      <div id="badminton-comm" class="comm-badge comm-none">â¬œ No votes yet</div>
      <div id="badminton-votes" class="vote-chip"></div>
      <div id="badminton-pending" class="vote-chip"></div>
      <div id="badminton-time" class="time-chip"></div>
    </div>

    <!-- SUGGESTIONS -->
    <div class="card" onclick="openModal('suggestions')">
      <div class="card-head">
        <span class="card-title">ğŸ’¡ Suggest</span>
        <span class="card-icon">ğŸ“</span>
      </div>
      <span class="badge b-purple">Fixes & Ideas</span>
      <div id="suggestions-count" class="time-chip"></div>
    </div>
  </div>

  <!-- IMMEDIATE UPDATES -->
  <div class="imm-section" id="imm-section" style="display:none;">
    <div class="imm-head">ğŸ”´ Immediate Updates <span style="font-size:0.6em;color:#78350f;font-weight:400;margin-left:4px;">crowd-verified</span></div>
    <div id="imm-posts"></div>
  </div>

  <!-- HEARTBEAT ZONE -->
  <div class="hb-section">
    <div class="hb-head">
      <div class="hb-title"><div class="pulse-dot"></div>Heartbeat Zone</div>
      <span style="font-size:0.68em;color:#7f3040;">anonymous Â· incubation</span>
    </div>
    <div class="hb-rules">
      <strong>ğŸ“‹ How Heartbeat works:</strong>
      â€¢ Post anonymously (max 80 chars)<br>
      â€¢ Reaches <strong style="color:#ff758c;">5 upvotes</strong> â†’ graduates to ğŸ”´ Immediate Updates<br>
      â€¢ Auto-deletes in <strong style="color:#ff758c;">10 minutes</strong> if under 5 upvotes<br>
      â€¢ Use for urgent signals, crowd alerts, campus sightings<br>
      â€¢ <span style="color:#994455;">One upvote per person per post</span>
    </div>
    <div class="hb-input-row">
      <input class="hb-input" id="hb-text" maxlength="80" placeholder="What's happening right now..." oninput="updateCharCount()">
      <button class="btn-hb" onclick="submitHeartbeat()">Post</button>
    </div>
    <div class="char-ct" id="char-ct">0 / 80</div>
    <div class="hb-feed" id="hb-feed">
      <div class="hb-empty">No active posts Â· be the first</div>
    </div>
  </div>
</div>

<button class="refresh-btn" onclick="location.reload()">ğŸ”„ Refresh</button>

<!-- MODAL -->
<div class="modal" id="modal" onclick="bgClose(event)">
  <div class="modal-box" id="modal-box"></div>
</div>

<script>
// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp({
  apiKey:"AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
  authDomain:"fundbaseu-tracker.firebaseapp.com",
  databaseURL:"https://fundbaseu-tracker-default-rtdb.firebaseio.com",
  projectId:"fundbaseu-tracker"
});
var db = firebase.database();

// presence
var presRef = db.ref("presence").push();
presRef.set(true); presRef.onDisconnect().remove();
db.ref("presence").on("value", s => { document.getElementById("liveCount").innerText = s.numChildren(); });

// total visitors
db.ref("totalVisitors").transaction(c => (c||0)+1);
db.ref("totalVisitors").on("value", s => { document.getElementById("totalVisitors").innerText = s.val()||0; });

// device id
var devId = localStorage.getItem("deviceId");
if (!devId) { devId='dev_'+Math.random().toString(36).substr(2,9); localStorage.setItem("deviceId",devId); }

const THRESH = 3, THRESH_BAD = 2, HB_VOTES = 5, HB_TTL = 600000; // 10 min

// â”€â”€ LIVE ACTIVITY TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref("activityLog").orderByChild("ts").limitToLast(20).on("value", snap => {
  const items = [];
  snap.forEach(c => items.push(c.val()));
  if (!items.length) return;
  // build duplicated items for seamless scroll
  const html = [...items].reverse().map(a =>
    `<span class="tick-item"><b>${tstamp(a.ts)}</b> ${esc(a.msg)}</span>`
  ).join('');
  const track = document.getElementById("ticker-track");
  track.innerHTML = html + html; // duplicate for loop
});

function logAct(msg) {
  db.ref("activityLog").push({ msg, ts: Date.now() });
  // prune to last 20
  db.ref("activityLog").orderByChild("ts").once("value", snap => {
    if (snap.numChildren() > 20) {
      let i=0, del=[];
      snap.forEach(c => { i++; if (i <= snap.numChildren()-20) del.push(c.key); });
      del.forEach(k => db.ref("activityLog/"+k).remove());
    }
  });
}

function tstamp(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
}

// â”€â”€ COMMUNITY BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCommunityBadge(place, voteCount, confirmed, thresh) {
  var el = document.getElementById(place+"-comm");
  if (!el) return;
  if (confirmed) {
    el.className = "comm-badge comm-confirmed";
    el.innerHTML = "âœ… Community Confirmed";
  } else if (voteCount >= 1) {
    el.className = "comm-badge comm-partial";
    el.innerHTML = "âš ï¸ Awaiting confirmation ("+voteCount+"/"+(thresh||THRESH)+")";
  } else {
    el.className = "comm-badge comm-none";
    el.innerHTML = "â¬œ No votes yet";
  }
}

// â”€â”€ PUSH NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var notifsScheduled = false;

function checkNotifSupport() {
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    document.getElementById("notif-banner").style.display = "none";
    scheduleNotifs();
  } else if (Notification.permission === "default") {
    document.getElementById("notif-banner").classList.add("show");
    document.getElementById("notif-status").textContent = "";
  }
}

function requestNotifs() {
  document.getElementById("notif-btn").textContent = "Requesting...";
  Notification.requestPermission().then(perm => {
    if (perm === "granted") {
      document.getElementById("notif-banner").classList.remove("show");
      scheduleNotifs();
      showToast("ğŸ”” Meal reminders enabled!");
    } else {
      document.getElementById("notif-status").textContent = "Permission denied. Enable in browser settings.";
      document.getElementById("notif-btn").textContent = "Enable";
    }
  });
}

function scheduleNotifs() {
  if (notifsScheduled) return;
  notifsScheduled = true;
  checkMealTime();
  setInterval(checkMealTime, 60000);
}

var lastNotifKey = "";
function checkMealTime() {
  if (Notification.permission !== "granted") return;
  var now = new Date();
  var h = now.getHours(), m = now.getMinutes();
  var key = h+":"+m;
  if (key === lastNotifKey) return;

  var meals = [
    { h:7,  m:30, title:"ğŸ³ Breakfast is served!", body:"Head to the mess â€” Breakfast is ready now!" },
    { h:12, m:30, title:"ğŸ½ï¸ Lunch time!",          body:"Mess is open for Lunch. Don't miss it!" },
    { h:17, m:0,  title:"â˜• Snacks time!",           body:"Snacks are being served at the mess!" },
    { h:19, m:30, title:"ğŸŒ™ Dinner is ready!",       body:"Dinner is now being served at the mess!" }
  ];
  meals.forEach(function(meal) {
    if (h === meal.h && m === meal.m) {
      new Notification(meal.title, { body: meal.body });
      lastNotifKey = key;
      logAct("ğŸ”” Meal notification sent: "+meal.title);
    }
  });
}

// â”€â”€ MESS MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var bf13 = {
  Monday:"Vada + Sambar + Chutney + Shavige",
  Tuesday:"Poha + Fruits + Chowchow Bath + Chutney",
  Wednesday:"Plain Dosa + Aloo + Chutney + Egg",
  Thursday:"Bisi Belle Bath + Bread Jam + Fruits",
  Friday:"Green Moong Dosa + Oats + Chutney",
  Saturday:"Tomato Bath + Puliyogare + Chutney",
  Sunday:"Masala Dosa + Aloo + Chutney"
};
var bf24 = {
  Monday:"Millets Khichdi + Vada + Sambar + Chutney + Idly",
  Tuesday:"Lemon Rice + Bread Jam + Fruits + Chutney",
  Wednesday:"Ragi Dosa + Dalia + Tomato Chutney + Egg",
  Thursday:"Onion Uthappam + Mangalore Bajji + Chutney",
  Friday:"Dal Khichdi + Dosa + Chutney",
  Saturday:"Pongal + Bread Jam + Fruits + Chutney",
  Sunday:"Set Dosa + Chutney"
};
var dayMenu = {
  Monday:   { Lunch:"Poori or Ragi Ball + Rice + Drumstick + Channa + Curd",                     Snacks:"Cutlet + Tea",      Dinner:"Dal Makhni + Rice + Dal + Veg" },
  Tuesday:  { Lunch:"Methi Chapathi + Rice + Dal + Veg Pulav + Curd + Pickle",                   Snacks:"Kabuli Husli + Tea", Dinner:"Soyabean + Rice + Radish Sambhar Dal + Chapati" },
  Wednesday:{ Lunch:"Chapathi or Ragi Balls + Rice + Dal + Paneer + Sprouts Sambhar + Pickle + Papad", Snacks:"Samosa + Tea",  Dinner:"Chapathi + Rice + Aloo + Rasam" },
  Thursday: { Lunch:"Paratha + Rajma + Jeera Rice + Pudina Rice + Curd + Pickle",                Snacks:"Vada Pav + Tea",    Dinner:"Chapathi + Rice + Egg Curry + Dal Palak + Salad" },
  Friday:   { Lunch:"Palak Chapati + Bhindi Chole + Dal + Chicken Biryani + Veg + Curd + Pickle + Papad", Snacks:"Bhel Puri + Tea", Dinner:"Chapathi + Rice + Dal + Veg" },
  Saturday: { Lunch:"Chapathi + Rice + Dal + Mix Veg Beans + Curd + Pickle",                     Snacks:"Masala Vada + Tea",  Dinner:"Chapathi + Rice + Dal + Veg + Salad" },
  Sunday:   { Lunch:"Mushroom Biryani or Paneer Biryani + Salad",                                Snacks:"Pav Bhaji + Tea",   Dinner:"Chapathi + Rice + Beetroot Palya + Veg" }
};
var DAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

function weekPat(date) {
  var fd = new Date(date.getFullYear(), date.getMonth(), 1);
  var wk = Math.ceil((date.getDate()+fd.getDay())/7);
  return (wk===1||wk===3) ? "w13" : "w24";
}

function nextMeal() {
  var now = new Date(), h = now.getHours(), di = now.getDay(), day = DAYS[di];
  if (h>=22) { var tm=new Date(now); tm.setDate(tm.getDate()+1); return {date:tm,day:DAYS[tm.getDay()],meal:"Breakfast"}; }
  if (h>=18)  return {date:now,day:day,meal:"Dinner"};
  if (h>=15)  return {date:now,day:day,meal:"Snacks"};
  if (h>=10)  return {date:now,day:day,meal:"Lunch"};
  return {date:now,day:day,meal:"Breakfast"};
}

function getMenu(date, day, meal) {
  if (meal==="Breakfast") return (weekPat(date)==="w13"?bf13:bf24)[day];
  return dayMenu[day][meal];
}

function updateMess() {
  var n = nextMeal();
  document.getElementById("mess-meal").textContent = "Next: "+n.meal;
  document.getElementById("mess-menu").textContent = getMenu(n.date,n.day,n.meal);
}
updateMess(); setInterval(updateMess, 60000);

// â”€â”€ HEARTBEAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCharCount() {
  var v = document.getElementById("hb-text").value, cc = document.getElementById("char-ct");
  cc.textContent = v.length+" / 80";
  cc.className = "char-ct"+(v.length>70?" warn":"")+(v.length>=80?" over":"");
}

function submitHeartbeat() {
  var text = document.getElementById("hb-text").value.trim();
  if (!text) return alert("Please write something");
  if (text.length>80) return alert("Max 80 characters");
  db.ref("heartbeat").push({ text:text, ts:Date.now(), upvotes:0, graduated:false });
  logAct("ğŸ’— Heartbeat posted: \""+text.substring(0,28)+(text.length>28?"â€¦":"")+"\"");
  document.getElementById("hb-text").value="";
  document.getElementById("char-ct").textContent="0 / 80";
}

function upvote(postId) {
  var k = "hbv_"+postId;
  if (localStorage.getItem(k)) return showToast("Already upvoted this post");
  localStorage.setItem(k,"1");
  db.ref("heartbeat/"+postId).transaction(function(d) {
    if (!d) return d;
    d.upvotes = (d.upvotes||0)+1;
    return d;
  }, function(err, ok, snap) {
    if (!snap) return;
    var d = snap.val();
    if (d && d.upvotes >= HB_VOTES && !d.graduated) {
      db.ref("immediateUpdates").push({ text:d.text, ts:Date.now() });
      db.ref("heartbeat/"+postId).update({ graduated:true });
      logAct("ğŸ”´ Heartbeat graduated to Immediate Updates!");
      setTimeout(function(){ db.ref("heartbeat/"+postId).remove(); }, 2500);
    }
  });
}

function cleanHeartbeats() {
  db.ref("heartbeat").once("value", function(snap) {
    var now = Date.now();
    snap.forEach(function(c) {
      var d = c.val();
      if (d && !d.graduated && (now-d.ts)>HB_TTL) db.ref("heartbeat/"+c.key).remove();
    });
  });
}
cleanHeartbeats(); setInterval(cleanHeartbeats, 30000);

db.ref("heartbeat").on("value", function(snap) {
  var feed = document.getElementById("hb-feed"), now = Date.now(), posts=[];
  snap.forEach(function(c){ var d=c.val(); if(d&&!d.graduated) posts.push({id:c.key,...d}); });
  posts.sort(function(a,b){ return b.ts-a.ts; });
  if (!posts.length) { feed.innerHTML='<div class="hb-empty">No active posts Â· be the first</div>'; return; }
  feed.innerHTML = posts.map(function(p) {
    var voted = localStorage.getItem("hbv_"+p.id);
    var rem = Math.max(0,HB_TTL-(now-p.ts));
    var pct = (rem/HB_TTL)*100;
    var mins = Math.ceil(rem/60000);
    var uv = p.upvotes||0;
    return '<div class="hb-post">'+
      '<div style="flex:1;">'+
        '<div class="hb-post-text">'+esc(p.text)+'</div>'+
        '<div style="font-size:0.62em;color:#7f3040;margin-top:3px;">â± '+mins+'min left Â· '+uv+'/5 upvotes</div>'+
        '<div class="timer-bar"><div class="timer-fill" style="width:'+pct+'%"></div></div>'+
      '</div>'+
      '<div class="hb-right">'+
        '<button class="upvote-btn'+(voted?' voted':'')+'" onclick="'+(voted?'showToast(\'Already upvoted!\')':'upvote(\''+p.id+'\')')+'">ğŸ‘ '+uv+'</button>'+
      '</div>'+
    '</div>';
  }).join('');
});

// Immediate updates
db.ref("immediateUpdates").orderByChild("ts").limitToLast(10).on("value", function(snap) {
  var sec = document.getElementById("imm-section"), con = document.getElementById("imm-posts");
  var posts=[];
  snap.forEach(function(c){ posts.push(c.val()); });
  posts.reverse();
  if (!posts.length) { sec.style.display="none"; return; }
  sec.style.display="block";
  con.innerHTML = posts.map(function(p){
    return '<div class="imm-post">'+esc(p.text)+'<div class="imm-meta">ğŸ”´ Crowd verified Â· '+ago(p.ts)+'</div></div>';
  }).join('');
});

// suggestions count
db.ref("suggestions").on("value", function(snap) {
  document.getElementById("suggestions-count").textContent = (snap.numChildren()||0)+" suggestion(s)";
});

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(place) {
  var h = '<div class="modal-head"><span>';
  if (place==='mess') {
    h+='ğŸ½ï¸ Mess Status</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="btn-stack">'+
      '<button class="mbtn g" onclick="doVote(\'mess\',\'Food Available\')">âœ… Food Available</button>'+
      '<button class="mbtn r" onclick="doVote(\'mess\',\'Food Not Available\')">âŒ Food Not Available</button>'+
      '<button class="mbtn x" onclick="closeModal()">Close</button></div>';
  } else if (place==='gym') {
    h+='ğŸ‹ï¸ Gym Status</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="btn-stack">'+
      '<button class="mbtn g" onclick="doGym(\'Open Â· Free\')">âœ… Open Â· Free (below 3)</button>'+
      '<button class="mbtn a" onclick="doGym(\'Open Â· Crowded\')">âš ï¸ Open Â· Crowded (3+)</button>'+
      '<button class="mbtn r" onclick="doGym(\'Closed\')">ğŸ”’ Closed</button>'+
      '<button class="mbtn x" onclick="closeModal()">Close</button></div>';
  } else if (place==='nescafe') {
    h+='â˜• NescafÃ©</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="btn-stack">'+
      '<button class="mbtn g" onclick="doVote(\'nescafe\',\'Open\')">âœ… Open</button>'+
      '<button class="mbtn r" onclick="doVote(\'nescafe\',\'Closed\')">ğŸ”’ Closed</button>'+
      '<button class="mbtn x" onclick="closeModal()">Close</button></div>';
  } else if (place==='nandini') {
    h+='ğŸ¥› Nandini</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="btn-stack">'+
      '<button class="mbtn g" onclick="doVote(\'nandini\',\'Open\')">âœ… Open</button>'+
      '<button class="mbtn r" onclick="doVote(\'nandini\',\'Closed\')">ğŸ”’ Closed</button>'+
      '<button class="mbtn x" onclick="closeModal()">Close</button></div>';
  } else if (place==='badminton') {
    h+='ğŸ¸ Badminton</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.82em;margin-bottom:10px;">How many courts are FREE right now?</p>';
    h+='<div class="btn-stack">'+
      '<button class="mbtn g" onclick="doBad(\'4 Free\')">ğŸŸ¢ All 4 Courts Free</button>'+
      '<button class="mbtn g" onclick="doBad(\'3 Free\')">ğŸŸ¢ 3 Courts Free</button>'+
      '<button class="mbtn a" onclick="doBad(\'2 Free\')">ğŸŸ¡ 2 Courts Free</button>'+
      '<button class="mbtn a" onclick="doBad(\'1 Free\')">ğŸŸ¡ 1 Court Free</button>'+
      '<button class="mbtn r" onclick="doBad(\'Full\')">ğŸ”´ All Courts Full</button>'+
      '<button class="mbtn x" onclick="closeModal()">Close</button></div>';
  } else if (place==='suggestions') {
    h+='ğŸ’¡ Suggestions</span><button class="modal-x" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:8px;">Share ideas or report bugs</p>';
    h+='<textarea class="m-input" id="sug-txt" rows="4" placeholder="Enter suggestion or bug..."></textarea>';
    h+='<div class="btn-stack"><button class="mbtn g" onclick="doSug()">Submit</button></div>';
    h+='<hr style="border:none;border-top:1px solid #2a2a3e;margin:14px 0;">';
    h+='<p style="color:#888;font-size:0.78em;margin-bottom:8px;">Recent:</p>';
    h+='<div id="sug-list" style="max-height:220px;overflow-y:auto;"></div>';
    h+='<button class="mbtn x" style="margin-top:10px;" onclick="closeModal()">Close</button>';
    setTimeout(function(){
      db.ref("suggestions").orderByChild("ts").limitToLast(10).once("value", function(snap){
        var a=[]; snap.forEach(function(c){ a.push(c.val()); }); a.reverse();
        var el=document.getElementById("sug-list"); if(!el) return;
        el.innerHTML=a.length?a.map(function(s){
          return '<div style="background:rgba(255,255,255,0.03);border:1px solid #2a2a3e;border-radius:9px;padding:9px;margin-bottom:7px;font-size:0.8em;color:#94a3b8;">'+
            esc(s.text||s.msg||'')+'<div style="font-size:0.7em;color:#444;margin-top:3px;">'+ago(s.ts||s.timestamp)+'</div></div>';
        }).join(''):'<p style="color:#444;text-align:center;">No suggestions yet</p>';
      });
    },100);
  }
  document.getElementById("modal-box").innerHTML=h;
  document.getElementById("modal").classList.add("active");
}
function closeModal(){ document.getElementById("modal").classList.remove("active"); }
function bgClose(e){ if(e.target===document.getElementById("modal")) closeModal(); }

// â”€â”€ VOTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doVote(place, value) {
  db.ref(place+"_deviceVotes/"+devId).once("value", function(snap) {
    if (snap.exists()) return showToast("Already voted for "+place);
    db.ref(place+"_votes/"+value).transaction(function(c){ return (c||0)+1; }, function(e,ok,sn) {
      if (!sn) return;
      var v=sn.val(), rem=THRESH-v;
      if (v>=THRESH) {
        db.ref(place).set({status:value,ts:Date.now()});
        db.ref(place+"_votes").remove();
        db.ref(place+"_pending").remove();
        db.ref(place+"_deviceVotes").remove();
        logAct("âœ… "+THRESH+" votes confirmed "+place+" â†’ "+value);
        showToast("âœ… Community confirmed!");
      } else {
        db.ref(place+"_pending").set({message:"Awaiting "+rem+" more confirmation(s)",voteCount:v});
        logAct("ğŸ—³ï¸ Vote on "+place+" ("+v+"/"+THRESH+"): "+value);
        showToast("Vote recorded! "+rem+" more needed.");
      }
    });
    db.ref(place+"_deviceVotes/"+devId).set(true);
  });
  closeModal();
}

function doGym(status) {
  db.ref("gym").set({status:status,ts:Date.now()});
  logAct("ğŸ‹ï¸ Gym updated â†’ "+status);
  showToast("Gym updated!");
  closeModal();
}

function doBad(value) {
  db.ref("badminton_deviceVotes/"+devId).once("value", function(snap) {
    if (snap.exists()) return showToast("Already voted for Badminton");
    db.ref("badminton_votes/"+value).transaction(function(c){ return (c||0)+1; }, function(e,ok,sn) {
      if (!sn) return;
      var v=sn.val(), rem=THRESH_BAD-v;
      if (v>=THRESH_BAD) {
        db.ref("badminton").set({status:value,ts:Date.now()});
        db.ref("badminton_votes").remove();
        db.ref("badminton_pending").remove();
        db.ref("badminton_deviceVotes").remove();
        logAct("âœ… Badminton confirmed â†’ "+value);
        showToast("âœ… Courts confirmed!");
      } else {
        db.ref("badminton_pending").set({message:"Awaiting "+rem+" more confirmation(s)",voteCount:v});
        logAct("ğŸ¸ Badminton vote ("+v+"/"+THRESH_BAD+"): "+value);
        showToast("Vote recorded! "+rem+" more needed.");
      }
    });
    db.ref("badminton_deviceVotes/"+devId).set(true);
  });
  closeModal();
}

function doSug() {
  var t = (document.getElementById("sug-txt")||{}).value||"";
  t=t.trim(); if(!t) return alert("Please enter something");
  db.ref("suggestions").push({text:t,ts:Date.now()});
  logAct("ğŸ’¡ New suggestion submitted");
  showToast("Thanks! Suggestion submitted.");
  closeModal();
}

// â”€â”€ FIREBASE LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// MESS
// track confirmed state so votes listener never overrides it
var messConfirmed = false;

db.ref("mess").on("value", function(snap) {
  var d=snap.val(), card=document.getElementById("mess-card"),
      av=document.getElementById("mess-avail"), tEl=document.getElementById("mess-time");
  if (!d) {
    messConfirmed = false;
    card.className="card"; av.className="badge b-gray"; av.textContent="Not Updated";
    setCommunityBadge("mess",0,false,THRESH); if(tEl) tEl.textContent=""; return;
  }
  // status exists means it was confirmed by votes reaching threshold
  messConfirmed = true;
  if (d.status==="Food Available") {
    card.className="card food-yes"; av.className="badge b-green"; av.textContent="âœ… Food Available";
  } else {
    card.className="card food-no"; av.className="badge b-red"; av.textContent="âŒ Food Not Available";
  }
  setCommunityBadge("mess", THRESH, true, THRESH);
  if(tEl) tEl.textContent=ago(d.ts||d.timestamp);
});
db.ref("mess_votes").on("value", function(snap) {
  var t=0; snap.forEach(function(c){t+=c.val();});
  var el=document.getElementById("mess-votes"); if(el) el.textContent=t>0?"Votes: "+t:"";
  // only update community badge from votes if not already confirmed
  if (!messConfirmed) setCommunityBadge("mess",t,false,THRESH);
});
db.ref("mess_pending").on("value", function(snap) {
  var el=document.getElementById("mess-pending");
  // only show pending message if not confirmed
  if(el) el.textContent=(!messConfirmed && snap.val()) ? snap.val().message : "";
});

// GYM
db.ref("gym").on("value", function(snap) {
  var d=snap.val(), card=document.getElementById("gym-card"),
      el=document.getElementById("gym-status"), tEl=document.getElementById("gym-time");
  if (!d) { card.className="card"; el.className="badge b-gray"; el.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  if (d.status==="Open Â· Free")    { card.className="card gym-free";  el.className="badge b-green"; el.textContent="âœ… Open Â· Free"; }
  else if (d.status==="Open Â· Crowded") { card.className="card gym-busy"; el.className="badge b-amber"; el.textContent="âš ï¸ Open Â· Crowded"; }
  else { card.className="card gym-shut"; el.className="badge b-red"; el.textContent="ğŸ”’ Closed"; }
  if(tEl) tEl.textContent=ago(d.ts||d.timestamp);
});

// NESCAFE
var nescafeConfirmed = false;
db.ref("nescafe").on("value", function(snap) {
  var d=snap.val(), card=document.getElementById("nescafe-card"),
      el=document.getElementById("nescafe-status"), tEl=document.getElementById("nescafe-time");
  if (!d) { nescafeConfirmed=false; card.className="card"; el.className="badge b-gray"; el.textContent="Not Updated"; setCommunityBadge("nescafe",0,false,THRESH); if(tEl) tEl.textContent=""; return; }
  nescafeConfirmed = true;
  if (d.status==="Open") { card.className="card shop-open"; el.className="badge b-green"; el.textContent="âœ… Open"; }
  else { card.className="card shop-shut"; el.className="badge b-red"; el.textContent="ğŸ”’ Closed"; }
  setCommunityBadge("nescafe",THRESH,true,THRESH);
  if(tEl) tEl.textContent=ago(d.ts||d.timestamp);
});
db.ref("nescafe_votes").on("value", function(snap) {
  var t=0; snap.forEach(function(c){t+=c.val();});
  var el=document.getElementById("nescafe-votes"); if(el) el.textContent=t>0?"Votes: "+t:"";
  if (!nescafeConfirmed) setCommunityBadge("nescafe",t,false,THRESH);
});
db.ref("nescafe_pending").on("value", function(snap) {
  var el=document.getElementById("nescafe-pending"); if(el) el.textContent=(!nescafeConfirmed&&snap.val())?snap.val().message:"";
});

// NANDINI
var nandiniConfirmed = false;
db.ref("nandini").on("value", function(snap) {
  var d=snap.val(), card=document.getElementById("nandini-card"),
      el=document.getElementById("nandini-status"), tEl=document.getElementById("nandini-time");
  if (!d) { nandiniConfirmed=false; card.className="card"; el.className="badge b-gray"; el.textContent="Not Updated"; setCommunityBadge("nandini",0,false,THRESH); if(tEl) tEl.textContent=""; return; }
  nandiniConfirmed = true;
  if (d.status==="Open") { card.className="card shop-open"; el.className="badge b-green"; el.textContent="âœ… Open"; }
  else { card.className="card shop-shut"; el.className="badge b-red"; el.textContent="ğŸ”’ Closed"; }
  setCommunityBadge("nandini",THRESH,true,THRESH);
  if(tEl) tEl.textContent=ago(d.ts||d.timestamp);
});
db.ref("nandini_votes").on("value", function(snap) {
  var t=0; snap.forEach(function(c){t+=c.val();});
  var el=document.getElementById("nandini-votes"); if(el) el.textContent=t>0?"Votes: "+t:"";
  if (!nandiniConfirmed) setCommunityBadge("nandini",t,false,THRESH);
});
db.ref("nandini_pending").on("value", function(snap) {
  var el=document.getElementById("nandini-pending"); if(el) el.textContent=(!nandiniConfirmed&&snap.val())?snap.val().message:"";
});

// BADMINTON
var badmintonConfirmed = false;
db.ref("badminton").on("value", function(snap) {
  var d=snap.val(), el=document.getElementById("badminton-status"), tEl=document.getElementById("badminton-time");
  if (!d||!el) { badmintonConfirmed=false; setCommunityBadge("badminton",0,false,THRESH_BAD); return; }
  badmintonConfirmed = true;
  var st=d.status||"Not Updated";
  var bc = st==="Full"?"b-red":st.includes("1")||st.includes("2")?"b-amber":"b-green";
  el.className="badge "+bc; el.textContent=st;
  setCommunityBadge("badminton",THRESH_BAD,true,THRESH_BAD);
  if(tEl) tEl.textContent=ago(d.ts||d.timestamp);
});
db.ref("badminton_votes").on("value", function(snap) {
  var t=0; snap.forEach(function(c){t+=c.val();});
  var el=document.getElementById("badminton-votes"); if(el) el.textContent=t>0?"Votes: "+t:"";
  if (!badmintonConfirmed) setCommunityBadge("badminton",t,false,THRESH_BAD);
});
db.ref("badminton_pending").on("value", function(snap) {
  var el=document.getElementById("badminton-pending"); if(el) el.textContent=(!badmintonConfirmed&&snap.val())?snap.val().message:"";
});

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ago(ts) {
  if (!ts) return "";
  var m=Math.floor((Date.now()-ts)/60000);
  if (m<1) return "just now";
  if (m===1) return "1 min ago";
  if (m<60) return m+" min ago";
  var h=Math.floor(m/60);
  if (h===1) return "1 hr ago";
  if (h<24) return h+" hrs ago";
  return Math.floor(h/24)+"d ago";
}
function esc(s) {
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function showToast(msg) {
  var t=document.getElementById("toast");
  t.textContent=msg; t.style.opacity="1";
  clearTimeout(t._tid);
  t._tid=setTimeout(function(){ t.style.opacity="0"; },2800);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkNotifSupport();
</script>
</body>
</html>
