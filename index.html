<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:#0f0f1a;min-height:100vh;padding:15px 15px 90px;color:#fff;}

header{text-align:center;margin-bottom:12px;padding-top:8px;}
header h1{font-family:'Space Grotesk',sans-serif;font-size:1.9em;font-weight:800;background:linear-gradient(135deg,#a78bfa,#60a5fa,#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-1px;margin-bottom:4px;}
header p{font-size:0.75em;color:#555;margin-bottom:6px;}
/* FundBASEU Updates â€” small, subtle */
.upd-link{display:inline-block;background:rgba(167,139,250,0.08);padding:4px 10px;border-radius:14px;color:#7c6faa;text-decoration:none;font-size:0.7em;font-weight:500;border:1px solid rgba(167,139,250,0.15);}
/* Campus Uno â€” prominent */
.cu-link{display:inline-block;margin-top:6px;background:rgba(96,165,250,0.15);padding:7px 18px;border-radius:20px;color:#60a5fa;text-decoration:none;font-size:0.88em;font-weight:700;border:1px solid rgba(96,165,250,0.3);letter-spacing:0.2px;}

#admin-bar{display:none;position:fixed;top:10px;right:10px;background:rgba(239,68,68,0.25);border:1px solid rgba(239,68,68,0.5);color:#f87171;padding:4px 12px;border-radius:20px;font-size:0.7em;font-weight:700;z-index:600;cursor:pointer;}
#admin-bar.show{display:block;}

.notif-banner{display:none;background:linear-gradient(135deg,#1e1b4b,#1e3a5f);border:1px solid #4f46e5;border-radius:12px;padding:10px 14px;margin:10px 0;font-size:0.8em;color:#a5b4fc;align-items:center;gap:10px;flex-wrap:wrap;}
.notif-banner.show{display:flex;}
.notif-btn{background:#4f46e5;border:none;color:white;padding:6px 14px;border-radius:8px;font-size:0.82em;font-weight:700;cursor:pointer;font-family:'Space Grotesk',sans-serif;}

.meal-banner{background:#12121f;border:1px solid #1e1e35;border-radius:14px;padding:14px 18px;margin:10px 0;display:flex;align-items:center;gap:16px;overflow:hidden;flex-wrap:wrap;}
.meal-left{display:flex;flex-direction:column;min-width:100px;flex-shrink:0;}
.meal-label{font-family:'Space Grotesk',sans-serif;font-size:0.62em;font-weight:800;color:#6366f1;letter-spacing:1.8px;text-transform:uppercase;}
.meal-name{font-family:'Space Grotesk',sans-serif;font-size:1.25em;font-weight:800;color:#e2e8f0;margin-top:2px;}
.meal-menu{flex:1;font-size:0.85em;color:#94a3b8;line-height:1.6;font-weight:500;}

.stats-bar{display:flex;justify-content:center;gap:20px;margin:6px 0 10px;flex-wrap:wrap;opacity:0.45;}
.s-box{text-align:center;}
.s-num{font-family:'Space Grotesk',sans-serif;font-size:1.1em;font-weight:700;display:block;color:#94a3b8;}
.s-lbl{font-size:0.62em;color:#475569;}

.sec-lbl{font-family:'Space Grotesk',sans-serif;font-size:0.65em;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#444;margin:14px 0 8px 2px;}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(148px,1fr));gap:10px;margin-bottom:6px;}

/* â”€â”€ CARD: base state + transition â”€â”€ */
.card{
  border-radius:16px;padding:14px;
  cursor:pointer;border:1px solid #242438;
  transition:background 0.4s ease, border-color 0.4s ease, transform 0.2s, box-shadow 0.2s;
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,0.4);
  /* default dark */
  background:#1a1a2e;
}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.5);}
.card:active{transform:scale(0.97);}

/* â”€â”€ CARD COLOR STATES (applied via JS .style directly) â”€â”€ */
/* These are templates used by JS â€” no class switching needed */

/* FULL-WIDTH STATUS TILES */
.fw-grid{display:flex;flex-direction:column;gap:9px;margin-bottom:10px;}
.fw-card{
  border-radius:16px;padding:15px 18px;
  cursor:pointer;border:2px solid #242438;
  transition:background 0.35s ease,border-color 0.35s ease,box-shadow 0.35s ease,transform 0.15s;
  -webkit-tap-highlight-color:transparent;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:#1a1a2e;
  box-shadow:0 4px 18px rgba(0,0,0,0.4);
}
.fw-card:active{transform:scale(0.98);}
.fw-left{display:flex;align-items:center;gap:11px;flex-shrink:0;}
.fw-icon{font-size:1.55em;line-height:1;}
.fw-title{font-family:'Space Grotesk',sans-serif;font-size:1.05em;font-weight:800;color:#e2e8f0;}
.fw-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.fw-status{font-family:'Space Grotesk',sans-serif;font-size:0.92em;font-weight:700;color:#94a3b8;}
.fw-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:flex-end;}

.ct{font-family:'Space Grotesk',sans-serif;font-size:0.92em;font-weight:700;color:#e2e8f0;}
.ci{font-size:1.3em;}

/* Status badge inside card */
.sbdg{display:block;padding:5px 10px;border-radius:20px;font-size:0.76em;font-weight:700;margin:3px 0;text-align:center;width:100%;transition:background 0.3s,color 0.3s,border-color 0.3s;}

/* Explicit colour variants â€” set via JS className */
.s-green{background:rgba(16,185,129,0.25);color:#6ee7b7;border:1px solid rgba(16,185,129,0.4);}
.s-red{background:rgba(239,68,68,0.25);color:#fca5a5;border:1px solid rgba(239,68,68,0.4);}
.s-amber{background:rgba(245,158,11,0.25);color:#fde68a;border:1px solid rgba(245,158,11,0.4);}
.s-blue{background:rgba(96,165,250,0.25);color:#bfdbfe;border:1px solid rgba(96,165,250,0.4);}
.s-gray{background:rgba(100,116,139,0.2);color:#94a3b8;border:1px solid rgba(100,116,139,0.3);}
.s-purple{background:rgba(167,139,250,0.2);color:#ddd6fe;border:1px solid rgba(167,139,250,0.3);}
.s-teal{background:rgba(20,184,166,0.25);color:#99f6e4;border:1px solid rgba(20,184,166,0.4);}

/* Community confirmation badge */
.cb{display:inline-flex;align-items:center;gap:4px;font-size:0.67em;font-weight:700;margin-top:5px;padding:3px 9px;border-radius:7px;}
.cb-ok{background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);}
.cb-wait{background:rgba(245,158,11,0.15);color:#fbbf24;border:1px solid rgba(245,158,11,0.3);}
.cb-none{background:rgba(100,116,139,0.12);color:#4b5563;border:1px solid rgba(100,116,139,0.2);}

.mc{font-size:0.7em;color:#94a3b8;margin-top:5px;background:rgba(255,255,255,0.04);padding:5px 8px;border-radius:8px;line-height:1.45;}
.tc{font-size:0.65em;color:#444;margin-top:5px;text-align:center;}
.vc{font-size:0.65em;color:#6366f1;margin-top:2px;text-align:center;}

/* ANNOUNCEMENTS */
.ann-wrap{margin-top:10px;border:1px solid rgba(100,116,139,0.18);border-radius:14px;padding:11px 13px;background:rgba(15,10,26,0.6);}
.ann-title{font-family:'Space Grotesk',sans-serif;font-size:0.75em;font-weight:700;color:#6b7280;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;text-transform:uppercase;letter-spacing:1px;}
.ann-card{background:rgba(255,255,255,0.03);border:1px solid rgba(100,116,139,0.15);border-radius:8px;padding:8px 10px;margin-bottom:6px;animation:fu .3s ease;}
.ann-txt{font-size:0.82em;color:#cbd5e1;line-height:1.45;}
.ann-meta{display:flex;align-items:center;gap:8px;margin-top:4px;flex-wrap:wrap;}
.ann-tag{font-size:0.62em;font-weight:700;padding:2px 7px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px;}
.tag-mess{background:rgba(245,158,11,0.15);color:#d97706;}
.tag-event{background:rgba(96,165,250,0.15);color:#60a5fa;}
.tag-academic{background:rgba(16,185,129,0.15);color:#10b981;}
.tag-general{background:rgba(100,116,139,0.15);color:#64748b;}
.ann-ts{font-size:0.62em;color:#3f4a58;}
.ann-del{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.15);color:#f87171;padding:2px 7px;border-radius:5px;font-size:0.62em;cursor:pointer;font-weight:700;}
.ann-empty{text-align:center;color:#374151;font-size:0.75em;padding:10px;}
.ann-post-btn{display:block;margin:8px auto 0;background:transparent;border:1px solid rgba(100,116,139,0.2);color:#4b5563;padding:4px 12px;border-radius:7px;font-size:0.68em;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;}

/* IMMEDIATE UPDATES */
.imm-wrap{margin-top:14px;border:1px solid rgba(245,158,11,0.22);border-radius:18px;padding:14px;background:#130f00;}
.imm-title{font-family:'Space Grotesk',sans-serif;font-size:0.95em;font-weight:800;color:#fbbf24;margin-bottom:10px;}
.imm-card{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:9px 11px;margin-bottom:8px;font-size:0.82em;color:#fde68a;line-height:1.45;animation:fu .3s ease;}
.imm-meta{font-size:0.65em;color:#78350f;margin-top:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.dv-btn{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.2);color:#f87171;padding:2px 8px;border-radius:6px;font-size:0.7em;cursor:pointer;font-weight:700;}

/* HEARTBEAT */
.hb-wrap{margin-top:14px;border:1px solid rgba(255,77,109,0.22);border-radius:18px;padding:14px;background:#150009;position:relative;overflow:hidden;}
.hb-wrap::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#ff4d6d,#ff758c,#ff4d6d);background-size:200%;animation:shimmer 2s infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.hb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.hb-tit{font-family:'Space Grotesk',sans-serif;font-size:0.95em;font-weight:800;color:#ff4d6d;display:flex;align-items:center;gap:6px;}
.pdot{width:8px;height:8px;border-radius:50%;background:#ff4d6d;animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}
.hb-rules{background:rgba(255,77,109,0.07);border:1px solid rgba(255,77,109,0.18);border-radius:10px;padding:9px 11px;margin:8px 0;font-size:0.72em;color:#fca5a5;line-height:1.7;}
.hb-rules strong{color:#ff4d6d;display:block;margin-bottom:3px;font-family:'Space Grotesk',sans-serif;}
.hb-row{display:flex;gap:8px;margin:8px 0 2px;}
.hb-in{flex:1;background:rgba(255,255,255,0.06);border:1px solid #2a1520;border-radius:10px;padding:9px 11px;color:white;font-size:0.82em;font-family:'DM Sans',sans-serif;outline:none;}
.hb-in:focus{border-color:#ff4d6d;}
.hb-in::placeholder{color:#4a2530;}
.chct{font-size:0.65em;color:#4a2530;text-align:right;margin-bottom:6px;}
.chct.warn{color:#f59e0b;}
.btn-hb{background:#ff4d6d;color:white;border:none;border-radius:10px;padding:9px 13px;font-weight:700;font-size:0.82em;cursor:pointer;font-family:'Space Grotesk',sans-serif;white-space:nowrap;}
.hb-feed{display:flex;flex-direction:column;gap:7px;margin-top:8px;max-height:280px;overflow-y:auto;}
.hb-card{background:rgba(255,77,109,0.07);border:1px solid rgba(255,77,109,0.18);border-radius:10px;padding:9px 11px;display:flex;gap:10px;align-items:center;animation:fu .3s ease;}
@keyframes fu{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.hb-txt{font-size:0.82em;color:#fca5a5;flex:1;line-height:1.4;}
.hb-r{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:42px;}
.uv-btn{background:rgba(255,77,109,0.15);border:1px solid rgba(255,77,109,0.28);color:#ff4d6d;border-radius:8px;padding:4px 7px;font-size:0.75em;font-weight:700;cursor:pointer;width:100%;text-align:center;}
.uv-btn.voted{opacity:0.45;cursor:default;}
.tbar{height:2px;background:rgba(255,77,109,0.12);border-radius:2px;margin-top:5px;overflow:hidden;}
.tfil{height:100%;background:#ff4d6d;border-radius:2px;transition:width 1s linear;}
.hb-empty{text-align:center;color:#4a2530;font-size:0.78em;padding:16px;}

/* MODAL */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:flex-end;justify-content:center;}
.modal.active{display:flex;}
.mbox{background:#1a1a2e;border-radius:24px 24px 0 0;padding:22px 18px 36px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid #2a2a3e;border-bottom:none;animation:su .28s ease;}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mh{font-family:'Space Grotesk',sans-serif;font-size:1.2em;font-weight:800;color:#e2e8f0;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.mx{background:rgba(255,255,255,0.08);border:none;color:#666;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:0.9em;}
.bst{display:flex;flex-direction:column;gap:9px;margin-top:10px;}
.mb{padding:13px;border:none;border-radius:11px;font-size:0.92em;font-weight:700;cursor:pointer;font-family:'Space Grotesk',sans-serif;}
.mb:active{opacity:0.85;}
.mb.g{background:#10b981;color:white;}
.mb.r{background:#ef4444;color:white;}
.mb.a{background:#f59e0b;color:white;}
.mb.t{background:#0d9488;color:white;}
.mb.x{background:#1f2937;color:#6b7280;margin-top:6px;}
.mi{width:100%;background:rgba(255,255,255,0.06);border:1px solid #2a2a3e;border-radius:10px;padding:11px;color:white;font-size:0.88em;font-family:'DM Sans',sans-serif;outline:none;margin-top:8px;}
.mi:focus{border-color:#a78bfa;}
.msel{width:100%;background:#1a1a2e;border:1px solid #2a2a3e;border-radius:10px;padding:11px;color:white;font-size:0.88em;font-family:'DM Sans',sans-serif;outline:none;margin-top:8px;}
.adm-sec{margin-top:14px;padding-top:12px;border-top:1px solid rgba(239,68,68,0.2);}
.adm-lbl{font-size:0.72em;color:#ef4444;font-weight:700;margin-bottom:8px;}
.adm-row{display:flex;flex-wrap:wrap;gap:8px;}
.adm-btn{flex:1;min-width:80px;padding:9px 8px;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);color:#fca5a5;border-radius:9px;font-size:0.8em;font-weight:700;cursor:pointer;font-family:'Space Grotesk',sans-serif;text-align:center;}

.ref-btn{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:30px;padding:11px 17px;font-size:0.82em;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(102,126,234,0.4);z-index:999;font-family:'Space Grotesk',sans-serif;}

#toast{position:fixed;bottom:75px;left:50%;transform:translateX(-50%);background:#1e293b;color:#e2e8f0;padding:9px 18px;border-radius:12px;font-size:0.82em;z-index:9999;border:1px solid #334155;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap;max-width:92vw;text-align:center;}

@media(max-width:480px){
  header h1{font-size:1.55em;}
  .grid{grid-template-columns:1fr 1fr;gap:9px;}
  .card{padding:11px;}
  .ct{font-size:0.82em;}
}
</style>
</head>
<body>
<div id="toast"></div>
<div id="admin-bar" onclick="adminLogout()">ğŸ” Admin Â· tap to exit</div>

<div class="container">
  <header>
    <h1>ğŸ“ FundBASEU Tracker</h1>
    <p>Real-time campus status Â· by students, for students</p>
    <a href="https://sway.cloud.microsoft/CuEoSACHmG0wvSfR?ref=Link&loc=play" target="_blank" class="upd-link">ğŸ“¢ FundBASEU Updates â†’</a>
  </header>

  <div class="notif-banner" id="notif-banner">
    <div style="flex:1;">ğŸ”” Get meal reminders at 7:30am Â· 12:30pm Â· 5pm Â· 7:30pm
    <div id="notif-st" style="font-size:0.72em;color:#818cf8;margin-top:3px;"></div></div>
    <button class="notif-btn" id="notif-btn" onclick="reqNotif()">Enable</button>
  </div>

  <!-- ANNOUNCEMENTS (top) -->
  <div class="ann-wrap" style="margin-top:10px;margin-bottom:4px;">
    <div class="ann-title">ğŸ“¢ Announcements <span style="font-size:0.6em;color:#6b4fa0;font-weight:400;">12hr expiry</span></div>
    <div id="ann-list"><div class="ann-empty">No announcements yet</div></div>
    <button class="ann-post-btn" onclick="openAnnPost()">+ Post Announcement (admin only)</button>
  </div>

  <!-- NEXT MEAL BANNER -->
  <div class="meal-banner" id="meal-banner">
    <div class="meal-left">
      <span class="meal-label" id="meal-label-top">Next Meal</span>
      <span class="meal-name" id="meal-name-top">â€”</span>
    </div>
    <div class="meal-menu" id="meal-menu-top">Loading...</div>
  </div>

  <div class="stats-bar">
    <div class="s-box"><span class="s-num" id="liveCount">0</span><span class="s-lbl">ğŸ‘¥ Live Now</span></div>
    <div class="s-box"><span class="s-num" id="totalVis">0</span><span class="s-lbl">ğŸ“Š Visitors</span></div>
  </div>

  <div class="sec-lbl">Campus Status</div>

  <!-- FULL-WIDTH STATUS TILES -->
  <div class="fw-grid">

    <div class="fw-card" id="mess-card" onclick="openModal('mess')">
      <div class="fw-left">
        <span class="fw-icon">ğŸ½ï¸</span>
        <span class="fw-title">Mess</span>
      </div>
      <div class="fw-right">
        <span class="fw-status" id="mess-avail">Not Updated</span>
        <div class="fw-meta">
          <span class="cb cb-none" id="mess-cb">â¬œ No votes yet</span>
          <span class="vc" id="mess-vc"></span>
        </div>
        <span class="tc" id="mess-ts"></span>
      </div>
    </div>

    <div class="fw-card" id="nandini-card" onclick="openModal('nandini')">
      <div class="fw-left">
        <span class="fw-icon">ğŸ¥›</span>
        <span class="fw-title">Nandini</span>
      </div>
      <div class="fw-right">
        <span class="fw-status" id="nandini-avail">Not Updated</span>
        <div class="fw-meta">
          <span class="cb cb-none" id="nandini-cb">â¬œ No votes yet</span>
          <span class="vc" id="nandini-vc"></span>
        </div>
        <span class="tc" id="nandini-ts"></span>
      </div>
    </div>

    <div class="fw-card" id="nescafe-card" onclick="openModal('nescafe')">
      <div class="fw-left">
        <span class="fw-icon">â˜•</span>
        <span class="fw-title">NescafÃ©</span>
      </div>
      <div class="fw-right">
        <span class="fw-status" id="nescafe-avail">Not Updated</span>
        <div class="fw-meta">
          <span class="cb cb-none" id="nescafe-cb">â¬œ No votes yet</span>
          <span class="vc" id="nescafe-vc"></span>
        </div>
        <span class="tc" id="nescafe-ts"></span>
      </div>
    </div>

    <div class="fw-card" id="gym-card" onclick="openModal('gym')">
      <div class="fw-left">
        <span class="fw-icon">ğŸ‹ï¸</span>
        <span class="fw-title">Gym</span>
      </div>
      <div class="fw-right">
        <span class="fw-status" id="gym-avail">Not Updated</span>
        <div class="fw-meta">
          <span class="cb cb-none" id="gym-cb">â¬œ No votes yet</span>
          <span class="vc" id="gym-vc"></span>
        </div>
        <span class="tc" id="gym-ts"></span>
      </div>
    </div>

  </div>

  <!-- SMALL TILES GRID -->
  <div class="grid">

    <div class="card" id="bad-card" onclick="openModal('bad')">
      <div class="ch"><span class="ct">ğŸ¸ Badminton</span><span class="ci">ğŸ¾</span></div>
      <span class="sbdg s-gray" id="bad-avail">Not Updated</span>
      <div class="cb cb-none" id="bad-cb">â¬œ No votes yet</div>
      <div class="vc" id="bad-vc"></div>
      <div class="vc" id="bad-pend"></div>
      <div class="tc" id="bad-ts"></div>
    </div>

    <div class="card" id="doc-card" onclick="openModal('doc')">
      <div class="ch"><span class="ct">ğŸ¥ Doctor</span><span class="ci">ğŸ’Š</span></div>
      <span class="sbdg s-gray" id="doc-avail">Not Updated</span>
      <div class="cb cb-none" id="doc-cb">â¬œ No votes yet</div>
      <div class="vc" id="doc-vc"></div>
      <div class="vc" id="doc-pend"></div>
      <div class="tc" id="doc-ts"></div>
    </div>

    <div class="card" id="doc-card" onclick="openModal('nescafe')">
      <div class="ch"><span class="ct">ğŸ¥ Nescafe</span><span class="ci">ğŸ’Š</span></div>
      <span class="sbdg s-gray" id="nescafe-avail">Not Updated</span>
      <div class="cb cb-none" id="nescafe-cb">â¬œ No votes yet</div>
      <div class="vc" id="nescafe-vc"></div>
      <div class="vc" id="nescafe-pend"></div>
      <div class="tc" id="nescafe-ts"></div>
    </div>

    <div class="card" id="doc-card" onclick="openModal('doc')">
      <div class="ch"><span class="ct">ğŸ¥ Doctor</span><span class="ci">ğŸ’Š</span></div>
      <span class="sbdg s-gray" id="doc-avail">Not Updated</span>
      <div class="cb cb-none" id="doc-cb">â¬œ No votes yet</div>
      <div class="vc" id="doc-vc"></div>
      <div class="vc" id="doc-pend"></div>
      <div class="tc" id="doc-ts"></div>
    </div>

    <div class="card" onclick="openFacultyLocator()">
      <div class="ch"><span class="ct">ğŸ‘¤ Faculty</span><span class="ci">ğŸ“</span></div>
      <span class="sbdg s-purple">Faculty Locator</span>
      <div class="tc" id="fac-summary" style="margin-top:4px;"></div>
    </div>

    <div class="card" onclick="openModal('sug')">
      <div class="ch"><span class="ct">ğŸ’¡ Suggest</span><span class="ci">ğŸ“</span></div>
      <span class="sbdg s-purple">Fixes & Ideas</span>
      <div class="tc" id="sug-count"></div>
    </div>

  </div>

  <!-- IMMEDIATE UPDATES -->
  <div class="imm-wrap" id="imm-wrap" style="display:none;">
    <div class="imm-title">ğŸ”´ Immediate Updates <span style="font-size:0.6em;color:#78350f;font-weight:400;margin-left:4px;">5 downvotes = removed</span></div>
    <div id="imm-list"></div>
  </div>

  <!-- HEARTBEAT ZONE -->
  <div class="hb-wrap">
    <div class="hb-head">
      <div class="hb-tit"><div class="pdot"></div>Heartbeat Zone</div>
      <span style="font-size:0.68em;color:#7f3040;">anonymous Â· incubation</span>
    </div>
    <div class="hb-rules">
      <strong>ğŸ“‹ How Heartbeat works:</strong>
      â€¢ Post anonymously â€” max 80 characters<br>
      â€¢ <strong style="color:#ff758c;">5 upvotes</strong> â†’ graduates to ğŸ”´ Immediate Updates<br>
      â€¢ <strong style="color:#ff758c;">Auto-deletes in 10 min</strong> if under 5 upvotes<br>
      â€¢ Use for urgent signals, crowd alerts, campus sightings
    </div>
    <div class="hb-row">
      <input class="hb-in" id="hb-txt" maxlength="80" placeholder="What's happening right now..." oninput="updateCC()">
      <button class="btn-hb" onclick="postHB()">Post</button>
    </div>
    <div class="chct" id="chct">0 / 80</div>
    <div class="hb-feed" id="hb-feed"><div class="hb-empty">No active posts Â· be the first</div></div>
  </div>
</div>

<button class="ref-btn" onclick="location.reload()">ğŸ”„ Refresh</button>

<div class="modal" id="modal" onclick="bgClose(event)">
  <div class="mbox" id="mbox"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var ADMIN_PASS = "fundbaseu2024"; // â† change this
var T_MESS=3, T_GYM=1, T_NESCAFE=3, T_NANDINI=3, T_BAD=2, T_DOC=2, T_PROF=2;
var HB_VOTES=5, HB_TTL=600000, IMM_DV=5, ANN_EXP=43200000;

// Faculty list â€” 12 professors
var FACULTY = [
  "Dr.Bidur",
  "Dr.Megha",
  "Dr.Irfan",
  "Dr.Shameer",
  "Dr.Nageshwar",
  "Dr.Ishfaq",
  "Dr.Muzaffar",
  "Dr.Kasturi",
  "Dr.Moushmi",
  "Dr.Sushmita",
  "Dean",
  "Dr.Asha"
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey:"AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
  authDomain:"fundbaseu-tracker.firebaseapp.com",
  databaseURL:"https://fundbaseu-tracker-default-rtdb.firebaseio.com",
  projectId:"fundbaseu-tracker"
});
var db = firebase.database();

var pr = db.ref("presence").push();
pr.set(true); pr.onDisconnect().remove();
db.ref("presence").on("value",function(s){ setText("liveCount",s.numChildren()); });
db.ref("totalVisitors").transaction(function(c){ return (c||0)+1; });
db.ref("totalVisitors").on("value",function(s){ setText("totalVis",s.val()||0); });

var devId = localStorage.getItem("did") || (function(){ var id="d_"+Math.random().toString(36).slice(2,11); localStorage.setItem("did",id); return id; })();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ge(id){ return document.getElementById(id); }
function setText(id,v){ var e=ge(id); if(e) e.textContent=v; }
function ago(t){ if(!t) return ""; var m=Math.floor((Date.now()-t)/60000); if(m<1) return "just now"; if(m===1) return "1m ago"; if(m<60) return m+"m ago"; var h=Math.floor(m/60); if(h<24) return h+"hr ago"; return Math.floor(h/24)+"d ago"; }
function ts(t){ if(!t) return ""; var d=new Date(t); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
function esc(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function toast(msg){ var t=ge("toast"); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._x); t._x=setTimeout(function(){ t.style.opacity="0"; },2800); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD COLOR â€” applied directly via style + border
//  This bypasses ALL CSS specificity issues
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CARD_COLORS = {
  green:  { bg:"linear-gradient(135deg,#052e16,#064e3b)", border:"#10b981", glow:"rgba(16,185,129,0.3)" },
  red:    { bg:"linear-gradient(135deg,#450a0a,#7f1d1d)", border:"#ef4444", glow:"rgba(239,68,68,0.3)" },
  amber:  { bg:"linear-gradient(135deg,#451a03,#78350f)", border:"#f59e0b", glow:"rgba(245,158,11,0.3)" },
  teal:   { bg:"linear-gradient(135deg,#042f2e,#134e4a)", border:"#14b8a6", glow:"rgba(20,184,166,0.3)" },
  blue:   { bg:"linear-gradient(135deg,#0c1a4a,#1e3a8a)", border:"#3b82f6", glow:"rgba(59,130,246,0.3)" },
  purple: { bg:"linear-gradient(135deg,#1e1b4b,#312e81)", border:"#818cf8", glow:"rgba(129,140,248,0.3)" },
  dark:   { bg:"#1a1a2e",                                border:"#242438", glow:"none" }
};

function paintCard(id, colorKey){
  var card = ge(id);
  if (!card) return;
  var c = CARD_COLORS[colorKey] || CARD_COLORS.dark;
  card.style.background    = c.bg;
  card.style.borderColor   = c.border;
  card.style.boxShadow     = "0 4px 20px "+c.glow;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMMUNITY BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setCB(id, votes, done, thresh){
  var e = ge(id+"-cb"); if(!e) return;
  if(done){ e.className="cb cb-ok"; e.textContent="âœ… Community Confirmed"; }
  else if(votes>=1){ e.className="cb cb-wait"; e.textContent="âš ï¸ Awaiting ("+votes+"/"+(thresh||3)+")"; }
  else{ e.className="cb cb-none"; e.textContent="â¬œ No votes yet"; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var isAdmin = sessionStorage.getItem("adm")==="1";
if(isAdmin) ge("admin-bar").classList.add("show");

function checkAdmin(){
  if(isAdmin) return true;
  var pw=prompt("ğŸ” Admin password:");
  if(pw===ADMIN_PASS){ isAdmin=true; sessionStorage.setItem("adm","1"); ge("admin-bar").classList.add("show"); toast("ğŸ” Admin access granted"); return true; }
  toast("âŒ Wrong password"); return false;
}
function adminLogout(){ if(!confirm("Exit admin?")) return; isAdmin=false; sessionStorage.removeItem("adm"); ge("admin-bar").classList.remove("show"); toast("Logged out"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var nOn=false, lnk="";
function initNotif(){
  if(!("Notification" in window)) return;
  if(Notification.permission==="granted"){ ge("notif-banner").style.display="none"; startNotif(); }
  else if(Notification.permission==="default") ge("notif-banner").classList.add("show");
}
function reqNotif(){
  ge("notif-btn").textContent="...";
  Notification.requestPermission().then(function(p){
    if(p==="granted"){ ge("notif-banner").classList.remove("show"); startNotif(); toast("ğŸ”” Meal reminders on!"); }
    else{ ge("notif-st").textContent="Denied â€” enable in browser settings"; ge("notif-btn").textContent="Enable"; }
  });
}
function startNotif(){ if(nOn) return; nOn=true; chkMeal(); setInterval(chkMeal,60000); }
function chkMeal(){
  if(Notification.permission!=="granted") return;
  var n=new Date(),h=n.getHours(),m=n.getMinutes(),k=h+":"+m;
  if(k===lnk) return;
  [{h:7,m:30,t:"ğŸ³ Breakfast is served!",b:"Head to mess!"},{h:12,m:30,t:"ğŸ½ï¸ Lunch time!",b:"Mess open for Lunch!"},{h:17,m:0,t:"â˜• Snacks time!",b:"Snacks at mess!"},{h:19,m:30,t:"ğŸŒ™ Dinner ready!",b:"Dinner served at mess!"}]
  .forEach(function(x){ if(h===x.h&&m===x.m){ new Notification(x.t,{body:x.b}); lnk=k; } });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKER (removed) â€” activity log still kept for internal use
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
db.ref("actLog").orderByChild("ts").limitToLast(20).on("value",function(snap){ /* kept for logAct */ });
function logAct(msg){ db.ref("actLog").push({msg:msg,ts:Date.now()}); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESS MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var bf13={Monday:"Vada+Sambar+Chutney+Shavige",Tuesday:"Poha+Fruits+Chowchow Bath+Chutney",Wednesday:"Plain Dosa+Aloo+Chutney+Egg",Thursday:"Bisi Belle Bath+Bread Jam+Fruits",Friday:"Green Moong Dosa+Oats+Chutney",Saturday:"Tomato Bath+Puliyogare+Chutney",Sunday:"Masala Dosa+Aloo+Chutney"};
var bf24={Monday:"Millets Khichdi+Vada+Sambar+Idly",Tuesday:"Lemon Rice+Bread Jam+Fruits",Wednesday:"Ragi Dosa+Dalia+Tomato Chutney+Egg",Thursday:"Onion Uthappam+Mangalore Bajji+Chutney",Friday:"Dal Khichdi+Dosa+Chutney",Saturday:"Pongal+Bread Jam+Fruits",Sunday:"Set Dosa+Chutney"};
var dm={Monday:{L:"Poori/Ragi Ball+Rice+Drumstick+Channa+Curd",S:"Cutlet+Tea",D:"Dal Makhni+Rice+Dal+Veg"},Tuesday:{L:"Methi Chapathi+Rice+Dal+Veg Pulav+Curd",S:"Kabuli Husli+Tea",D:"Soyabean+Radish Sambhar+Chapati"},Wednesday:{L:"Chapathi/Ragi+Rice+Paneer+Sprouts Sambhar",S:"Samosa+Tea",D:"Chapathi+Rice+Aloo+Rasam"},Thursday:{L:"Paratha+Rajma+Jeera Rice+Pudina Rice+Curd",S:"Vada Pav+Tea",D:"Chapathi+Egg Curry+Dal Palak+Salad"},Friday:{L:"Palak Chapati+Bhindi+Chicken Biryani+Curd",S:"Bhel Puri+Tea",D:"Chapathi+Rice+Dal+Veg"},Saturday:{L:"Chapathi+Rice+Dal+Mix Veg Beans+Curd",S:"Masala Vada+Tea",D:"Chapathi+Dal+Veg+Salad"},Sunday:{L:"Mushroom/Paneer Biryani+Salad",S:"Pav Bhaji+Tea",D:"Chapathi+Beetroot Palya+Veg"}};
var DAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function wkPat(d){ var fd=new Date(d.getFullYear(),d.getMonth(),1),wk=Math.ceil((d.getDate()+fd.getDay())/7); return(wk===1||wk===3)?"w13":"w24"; }
function nxMeal(){ var n=new Date(),h=n.getHours(),day=DAYS[n.getDay()]; if(h>=22){var t=new Date(n);t.setDate(t.getDate()+1);return{date:t,day:DAYS[t.getDay()],meal:"Breakfast"};} if(h>=18)return{date:n,day:day,meal:"Dinner"}; if(h>=15)return{date:n,day:day,meal:"Snacks"}; if(h>=10)return{date:n,day:day,meal:"Lunch"}; return{date:n,day:day,meal:"Breakfast"}; }
function getMnu(date,day,meal){ if(meal==="Breakfast") return (wkPat(date)==="w13"?bf13:bf24)[day]||""; var k={Lunch:"L",Snacks:"S",Dinner:"D"}[meal]; return dm[day]?dm[day][k]||"":""; }
function updMess(){ var n=nxMeal(); setText("mess-meal","Next: "+n.meal); setText("mess-menu",getMnu(n.date,n.day,n.meal)); }
updMess(); setInterval(updMess,60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEXT MEAL BANNER (top of page)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updMealBanner(){
  var n=nxMeal();
  setText("meal-label-top","Next: "+n.meal);
  setText("meal-name-top", n.day);
  setText("meal-menu-top", getMnu(n.date,n.day,n.meal)||"â€”");
}
updMealBanner(); setInterval(updMealBanner,60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTING ENGINE
//  Uses atomic _voteCount so confirmed state is reliable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var confirmed = {};

function doVote(place, value, thresh){
  var dvRef = db.ref(place+"_dv/"+devId);
  dvRef.once("value",function(snap){
    if(snap.exists()) return toast("Already voted for "+place);
    dvRef.set({v:value,ts:Date.now()});

    db.ref(place+"_votedFor").once("value",function(vf){
      var cur=vf.val();
      if(cur && cur!==value){
        dvRef.remove();
        return toast("Vote in progress for: "+cur);
      }
      if(!cur) db.ref(place+"_votedFor").set(value);

      db.ref(place+"_voteCount").transaction(function(c){ return (c||0)+1; },function(err,ok,sn){
        if(err||!ok||!sn){ dvRef.remove(); return toast("Error voting, try again"); }
        var count=sn.val(), rem=thresh-count;
        if(count>=thresh){
          confirmed[place]=true; // set immediately to prevent badge flicker during cleanup
          db.ref(place).set({status:value,ts:Date.now()},function(){
            db.ref(place+"_voteCount").remove();
            db.ref(place+"_votedFor").remove();
            db.ref(place+"_dv").remove();
            db.ref(place+"_pend").remove();
          });
          logAct("âœ… "+thresh+"/"+thresh+" confirmed: "+place+" â†’ "+value);
          toast("âœ… Community confirmed!");
        } else {
          db.ref(place+"_pend").set("Awaiting "+rem+" more confirmation(s)");
          logAct("ğŸ—³ï¸ "+place+" vote "+count+"/"+thresh+": "+value);
          toast("Vote recorded! "+rem+" more needed.");
        }
      });
    });
  });
  closeModal();
}

function adminSet(place, value){
  if(!checkAdmin()) return;
  db.ref(place).set({status:value,ts:Date.now()});
  db.ref(place+"_voteCount").remove();
  db.ref(place+"_votedFor").remove();
  db.ref(place+"_dv").remove();
  db.ref(place+"_pend").remove();
  logAct("ğŸ” Admin set: "+place+" â†’ "+value);
  toast("âœ… Override applied!"); closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenPlace(place, thresh, onStatus){
  db.ref(place).on("value",function(snap){
    var d=snap.val();
    if(!d||!d.status){
      confirmed[place]=false;
      // Clear stale device vote lock so user can vote in a new round
      db.ref(place+"_dv/"+devId).once("value",function(dvSnap){
        if(dvSnap.exists()) db.ref(place+"_dv/"+devId).remove();
      });
      setCB(place,0,false,thresh);
      onStatus(null);
      return;
    }
    confirmed[place]=true;
    setCB(place,0,true,thresh);
    onStatus(d);
  });
  db.ref(place+"_voteCount").on("value",function(snap){
    var c=snap.val()||0;
    var e=ge(place+"-vc"); if(e) e.textContent=c>0?"Votes: "+c:"";
    if(!confirmed[place]) setCB(place,c,false,thresh);
  });
  db.ref(place+"_pend").on("value",function(snap){
    var e=ge(place+"-pend"); if(e) e.textContent=(!confirmed[place]&&snap.val())?snap.val():"";
  });
}

// â”€â”€â”€ FULL-WIDTH TILE PAINTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paintFW(id, colorKey){
  var card = ge(id);
  if(!card) return;
  var c = CARD_COLORS[colorKey] || CARD_COLORS.dark;
  card.style.background  = c.bg;
  card.style.borderColor = c.border;
  card.style.boxShadow   = "0 4px 24px "+c.glow;
}
function setFWStatus(elId, text, colorKey){
  var e = ge(elId); if(!e) return;
  var colors = {
    green:"#6ee7b7", red:"#fca5a5", amber:"#fde68a", dark:"#94a3b8"
  };
  e.textContent = text;
  e.style.color = colors[colorKey] || colors.dark;
}

// MESS
listenPlace("mess",T_MESS,function(d){
  if(!d){ paintFW("mess-card","dark"); setFWStatus("mess-avail","Not Updated","dark"); ge("mess-ts").textContent=""; return; }
  if(d.status==="Food Available"){ paintFW("mess-card","green"); setFWStatus("mess-avail","âœ… Food Available","green"); }
  else { paintFW("mess-card","red"); setFWStatus("mess-avail","âŒ Not Available","red"); }
  ge("mess-ts").textContent=ago(d.ts);
});

// NANDINI
listenPlace("nandini",T_NANDINI,function(d){
  if(!d){ paintFW("nandini-card","dark"); setFWStatus("nandini-avail","Not Updated","dark"); ge("nandini-ts").textContent=""; return; }
  if(d.status==="Open"){ paintFW("nandini-card","green"); setFWStatus("nandini-avail","âœ… Open","green"); }
  else { paintFW("nandini-card","red"); setFWStatus("nandini-avail","ğŸ”’ Closed","red"); }
  ge("nandini-ts").textContent=ago(d.ts);
});

// NESCAFE
listenPlace("nescafe",T_NESCAFE,function(d){
  if(!d){ paintFW("nescafe-card","dark"); setFWStatus("nescafe-avail","Not Updated","dark"); ge("nescafe-ts").textContent=""; return; }
  if(d.status==="Open"){ paintFW("nescafe-card","green"); setFWStatus("nescafe-avail","âœ… Open","green"); }
  else { paintFW("nescafe-card","red"); setFWStatus("nescafe-avail","ğŸ”’ Closed","red"); }
  ge("nescafe-ts").textContent=ago(d.ts);
});

// GYM
listenPlace("gym",T_GYM,function(d){
  if(!d){ paintFW("gym-card","dark"); setFWStatus("gym-avail","Not Updated","dark"); ge("gym-ts").textContent=""; return; }
  if(d.status==="Open"){ paintFW("gym-card","green"); setFWStatus("gym-avail","âœ… Open","green"); }
  else if(d.status==="Open Â· Crowded"){ paintFW("gym-card","amber"); setFWStatus("gym-avail","âš ï¸ Open Â· Crowded","amber"); }
  else { paintFW("gym-card","red"); setFWStatus("gym-avail","ğŸ”’ Closed","red"); }
  ge("gym-ts").textContent=ago(d.ts);
});

// BADMINTON
listenPlace("bad",T_BAD,function(d){
  var s=ge("bad-avail"),tEl=ge("bad-ts");
  if(!d||!s){ paintCard("bad-card","dark"); return; }
  var st=d.status||"Not Updated";
  if(st==="Full"){ paintCard("bad-card","red"); s.className="sbdg s-red"; }
  else if(st.includes("1")||st.includes("2")){ paintCard("bad-card","amber"); s.className="sbdg s-amber"; }
  else { paintCard("bad-card","green"); s.className="sbdg s-green"; }
  s.textContent=st;
  if(tEl) tEl.textContent=ago(d.ts);
});

// DOCTOR ON CAMPUS
listenPlace("doc",T_DOC,function(d){
  var s=ge("doc-avail"),tEl=ge("doc-ts");
  if(!d){ paintCard("doc-card","dark"); s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  if(d.status==="On Campus"){ paintCard("doc-card","green"); s.className="sbdg s-green"; s.textContent="âœ… On Campus"; }
  else { paintCard("doc-card","red"); s.className="sbdg s-red"; s.textContent="âŒ Not Available"; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// Nescafe ON CAMPUS
listenPlace("nescafe",T_NESCAFE,function(d){
  var s=ge("nescafe-avail"),tEl=ge("nescafe-ts");
  if(!d){ paintCard("nescafe-card","dark"); s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  if(d.status==="On Campus"){ paintCard("nescafe-card","green"); s.className="sbdg s-green"; s.textContent="âœ… On Campus"; }
  else { paintCard("nescafe-card","red"); s.className="sbdg s-red"; s.textContent="âŒ Not Available"; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// Suggestions
db.ref("suggestions").on("value",function(snap){ setText("sug-count",(snap.numChildren()||0)+" suggestion(s)"); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FACULTY LOCATOR (single tile â†’ modal with all faculty)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var facConf = {};
var facStatuses = {}; // cache latest status per key

function isOfficeHours(){
  var h=new Date().getHours();
  return h>=9 && h<18; // 9amâ€“6pm = office hours; outside = auto Out of Office
}

function getFacDisplay(key){
  // If outside office hours, auto show Out of Office regardless of DB status
  if(!isOfficeHours()) return {badge:"ğŸŒ™ Out of Office", color:"s-gray", auto:true};
  var d=facStatuses[key];
  if(!d) return {badge:"Not Updated", color:"s-gray", auto:false};
  if(d.status==="In Class") return {badge:"ğŸ« In Class", color:"s-green", auto:false};
  if(d.status==="In Cabin") return {badge:"ğŸšª In Cabin", color:"s-teal", auto:false};
  if(d.status==="Admin")    return {badge:"ğŸ¢ Admin", color:"s-amber", auto:false};
  if(d.status==="On Leave") return {badge:"ğŸ–ï¸ On Leave", color:"s-red", auto:false};
  return {badge:d.status, color:"s-blue", auto:false};
}

function initFacultyListeners(){
  FACULTY.forEach(function(name,i){
    var key = "fac_"+i;
    listenFaculty(key, T_PROF);
  });
  // Re-check display every minute in case time crosses 6pm or 9am boundary
  setInterval(updateFacSummary, 60000);
}

function updateFacSummary(){
  if(!isOfficeHours()){
    setText("fac-summary","ğŸŒ™ Out of Office");
    return;
  }
  var updated=0, total=FACULTY.length;
  FACULTY.forEach(function(_,i){ if(facStatuses["fac_"+i]) updated++; });
  setText("fac-summary", updated+"/"+total+" updated");
}

function openFacultyLocator(){
  var officeHours=isOfficeHours();
  var rows = FACULTY.map(function(name,i){
    var key="fac_"+i;
    var disp=getFacDisplay(key);
    var short=name.replace(/^(Dr\.|Prof\.)\s/,"");
    var d=facStatuses[key];
    var ts_txt=(!disp.auto&&d)?ago(d.ts):"";
    var clickable=officeHours?"onclick=\"openFacModal("+i+")\"":"";
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid #1e1e35;'+(officeHours?'cursor:pointer;':'')+'" '+clickable+'>'+
      '<span style="font-size:0.88em;color:#e2e8f0;font-weight:600;">ğŸ‘¤ '+esc(short)+'</span>'+
      '<span style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">'+
        '<span class="sbdg '+disp.color+'" style="padding:3px 8px;font-size:0.72em;">'+disp.badge+'</span>'+
        (ts_txt?'<span style="font-size:0.6em;color:#444;">'+ts_txt+'</span>':'')+
      '</span></div>';
  }).join('');

  var officeNote=officeHours?'<p style="color:#888;font-size:0.78em;margin-bottom:10px;">Tap any faculty to update their location</p>':
    '<p style="color:#f59e0b;font-size:0.78em;margin-bottom:10px;">ğŸŒ™ Outside office hours (9amâ€“6pm) â€” all faculty shown as Out of Office</p>';

  var h='<div class="mh"><span>ğŸ“ Faculty Locator</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+=officeNote;
  h+='<div style="max-height:65vh;overflow-y:auto;">'+rows+'</div>';
  h+='<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';
  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function listenFaculty(key, thresh){
  db.ref(key).on("value",function(snap){
    var d=snap.val();
    if(!d||!d.status){
      facConf[key]=false;
      facStatuses[key]=null;
      // Clear stale device vote lock so user can vote in a new round
      db.ref(key+"_dv/"+devId).once("value",function(dvSnap){
        if(dvSnap.exists()) db.ref(key+"_dv/"+devId).remove();
      });
      setCB(key,0,false,thresh);
    } else {
      facConf[key]=true;
      facStatuses[key]=d;
      setCB(key,0,true,thresh);
    }
    updateFacSummary();
  });
  db.ref(key+"_voteCount").on("value",function(snap){
    var c=snap.val()||0;
    if(!facConf[key]) setCB(key,c,false,thresh);
  });
}

initFacultyListeners();
updateFacSummary();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adminRow(place, options){
  if(!isAdmin) return '';
  var btns = options.map(function(o){
    return '<button class="adm-btn" onclick="adminSet(\''+place+'\',\''+o.v+'\')">'+o.l+'</button>';
  }).join('');
  return '<div class="adm-sec"><div class="adm-lbl">ğŸ” Admin Override</div><div class="adm-row">'+btns+'</div></div>';
}

function openModal(place){
  var h='<div class="mh"><span>';

  if(place==='mess'){
    h+='ğŸ½ï¸ Mess</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Needs '+T_MESS+' confirmations to update</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'mess\',\'Food Available\','+T_MESS+')">âœ… Food Available</button>'+
      '<button class="mb r" onclick="doVote(\'mess\',\'Not Available\','+T_MESS+')">âŒ Not Available</button>'+
    '</div>'+
    adminRow('mess',[{v:'Food Available',l:'âœ… Food Available'},{v:'Not Available',l:'âŒ Not Available'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='nandini'){
    h+='ğŸ¥› Nandini</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Needs '+T_NANDINI+' confirmations to update</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'nandini\',\'Open\','+T_NANDINI+')">âœ… Open</button>'+
      '<button class="mb r" onclick="doVote(\'nandini\',\'Closed\','+T_NANDINI+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('nandini',[{v:'Open',l:'âœ… Open'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='nescafe'){
    h+='â˜• NescafÃ©</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Needs '+T_NESCAFE+' confirmations to update</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'nescafe\',\'Open\','+T_NESCAFE+')">âœ… Open</button>'+
      '<button class="mb r" onclick="doVote(\'nescafe\',\'Closed\','+T_NESCAFE+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('nescafe',[{v:'Open',l:'âœ… Open'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='gym'){
    h+='ğŸ‹ï¸ Gym</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Needs '+T_GYM+' confirmation to update</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'gym\',\'Open\','+T_GYM+')">âœ… Open</button>'+
      '<button class="mb a" onclick="doVote(\'gym\',\'Open Â· Crowded\','+T_GYM+')">âš ï¸ Open Â· Crowded</button>'+
      '<button class="mb r" onclick="doVote(\'gym\',\'Closed\','+T_GYM+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('gym',[{v:'Open',l:'âœ… Open'},{v:'Open Â· Crowded',l:'âš ï¸ Crowded'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='bad'){
    h+='ğŸ¸ Badminton</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">How many courts FREE? (needs '+T_BAD+')</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'bad\',\'4 Free\','+T_BAD+')">ğŸŸ¢ All 4 Free</button>'+
      '<button class="mb g" onclick="doVote(\'bad\',\'3 Free\','+T_BAD+')">ğŸŸ¢ 3 Free</button>'+
      '<button class="mb a" onclick="doVote(\'bad\',\'2 Free\','+T_BAD+')">ğŸŸ¡ 2 Free</button>'+
      '<button class="mb a" onclick="doVote(\'bad\',\'1 Free\','+T_BAD+')">ğŸŸ¡ 1 Free</button>'+
      '<button class="mb r" onclick="doVote(\'bad\',\'Full\','+T_BAD+')">ğŸ”´ All Full</button>'+
    '</div>'+
    adminRow('bad',[{v:'4 Free',l:'All 4 Free'},{v:'Full',l:'Full'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='doc'){
    h+='ğŸ¥ Doctor on Campus</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Is the doctor on campus? (needs '+T_DOC+')</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'doc\',\'On Campus\','+T_DOC+')">âœ… Yes â€” Doctor on Campus</button>'+
      '<button class="mb r" onclick="doVote(\'doc\',\'Not Available\','+T_DOC+')">âŒ No â€” Not Available</button>'+
    '</div>'+
    adminRow('doc',[{v:'On Campus',l:'âœ… On Campus'},{v:'Not Available',l:'âŒ Not Available'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='sug'){
    h+='ğŸ’¡ Suggestions</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<textarea class="mi" id="sug-in" rows="4" placeholder="Share an idea or bug report..."></textarea>';
    h+='<div class="bst"><button class="mb g" onclick="doSug()">Submit</button></div>';
    h+='<hr style="border:none;border-top:1px solid #2a2a3e;margin:14px 0;">';
    h+='<div id="sug-feed" style="max-height:200px;overflow-y:auto;"></div>';
    h+='<button class="mb x" style="margin-top:10px;" onclick="closeModal()">Close</button>';
    setTimeout(function(){
      db.ref("suggestions").orderByChild("ts").limitToLast(10).once("value",function(snap){
        var a=[]; snap.forEach(function(c){ a.push(c.val()); }); a.reverse();
        var e=ge("sug-feed"); if(!e) return;
        e.innerHTML=a.length?a.map(function(s){ return '<div style="background:rgba(255,255,255,0.03);border:1px solid #2a2a3e;border-radius:9px;padding:9px;margin-bottom:7px;font-size:0.8em;color:#94a3b8;">'+esc(s.text||'')+'<div style="font-size:0.7em;color:#444;margin-top:3px;">'+ago(s.ts)+'</div></div>'; }).join('') : '<p style="color:#444;text-align:center;padding:10px;">No suggestions yet</p>';
      });
    },100);
  }

  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function openFacModal(idx){
  if(!isOfficeHours()){ toast("ğŸŒ™ Faculty locator is active 9amâ€“6pm only"); return; }
  var key="fac_"+idx, name=FACULTY[idx];
  var h='<div class="mh"><span>ğŸ‘¤ '+esc(name)+'</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Where is '+esc(name.split(' ')[1]||name)+' right now? (needs '+T_PROF+')</p>';
  h+='<div class="bst">'+
    '<button class="mb g" onclick="doVote(\''+key+'\',\'In Class\','+T_PROF+')">ğŸ« In Class</button>'+
    '<button class="mb t" onclick="doVote(\''+key+'\',\'In Cabin\','+T_PROF+')">ğŸšª In Cabin</button>'+
    '<button class="mb a" onclick="doVote(\''+key+'\',\'Admin\','+T_PROF+')">ğŸ¢ Admin Block</button>'+
    '<button class="mb r" onclick="doVote(\''+key+'\',\'On Leave\','+T_PROF+')">ğŸ–ï¸ On Leave</button>'+
  '</div>';
  if(isAdmin){
    h+='<div class="adm-sec"><div class="adm-lbl">ğŸ” Admin Override</div><div class="adm-row">'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'In Class\')">In Class</button>'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'In Cabin\')">In Cabin</button>'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'Admin\')">Admin</button>'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'On Leave\')">On Leave</button>'+
    '</div></div>';
  }
  h+='<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';
  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function closeModal(){ ge("modal").classList.remove("active"); }
function bgClose(e){ if(e.target===ge("modal")) closeModal(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSug(){
  var t=(ge("sug-in")||{}).value||""; t=t.trim();
  if(!t) return alert("Please enter something");
  db.ref("suggestions").push({text:t,ts:Date.now()});
  logAct("ğŸ’¡ Suggestion submitted");
  toast("Thanks!"); closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANNOUNCEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAnnPost(){
  if(!checkAdmin()) return;
  var h='<div class="mh"><span>ğŸ“¢ Post Announcement</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+='<textarea class="mi" id="ann-in" rows="4" placeholder="Announcement text..."></textarea>';
  h+='<select class="msel" id="ann-tag"><option value="general">General</option><option value="mess">ğŸ› Mess</option><option value="event">ğŸ‰ Event</option><option value="academic">ğŸ“š Academic</option></select>';
  h+='<div class="bst"><button class="mb g" onclick="postAnn()">Post Announcement</button><button class="mb x" onclick="closeModal()">Cancel</button></div>';
  ge("mbox").innerHTML=h; ge("modal").classList.add("active");
}
function postAnn(){
  var t=(ge("ann-in")||{}).value||""; t=t.trim();
  var tag=(ge("ann-tag")||{}).value||"general";
  if(!t) return alert("Please enter text");
  db.ref("announcements").push({text:t,tag:tag,ts:Date.now()});
  logAct("ğŸ“¢ Announcement posted");
  toast("ğŸ“¢ Posted!"); closeModal();
}
function delAnn(id){ if(!checkAdmin()) return; if(!confirm("Delete?")) return; db.ref("announcements/"+id).remove(); toast("Deleted"); }
function cleanAnn(){ db.ref("announcements").once("value",function(snap){ var now=Date.now(); snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)>ANN_EXP) db.ref("announcements/"+c.key).remove(); }); }); }
cleanAnn(); setInterval(cleanAnn,300000);

db.ref("announcements").orderByChild("ts").on("value",function(snap){
  var posts=[],now=Date.now();
  snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)<ANN_EXP) posts.push({id:c.key,...d}); });
  posts.reverse();
  var con=ge("ann-list");
  if(!posts.length){ con.innerHTML='<div class="ann-empty">No announcements yet</div>'; return; }
  con.innerHTML=posts.map(function(p){
    var exp=Math.ceil((ANN_EXP-(now-p.ts))/60000);
    var expTxt=exp>60?Math.ceil(exp/60)+"hr left":exp+"m left";
    return '<div class="ann-card"><div class="ann-txt">'+esc(p.text)+'</div>'+
      '<div class="ann-meta"><span class="ann-tag tag-'+p.tag+'">'+p.tag+'</span><span class="ann-ts">'+ago(p.ts)+'</span><span class="ann-ts" style="color:#333;">â± '+expTxt+'</span>'+
      (isAdmin?'<button class="ann-del" onclick="delAnn(\''+p.id+'\')">ğŸ—‘</button>':'')+
      '</div></div>';
  }).join('');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMMEDIATE UPDATES + DOWNVOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
db.ref("immediateUpdates").orderByChild("ts").limitToLast(10).on("value",function(snap){
  var sec=ge("imm-wrap"),con=ge("imm-list"),posts=[];
  snap.forEach(function(c){ posts.push({id:c.key,...c.val()}); });
  posts.reverse();
  if(!posts.length){ sec.style.display="none"; return; }
  sec.style.display="block";
  con.innerHTML=posts.map(function(p){
    var dv=p.downvotes||0,dvd=!!localStorage.getItem("idv_"+p.id);
    return '<div class="imm-card">'+esc(p.text)+
      '<div class="imm-meta">ğŸ”´ Crowd verified Â· '+ago(p.ts)+
      ' <span style="color:#92400e;">'+dv+'/5 downvotes</span>'+
      '<button class="dv-btn" onclick="'+(dvd?'toast(\'Already downvoted\')':'dvImm(\''+p.id+'\')')+'" '+(dvd?'style="opacity:0.4;"':'')+'>ğŸ‘</button>'+
      (isAdmin?'<button class="ann-del" onclick="admDel(\''+p.id+'\')">ğŸ—‘</button>':'')+
      '</div></div>';
  }).join('');
});

function dvImm(id){
  var k="idv_"+id; if(localStorage.getItem(k)) return toast("Already downvoted");
  localStorage.setItem(k,"1");
  db.ref("immediateUpdates/"+id).transaction(function(d){ if(!d) return d; d.downvotes=(d.downvotes||0)+1; return d; },function(err,ok,snap){
    if(!snap) return; var d=snap.val();
    if(d&&d.downvotes>=IMM_DV){ db.ref("immediateUpdates/"+id).remove(); logAct("ğŸ—‘ï¸ Update removed by community"); toast("Post removed by community"); }
    else toast("Downvoted ("+(d?d.downvotes:1)+"/5)");
  });
}
function admDel(id){ if(!checkAdmin()) return; db.ref("immediateUpdates/"+id).remove(); toast("Deleted"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEARTBEAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCC(){ var v=ge("hb-txt").value,c=ge("chct"); c.textContent=v.length+" / 80"; c.className="chct"+(v.length>70?" warn":""); }
function postHB(){
  var t=ge("hb-txt").value.trim();
  if(!t) return alert("Write something"); if(t.length>80) return alert("Max 80 chars");
  db.ref("heartbeat").push({text:t,ts:Date.now(),upvotes:0,graduated:false});
  logAct("ğŸ’— Heartbeat: \""+t.slice(0,28)+(t.length>28?"â€¦":"")+"\"");
  ge("hb-txt").value=""; ge("chct").textContent="0 / 80";
}
function uvHB(id){
  var k="hbv_"+id; if(localStorage.getItem(k)) return toast("Already upvoted");
  localStorage.setItem(k,"1");
  db.ref("heartbeat/"+id).transaction(function(d){ if(!d) return d; d.upvotes=(d.upvotes||0)+1; return d; },function(err,ok,snap){
    if(!snap) return; var d=snap.val();
    if(d&&d.upvotes>=HB_VOTES&&!d.graduated){
      db.ref("immediateUpdates").push({text:d.text,ts:Date.now()});
      db.ref("heartbeat/"+id).update({graduated:true});
      logAct("ğŸ”´ Heartbeat graduated!");
      setTimeout(function(){ db.ref("heartbeat/"+id).remove(); },2500);
    }
  });
}
function cleanHB(){ db.ref("heartbeat").once("value",function(snap){ var now=Date.now(); snap.forEach(function(c){ var d=c.val(); if(d&&!d.graduated&&(now-d.ts)>HB_TTL) db.ref("heartbeat/"+c.key).remove(); }); }); }
cleanHB(); setInterval(cleanHB,30000);

db.ref("heartbeat").on("value",function(snap){
  var feed=ge("hb-feed"),now=Date.now(),posts=[];
  snap.forEach(function(c){ var d=c.val(); if(d&&!d.graduated) posts.push({id:c.key,...d}); });
  posts.sort(function(a,b){ return b.ts-a.ts; });
  if(!posts.length){ feed.innerHTML='<div class="hb-empty">No active posts Â· be the first</div>'; return; }
  feed.innerHTML=posts.map(function(p){
    var voted=!!localStorage.getItem("hbv_"+p.id);
    var rem=Math.max(0,HB_TTL-(now-p.ts)),pct=(rem/HB_TTL)*100,mins=Math.ceil(rem/60000),uv=p.upvotes||0;
    return '<div class="hb-card"><div style="flex:1;"><div class="hb-txt">'+esc(p.text)+'</div>'+
      '<div style="font-size:0.62em;color:#7f3040;margin-top:3px;">â± '+mins+'m left Â· '+uv+'/'+HB_VOTES+' upvotes</div>'+
      '<div class="tbar"><div class="tfil" style="width:'+pct+'%"></div></div></div>'+
      '<div class="hb-r"><button class="uv-btn'+(voted?' voted':'')+'" onclick="'+(voted?'toast(\'Already upvoted\')':'uvHB(\''+p.id+'\')')+'">ğŸ‘ '+uv+'</button></div></div>';
  }).join('');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initNotif();
</script>
</body>
</html>
<script>
(function () {
  let deferredInstallPrompt = null;

  function isStandaloneMode() {
    return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  }

  function notify(msg) {
    if (typeof toast === "function") toast(msg);
    else alert(msg);
  }

  function ensureInstallButton() {
    let btn = document.getElementById("install-btn");
    if (btn) return btn;

    btn = document.createElement("button");
    btn.id = "install-btn";
    btn.textContent = "ğŸ“² Add to Home";
    btn.style.cssText = [
      "display:none",
      "position:fixed",
      "bottom:20px",
      "left:20px",
      "background:linear-gradient(135deg,#10b981,#059669)",
      "color:#fff",
      "border:none",
      "border-radius:30px",
      "padding:11px 17px",
      "font-size:0.82em",
      "font-weight:700",
      "cursor:pointer",
      "box-shadow:0 4px 14px rgba(16,185,129,0.35)",
      "z-index:999",
      "font-family:'Space Grotesk',sans-serif"
    ].join(";");

    document.body.appendChild(btn);
    return btn;
  }

  function showInstallBtn(show) {
    const btn = ensureInstallButton();
    btn.style.display = show ? "block" : "none";
  }

  async function installApp() {
    if (isStandaloneMode()) {
      notify("âœ… App already added to home screen");
      return;
    }

    if (deferredInstallPrompt) {
      deferredInstallPrompt.prompt();
      try {
        await deferredInstallPrompt.userChoice;
      } catch (_) {}
      deferredInstallPrompt = null;
      showInstallBtn(false);
      return;
    }

    alert(
`To add this app to your home screen:

â€¢ iPhone (Safari): Tap Share â†’ Add to Home Screen
â€¢ Android (Chrome): Tap menu â‹® â†’ Add to Home screen`
    );
  }

  window.addEventListener("beforeinstallprompt", function (e) {
    e.preventDefault();
    deferredInstallPrompt = e;
    if (!isStandaloneMode()) showInstallBtn(true);
  });

  window.addEventListener("appinstalled", function () {
    showInstallBtn(false);
    notify("âœ… Added to home screen");
  });

  const btn = ensureInstallButton();
  btn.addEventListener("click", installApp);

  if (!isStandaloneMode()) showInstallBtn(true);
})();
</script>
<script>
(function () {
  
  
  // Create Campus Uno link below the existing FundBASEU Updates link
  var updatesLink = document.querySelector('a.upd-link');
  if (!updatesLink) return;

  // Add CSS once â€” styles are now in main stylesheet
  // (kept for backward compat, no-op if already defined)

  // Prevent duplicate insertion
  if (document.querySelector('a.cu-link')) return;

  // Insert line break + Campus Uno link right under FundBASEU Updates
  var br = document.createElement('br');
  var campusLink = document.createElement('a');
  campusLink.href = 'https://campus.uno/';
  campusLink.target = '_blank';
  campusLink.rel = 'noopener noreferrer';
  campusLink.className = 'cu-link';
  campusLink.textContent = 'ğŸ“ Go to Campus Uno â†’';

  updatesLink.insertAdjacentElement('afterend', br);
  br.insertAdjacentElement('afterend', campusLink);
})();
</script>
