<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Tracker</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 15px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  text-align: center;
  color: white;
  margin-bottom: 30px;
}

header h1 {
  font-size: 2.2em;
  margin-bottom: 8px;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
  font-weight: 800;
  letter-spacing: 1px;
}

header p {
  font-size: 1em;
  opacity: 0.95;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
}

.stats-bar {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
  color: white;
  font-size: 0.9em;
  opacity: 0.95;
}

.stat-number {
  font-size: 1.8em;
  font-weight: bold;
  display: block;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.stat-label {
  font-size: 0.85em;
  opacity: 0.9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.card {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  cursor: pointer;
  border: 2px solid rgba(255, 255, 255, 0.3);
  -webkit-tap-highlight-color: transparent;
}

.card:active {
  transform: scale(0.98);
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.card-title {
  font-size: 1.3em;
  font-weight: bold;
  color: #333;
}

.card-icon {
  font-size: 1.8em;
}

.status {
  padding: 10px 15px;
  border-radius: 20px;
  font-weight: bold;
  text-align: center;
  margin: 10px 0;
  font-size: 0.95em;
}

.status.available, .status.open {
  background: #10b981;
  color: white;
}

.status.finished, .status.closed {
  background: #ef4444;
  color: white;
}

.status.not-updated {
  background: #f59e0b;
  color: white;
}

.status.neutral {
  background: #3b82f6;
  color: white;
}

.last-updated {
  font-size: 0.8em;
  color: #666;
  text-align: center;
  margin-top: 8px;
}

.votes-info {
  font-size: 0.75em;
  color: #666;
  text-align: center;
  margin-top: 5px;
}

.menu-info {
  font-size: 0.85em;
  color: #555;
  margin-top: 8px;
  padding: 8px;
  background: #f3f4f6;
  border-radius: 8px;
  line-height: 1.4;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 15px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 20px;
  padding: 25px;
  max-width: 500px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-header {
  font-size: 1.6em;
  font-weight: bold;
  margin-bottom: 20px;
  color: #333;
}

.button-group {
  display: grid;
  gap: 12px;
  margin: 20px 0;
}

.btn {
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  -webkit-tap-highlight-color: transparent;
}

.btn:active {
  transform: scale(0.97);
}

.btn-available {
  background: #10b981;
  color: white;
}

.btn-finished {
  background: #ef4444;
  color: white;
}

.btn-open {
  background: #10b981;
  color: white;
}

.btn-closed {
  background: #ef4444;
  color: white;
}

.btn-close {
  background: #6b7280;
  color: white;
  margin-top: 15px;
}

.input-group {
  margin: 20px 0;
}

.input-group label {
  display: block;
  margin-bottom: 10px;
  font-weight: bold;
  color: #333;
  font-size: 0.95em;
}

.input-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
}

.confirmation-notice {
  background: #fef3c7;
  padding: 12px;
  border-radius: 10px;
  margin: 15px 0;
  text-align: center;
  font-weight: bold;
  color: #92400e;
  font-size: 0.9em;
}

.refresh-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 30px;
  padding: 12px 20px;
  font-size: 0.9em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 999;
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }

  header h1 {
    font-size: 1.8em;
  }

  header p {
    font-size: 0.9em;
  }

  .grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .card {
    padding: 18px;
  }

  .card-title {
    font-size: 1.2em;
  }

  .modal-content {
    padding: 20px;
    max-height: 90vh;
  }

  .modal-header {
    font-size: 1.4em;
  }

  .stats-bar {
    gap: 20px;
  }

  .stat-number {
    font-size: 1.5em;
  }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>üéì FundBASEU Tracker</h1>
    <p>Real-time campus status updates by students, for students</p>
  </header>

  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-number" id="liveCount">0</span>
      <span class="stat-label">üë• Live Users</span>
    </div>
    <div class="stat-item">
      <span class="stat-number" id="totalVisitors">0</span>
      <span class="stat-label">üìä Total Visitors</span>
    </div>
  </div>

  <div class="grid">
    <!-- Mess Card -->
    <div class="card" onclick="openModal('mess')">
      <div class="card-header">
        <span class="card-title">üçΩÔ∏è Mess</span>
        <span class="card-icon">üçõ</span>
      </div>
      <div id="mess-meal" class="status neutral"></div>
      <div id="mess-menu" class="menu-info"></div>
      <div id="mess-votes" class="votes-info"></div>
      <div id="mess-pending" class="votes-info"></div>
      <div id="mess-time" class="last-updated"></div>
    </div>

    <!-- Gym Card -->
    <div class="card" onclick="openModal('gym')">
      <div class="card-header">
        <span class="card-title">üèãÔ∏è Gym</span>
        <span class="card-icon">üí™</span>
      </div>
      <div id="gym-status" class="status not-updated">Click to update</div>
      <div id="gym-time" class="last-updated"></div>
    </div>

    <!-- Nescafe Card -->
    <div class="card" onclick="openModal('nescafe')">
      <div class="card-header">
        <span class="card-title">‚òï Nescaf√©</span>
        <span class="card-icon">ü•§</span>
      </div>
      <div id="nescafe-status" class="status not-updated">Click to update</div>
      <div id="nescafe-votes" class="votes-info"></div>
      <div id="nescafe-pending" class="votes-info"></div>
      <div id="nescafe-time" class="last-updated"></div>
    </div>

    <!-- Nandini Card -->
    <div class="card" onclick="openModal('nandini')">
      <div class="card-header">
        <span class="card-title">ü•õ Nandini</span>
        <span class="card-icon">üßÉ</span>
      </div>
      <div id="nandini-status" class="status not-updated">Click to update</div>
      <div id="nandini-votes" class="votes-info"></div>
      <div id="nandini-pending" class="votes-info"></div>
      <div id="nandini-time" class="last-updated"></div>
    </div>

    <!-- Badminton Card -->
    <div class="card" onclick="openModal('badminton')">
      <div class="card-header">
        <span class="card-title">üè∏ Badminton</span>
        <span class="card-icon">üéæ</span>
      </div>
      <div id="badminton-status" class="status not-updated">Click to update</div>
      <div id="badminton-votes" class="votes-info"></div>
      <div id="badminton-pending" class="votes-info"></div>
      <div id="badminton-time" class="last-updated"></div>
    </div>
  </div>
</div>

<button class="refresh-btn" onclick="location.reload()">üîÑ Refresh</button>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content" id="modal-content">
  </div>
</div>

<script>

// ---------- FIREBASE ----------
firebase.initializeApp({
  apiKey: "AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
  authDomain: "fundbaseu-tracker.firebaseapp.com",
  databaseURL: "https://fundbaseu-tracker-default-rtdb.firebaseio.com",
  projectId: "fundbaseu-tracker"
});
var db = firebase.database();

// Presence - Live Users
var p = db.ref("presence").push();
p.set(true);
p.onDisconnect().remove();
db.ref("presence").on("value", s => {
  document.getElementById("liveCount").innerText = s.numChildren();
});

// Total Visitors Counter
var visitorsRef = db.ref("totalVisitors");
visitorsRef.transaction(function(current) {
  return (current || 0) + 1;
});

visitorsRef.on("value", snap => {
  document.getElementById("totalVisitors").innerText = snap.val() || 0;
});

// Device ID
var deviceId = localStorage.getItem("deviceId");
if (!deviceId) {
  deviceId = 'dev_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("deviceId", deviceId);
}

const THRESHOLD_DEFAULT = 3;
const THRESHOLD_BADMINTON = 2;

// ---------- MESS MENU ENGINE ----------

// Breakfast alternates based on week pattern (1+3 vs 2+4)
const breakfastMenu = {
  Week13: {  // Weeks 1 and 3 of month
    Monday: "Vada + Sambar + Chutney + Shavige",
    Tuesday: "Poha + Fruits + Chowchow Bath + Chutney",
    Wednesday: "Plain Dosa + Aloo + Chutney + Egg",
    Thursday: "Bisi Belle Bath + Bread Jam + Fruits",
    Friday: "Green Moong Dosa + Oats + Chutney",
    Saturday: "Tomato Bath + Puliyogare + Chutney",
    Sunday: "Masala Dosa + Aloo + Chutney"
  },
  Week24: {  // Weeks 2 and 4 of month
    Monday: "Millets Khichdi + Vada + Sambar + Chutney + Idly",
    Tuesday: "Lemon Rice + Bread Jam + Fruits + Chutney",
    Wednesday: "Ragi Dosa + Dalia + Tomato Chutney + Egg",
    Thursday: "Onion Uthappam + Mangalore Bajji + Chutney",
    Friday: "Dal Khichdi + Dosa + Chutney",
    Saturday: "Pongal + Bread Jam + Fruits + Chutney",
    Sunday: "Set Dosa + Chutney"
  }
};

// Lunch, Snacks, Dinner from the photo
const dailyMenu = {
  Monday: {
    Lunch: "Poori or Ragi Ball + Rice + Drumstick + channa + Curd",
    Snacks: "Cutlet + Tea",
    Dinner: "Dal Makhni + Rice + Dal + Veg"
  },
  Tuesday: {
    Lunch: "MethiChapathi + Rice + Dal + VegPulav + Curd + Pickle",
    Snacks: "Kabuli Husli + Tea",
    Dinner: "Soyabean + Rice + Radish SambharDal + Chapati"
  },
  Wednesday: {
    Lunch: "Chapathi or Ragi Balls  + Rice + Dal + Paneer + Sproutssambhar + Pickle + Papad",
    Snacks: "Samosa + Tea",
    Dinner: "Chapathi + Rice + Aloo + Rasam"
  },
  Thursday: {
    Lunch: "Paratha + rajma + jeera rice + pudina rice + Curd + Pickle",
    Snacks: "Vada pav + Tea",
    Dinner: "Chapathi + Rice + Egg curry + Dal palak + Salad"
  },
  Friday: {
    Lunch: "palak chapati + Bhindi Chole + Dal + Chicken Biriyani + Veg + Curd + Pickle + Papad",
    Snacks: "Bhel puri + Tea",
    Dinner: "Chapathi + Rice + Dal + Veg"
  },
  Saturday: {
    Lunch: "Chapathi + Rice + Dal + mixVeg beans + Curd + Pickle",
    Snacks: "Masala vada + Tea",
    Dinner: "Chapathi + Rice + Dal + Veg + Salad"
  },
  Sunday: {
    Lunch: "Mushroom Biryani or Paneer Biriyani + Salad",
    Snacks: "Pav bhaji + Tea",
    Dinner: "Chapathi + Rice + Beetroot palya + Veg"
  }
};

const mealTimes = [
  { name: "Breakfast", start: 450, end: 600 },   // 7:30 AM - 10:00 AM
  { name: "Lunch", start: 750, end: 900 },       // 12:30 PM - 3:00 PM
  { name: "Snacks", start: 1020, end: 1140 },    // 5:00 PM - 7:00 PM
  { name: "Dinner", start: 1170, end: 1320 }     // 7:30 PM - 10:00 PM
];

const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

function getWeekPattern(date) {
  const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
  const weekOfMonth = Math.ceil((date.getDate() + firstDay.getDay()) / 7);
  return (weekOfMonth === 1 || weekOfMonth === 3) ? "Week13" : "Week24";
}

function getNextMeal() {
  const now = new Date();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const currentDay = now.getDay();
  
  for (let meal of mealTimes) {
    if (currentMinutes < meal.end) {
      return {
        date: now,
        day: dayNames[currentDay],
        meal: meal.name
      };
    }
  }
  
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowDay = tomorrow.getDay();
  
  return {
    date: tomorrow,
    day: dayNames[tomorrowDay],
    meal: "Breakfast"
  };
}

function getMenu(date, day, meal) {
  if (meal === "Breakfast") {
    const weekPattern = getWeekPattern(date);
    return breakfastMenu[weekPattern][day];
  } else {
    return dailyMenu[day][meal];
  }
}

function updateMessDisplay() {
  const nextMeal = getNextMeal();
  const menu = getMenu(nextMeal.date, nextMeal.day, nextMeal.meal);
  
  document.getElementById("mess-meal").innerHTML = "Next: " + nextMeal.meal;
  document.getElementById("mess-menu").innerHTML = menu;
}

updateMessDisplay();
setInterval(updateMessDisplay, 60000);

// ---------- MODAL ----------
function openModal(place) {
  let html = '<div class="modal-header">';
  
  if (place === 'mess') {
    html += 'üçΩÔ∏è Mess Status</div>';
    html += '<div class="button-group">';
    html += '<button class="btn btn-available" onclick="vote(\'mess\', \'Food Available\')">Food Available</button>';
    html += '<button class="btn btn-finished" onclick="vote(\'mess\', \'Food Not Available\')">Food Not Available</button>';
    html += '</div>';
  }
  else if (place === 'gym') {
    html += 'üèãÔ∏è Gym Crowd</div>';
    html += '<div class="button-group">';
    html += '<button class="btn btn-available" onclick="updateGym(\'Below 3\')">Below 3 people</button>';
    html += '<button class="btn btn-finished" onclick="updateGym(\'Above 3\')">Above 3 people</button>';
    html += '</div>';
  }
  else if (place === 'badminton') {
    html += 'üè∏ Badminton Courts</div>';
    html += '<div class="input-group">';
    html += '<label>How many courts are occupied? (0-4)</label>';
    html += '<input type="number" id="badminton-val" min="0" max="4" placeholder="Enter 0-4">';
    html += '</div>';
    html += '<button class="btn btn-available" onclick="voteBadminton()">Submit</button>';
  }
  else if (place === 'nescafe') {
    html += '‚òï Nescaf√© Status</div>';
    html += '<div class="button-group">';
    html += '<button class="btn btn-open" onclick="vote(\'nescafe\', \'Open\')">Open</button>';
    html += '<button class="btn btn-closed" onclick="vote(\'nescafe\', \'Closed\')">Closed</button>';
    html += '</div>';
  }
  else if (place === 'nandini') {
    html += 'ü•õ Nandini Status</div>';
    html += '<div class="button-group">';
    html += '<button class="btn btn-open" onclick="vote(\'nandini\', \'Open\')">Open</button>';
    html += '<button class="btn btn-closed" onclick="vote(\'nandini\', \'Closed\')">Closed</button>';
    html += '</div>';
  }
  
  html += '<button class="btn btn-close" onclick="closeModal()">Close</button>';
  
  document.getElementById("modal-content").innerHTML = html;
  document.getElementById("modal").classList.add("active");
}

function closeModal() {
  document.getElementById("modal").classList.remove("active");
}

// ---------- VOTING ----------
function vote(place, value) {
  if (!value) return alert("Please select an option");

  var deviceRef = db.ref(place + "_deviceVotes/" + deviceId);
  deviceRef.once("value", snap => {
    if (snap.exists()) return alert("You already voted.");

    var voteRef = db.ref(place + "_votes/" + value);
    voteRef.transaction(c => (c || 0) + 1, function(e, committed, snap) {
      if (!snap) return;
      var votes = snap.val();
      var threshold = THRESHOLD_DEFAULT;
      var remaining = threshold - votes;

      if (votes >= threshold) {
        db.ref(place).set({ status: value, timestamp: Date.now() });
        db.ref(place + "_votes").remove();
        db.ref(place + "_pending").remove();
        db.ref(place + "_deviceVotes").remove();
        alert("Status updated successfully!");
      } else {
        db.ref(place + "_pending").set({ message: "Awaiting " + remaining + " more confirmation(s)" });
        alert("Vote recorded! Need " + remaining + " more confirmation(s)");
      }
    });
    deviceRef.set(true);
  });
  closeModal();
}

function updateGym(status) {
  db.ref("gym").set({ status: status, timestamp: Date.now() });
  alert("Gym status updated!");
  closeModal();
}

function voteBadminton() {
  const value = document.getElementById("badminton-val").value;
  if (!value || value < 0 || value > 4) return alert("Please enter a number between 0-4");

  var deviceRef = db.ref("badminton_deviceVotes/" + deviceId);
  deviceRef.once("value", snap => {
    if (snap.exists()) return alert("You already voted.");

    var voteRef = db.ref("badminton_votes/" + value);
    voteRef.transaction(c => (c || 0) + 1, function(e, committed, snap) {
      if (!snap) return;
      var votes = snap.val();
      var threshold = THRESHOLD_BADMINTON;
      var remaining = threshold - votes;

      if (votes >= threshold) {
        db.ref("badminton").set({ count: parseInt(value), timestamp: Date.now() });
        db.ref("badminton_votes").remove();
        db.ref("badminton_pending").remove();
        db.ref("badminton_deviceVotes").remove();
        alert("Status updated successfully!");
      } else {
        db.ref("badminton_pending").set({ message: "Awaiting " + remaining + " more confirmation(s)" });
        alert("Vote recorded! Need " + remaining + " more confirmation(s)");
      }
    });
    deviceRef.set(true);
  });
  closeModal();
}

function timeAgo(ts) {
  if (!ts) return "";
  var m = Math.floor((Date.now() - ts) / 60000);
  if (m < 1) return "Updated just now";
  if (m === 1) return "Updated 1 min ago";
  if (m < 60) return "Updated " + m + " min ago";
  const h = Math.floor(m / 60);
  if (h === 1) return "Updated 1 hour ago";
  return "Updated " + h + " hours ago";
}

// ---------- LISTENERS ----------
['mess', 'nescafe', 'nandini', 'badminton', 'gym'].forEach(place => {
  db.ref(place).on("value", snap => {
    var d = snap.val();
    var statusEl = document.getElementById(place + '-status');
    var timeEl = document.getElementById(place + '-time');
    
    if (!d) {
      if (statusEl && place !== 'mess') {
        statusEl.className = "status not-updated";
        statusEl.innerHTML = "Click to update";
      }
      if (timeEl) timeEl.innerHTML = "";
      return;
    }

    if (place === 'badminton') {
      if (statusEl) {
        statusEl.innerHTML = d.count + "/4 Courts Occupied";
        statusEl.className = 'status neutral';
      }
      if (timeEl) timeEl.innerHTML = timeAgo(d.timestamp);
    }
    else if (place === 'gym') {
      if (statusEl) {
        statusEl.innerHTML = d.status;
        statusEl.className = 'status neutral';
      }
      if (timeEl) timeEl.innerHTML = timeAgo(d.timestamp);
    }
    else if (place === 'mess') {
      if (timeEl) timeEl.innerHTML = timeAgo(d.timestamp);
    }
    else {
      if (statusEl) {
        statusEl.innerHTML = d.status;
        statusEl.className = d.status === 'Open' ? 'status open' : 'status closed';
      }
      if (timeEl) timeEl.innerHTML = timeAgo(d.timestamp);
    }
  });

  if (place !== 'gym') {
    db.ref(place + "_votes").on("value", snap => {
      var total = 0;
      snap.forEach(c => total += c.val());
      var votesEl = document.getElementById(place + '-votes');
      if (votesEl) votesEl.innerHTML = total > 0 ? "Votes: " + total : "";
    });
    
    db.ref(place + "_pending").on("value", snap => {
      var pendingEl = document.getElementById(place + '-pending');
      if (pendingEl) pendingEl.innerHTML = snap.val() ? snap.val().message : "";
    });
  }
});

</script>
</body>
</html>