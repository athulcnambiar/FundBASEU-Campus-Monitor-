<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
:root {
  --bg: #0a0a14;
  --bg-card: #111120;
  --bg-panel: #16162a;
  --bg-raised: #1c1c34;
  --text: #eeeeff;
  --muted: #7780a0;
  --faint: #3a3f58;
  --violet: #8b5cf6;
  --blue: #3b82f6;
  --teal: #14b8a6;
  --green: #10b981;
  --amber: #f59e0b;
  --red: #ef4444;
  --pink: #ec4899;
  --border: #1e1e36;
  --border-soft: #222238;
  --r-lg: 20px;
  --r-md: 14px;
  --r-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.6);
  --shadow-sm: 0 4px 16px rgba(0,0,0,0.4);
}
body.light {
  --bg: #f0f1f8;
  --bg-card: #fff;
  --bg-panel: #eef0f8;
  --bg-raised: #e6e8f4;
  --text: #0f1020;
  --muted: #4b5680;
  --faint: #aab0c8;
  --border: #dde1f0;
  --border-soft: #e5e8f8;
  --shadow: 0 6px 24px rgba(15,20,60,0.1);
  --shadow-sm: 0 2px 10px rgba(15,20,60,0.07);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 0 0 100px;
  -webkit-font-smoothing: antialiased;
  transition: background .3s, color .3s;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px 0;
  max-width: 640px;
  margin: 0 auto;
}
.brand {
  font-size: 1.15em;
  font-weight: 900;
  background: linear-gradient(120deg,#a78bfa,#60a5fa,#34d399);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; letter-spacing: -0.5px;
}
.topbar-right { display: flex; gap: 8px; align-items: center; }
.pill-btn {
  padding: 6px 14px; border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--muted);
  font-size: 0.75em; font-weight: 700;
  cursor: pointer; font-family: inherit;
  transition: all .2s;
}
.pill-btn:hover { background: var(--bg-raised); color: var(--text); }

/* â”€â”€ HERO â”€â”€ */
.hero {
  max-width: 640px;
  margin: 0 auto;
  padding: 18px 18px 0;
  text-align: center;
}
.hero-sub { font-size: .72em; color: var(--muted); font-weight: 500; margin-bottom: 12px; }

/* â”€â”€ WEEKEND COUNTDOWN â”€â”€ */
#wknd-banner {
  max-width: 640px;
  margin: 14px auto 0;
  padding: 0 18px;
}
.wknd-card {
  border-radius: var(--r-lg);
  padding: 16px 20px;
  background: linear-gradient(135deg,#13071f,#1a0a40,#0a1a30);
  border: 1px solid rgba(139,92,246,.4);
  box-shadow: 0 0 40px rgba(139,92,246,.15);
  display: flex; align-items: center; justify-content: space-between;
  gap: 12px;
}
.wknd-left { display: flex; flex-direction: column; gap: 2px; }
.wknd-label { font-size: .62em; font-weight: 800; letter-spacing: 2px; color: #a78bfa; text-transform: uppercase; }
.wknd-msg { font-size: 1.05em; font-weight: 800; color: #fff; letter-spacing: -.3px; }
.wknd-sub { font-size: .72em; color: rgba(255,255,255,.45); }
.wknd-timer {
  display: flex; gap: 8px; flex-shrink: 0;
}
.wt-blk {
  text-align: center;
  background: rgba(139,92,246,.15);
  border: 1px solid rgba(139,92,246,.25);
  border-radius: 10px;
  padding: 6px 10px;
  min-width: 46px;
}
.wt-num {
  font-family: 'DM Mono', monospace;
  font-size: 1.2em; font-weight: 500;
  color: #c4b5fd; display: block;
}
.wt-lbl { font-size: .52em; color: rgba(196,181,253,.5); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.wknd-today { color: #34d399; font-size: 1.3em; }

/* â”€â”€ SECTION WRAPPER â”€â”€ */
.wrap { max-width: 640px; margin: 0 auto; padding: 0 18px; }
.sec-head {
  display: flex; align-items: center; justify-content: space-between;
  margin: 22px 0 10px;
}
.sec-title {
  font-size: .65em; font-weight: 800; letter-spacing: 2.5px;
  text-transform: uppercase; color: var(--faint);
}
.sec-action {
  font-size: .72em; font-weight: 700;
  color: var(--violet); cursor: pointer;
  background: none; border: none; font-family: inherit;
  padding: 4px 10px; border-radius: 8px;
  transition: background .2s;
}
.sec-action:hover { background: rgba(139,92,246,.1); }

/* â”€â”€ STATS ROW â”€â”€ */
.stats-row {
  display: flex; gap: 8px; flex-wrap: wrap;
  margin: 14px auto 0; max-width: 640px; padding: 0 18px;
}
.stat-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 13px;
  box-shadow: var(--shadow-sm);
}
.stat-n { font-size: .9em; font-weight: 800; color: var(--text); }
.stat-l { font-size: .7em; color: var(--muted); font-weight: 500; }

/* â”€â”€ MEAL BLOCK â”€â”€ */
.meal-block {
  background: var(--bg-card);
  border: 1px solid var(--border-soft);
  border-radius: var(--r-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.meal-stripe {
  height: 3px;
  background: linear-gradient(90deg,#a78bfa,#60a5fa,#34d399);
}
.meal-inner { padding: 16px 18px 18px; }
.meal-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
.meal-name-row { display: flex; align-items: center; gap: 8px; }
.meal-emoji { font-size: 1.6em; line-height: 1; }
.meal-name { font-size: 1.25em; font-weight: 900; letter-spacing: -.3px; color: var(--text); }
.meal-day { font-size: .78em; color: var(--muted); font-weight: 500; margin-top: 2px; }
.meal-chips { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
.m-chip {
  background: rgba(99,102,241,.1);
  border: 1px solid rgba(99,102,241,.18);
  color: var(--muted);
  padding: 3px 10px; border-radius: 20px;
  font-size: .73em; font-weight: 500;
}

/* â”€â”€ MEAL RATING â”€â”€ */
.meal-rating-section {
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.meal-rating-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.mrl { font-size: .72em; font-weight: 700; color: var(--muted); }
.meal-avg {
  display: flex; align-items: center; gap: 5px;
  flex-shrink: 0;
}
.meal-avg-num {
  font-size: 1.1em; font-weight: 900;
  font-family: 'DM Mono', monospace;
  color: var(--text);
}
.meal-avg-stars { font-size: .85em; letter-spacing: 1px; }
.meal-avg-count { font-size: .65em; color: var(--muted); }

.star-row { display: flex; gap: 6px; }
.star-btn {
  font-size: 1.5em; background: none; border: none;
  cursor: pointer; transition: transform .15s;
  filter: grayscale(1) opacity(.4);
  padding: 2px;
}
.star-btn.active { filter: none; }
.star-btn:hover { transform: scale(1.2); filter: none; }
.meal-rated-msg { font-size: .72em; color: var(--green); font-weight: 600; margin-top: 6px; }

.bar-chart { display: flex; flex-direction: column; gap: 3px; margin-top: 10px; }
.bar-row { display: flex; align-items: center; gap: 6px; }
.bar-lbl { font-size: .62em; color: var(--muted); width: 16px; text-align: right; font-family: 'DM Mono', monospace; }
.bar-track { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #f59e0b, #fbbf24); transition: width .6s ease; }
.bar-ct { font-size: .6em; color: var(--faint); min-width: 16px; font-family: 'DM Mono', monospace; }

/* â”€â”€ STATUS GRID â”€â”€ */
.status-grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 10px;
}
@media(min-width:400px) { .status-grid { grid-template-columns: repeat(3,1fr); } }

.s-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 13px 12px;
  cursor: pointer;
  transition: transform .18s, box-shadow .2s, border-color .3s, background .3s;
  box-shadow: var(--shadow-sm);
  display: flex; flex-direction: column; gap: 3px;
  min-height: 100px; justify-content: space-between;
  position: relative; overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}
.s-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.s-card:active { transform: scale(.97); }
.s-card-icon { font-size: 1.4em; line-height: 1; margin-bottom: 2px; }
.s-card-name { font-size: .78em; font-weight: 800; color: var(--text); line-height: 1.2; }
.s-card-badge { display: block; padding: 4px 10px; border-radius: 16px; font-size: .7em; font-weight: 700; text-align: center; margin-top: 4px; }
.s-card-ts { font-size: .6em; color: var(--faint); text-align: center; margin-top: 2px; }
.s-card-cv { font-size: .62em; text-align: center; margin-top: 1px; }

.bg-green { background: rgba(16,185,129,.12) !important; border-color: rgba(16,185,129,.4) !important; }
.bg-red   { background: rgba(239,68,68,.1)  !important; border-color: rgba(239,68,68,.35) !important; }
.bg-amber { background: rgba(245,158,11,.1) !important; border-color: rgba(245,158,11,.35) !important; }

.bdg-green  { background: rgba(16,185,129,.2); color: #34d399; border: 1px solid rgba(16,185,129,.35); }
.bdg-red    { background: rgba(239,68,68,.2);  color: #f87171; border: 1px solid rgba(239,68,68,.35); }
.bdg-amber  { background: rgba(245,158,11,.2); color: #fbbf24; border: 1px solid rgba(245,158,11,.35); }
.bdg-gray   { background: rgba(100,116,139,.15); color: var(--muted); border: 1px solid rgba(100,116,139,.25); }
body.light .bdg-green { background: rgba(16,185,129,.1); color: #059669; }
body.light .bdg-red   { background: rgba(239,68,68,.08); color: #dc2626; }
body.light .bdg-amber { background: rgba(245,158,11,.1); color: #d97706; }

/* â”€â”€ CLASS SIGNAL â”€â”€ */
.class-signal-grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 8px;
}
@media(min-width:420px) { .class-signal-grid { grid-template-columns: repeat(3,1fr); } }
@media(min-width:540px) { .class-signal-grid { grid-template-columns: repeat(4,1fr); } }

.cs-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px 11px;
  cursor: pointer;
  transition: transform .18s, box-shadow .2s, border-color .3s, background .3s;
  box-shadow: var(--shadow-sm);
  display: flex; flex-direction: column; gap: 4px;
  -webkit-tap-highlight-color: transparent;
  position: relative; overflow: hidden;
}
.cs-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.cs-card:active { transform: scale(.97); }
.cs-room-name {
  font-family: 'DM Mono', monospace;
  font-size: .92em; font-weight: 500;
  color: var(--text); letter-spacing: -.3px;
}
.cs-badge {
  display: block; padding: 4px 8px; border-radius: 10px;
  font-size: .68em; font-weight: 700; text-align: center; margin-top: 2px;
}
.cs-timer { font-size: .58em; color: var(--faint); font-family: 'DM Mono', monospace; margin-top: 1px; }
.cs-conf { font-size: .6em; color: var(--violet); margin-top: 1px; }
.cs-dot {
  width: 7px; height: 7px; border-radius: 50%;
  position: absolute; top: 10px; right: 10px;
}
.cs-dot-green { background: #10b981; animation: cspulse 2s infinite; }
.cs-dot-amber { background: #f59e0b; animation: cspulse 2s infinite; }
.cs-dot-red   { background: #ef4444; }
.cs-dot-gray  { background: var(--faint); }
@keyframes cspulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }

.cs-card.cs-active-green { background: rgba(16,185,129,.08) !important; border-color: rgba(16,185,129,.3) !important; }
.cs-card.cs-active-amber { background: rgba(245,158,11,.08) !important; border-color: rgba(245,158,11,.3) !important; }
.cs-card.cs-active-red   { background: rgba(239,68,68,.07)  !important; border-color: rgba(239,68,68,.28) !important; }

/* â”€â”€ LOST & FOUND â”€â”€ */
.lf-card {
  background: var(--bg-card);
  border: 1px solid var(--border-soft);
  border-radius: var(--r-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.lf-stripe {
  height: 3px;
  background: linear-gradient(90deg, #f59e0b, #ec4899);
}
.lf-inner { padding: 16px 18px; }
.lf-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.lf-icon { font-size: 1.5em; }
.lf-title { font-size: 1em; font-weight: 800; color: var(--text); }
.lf-sub { font-size: .72em; color: var(--muted); margin-top: 2px; }
.lf-btns { display: flex; gap: 8px; }
.lf-btn {
  flex: 1; padding: 11px 8px; border-radius: var(--r-sm);
  border: none; cursor: pointer; font-size: .82em; font-weight: 800;
  font-family: inherit; transition: opacity .2s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.lf-btn-lost { background: rgba(239,68,68,.15); color: #f87171; border: 1px solid rgba(239,68,68,.3); }
.lf-btn-found { background: rgba(16,185,129,.15); color: #34d399; border: 1px solid rgba(16,185,129,.3); }
.lf-btn:hover { opacity: .8; }

.lf-list { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; max-height: 260px; overflow-y: auto; }
.lf-item {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 11px 13px;
  display: flex; align-items: flex-start; gap: 10px;
  animation: fadeUp .25s ease;
}
.lf-item-icon { font-size: 1.2em; flex-shrink: 0; }
.lf-item-body { flex: 1; }
.lf-item-desc { font-size: .84em; color: var(--text); font-weight: 600; line-height: 1.35; }
.lf-item-loc { font-size: .7em; color: var(--muted); margin-top: 2px; }
.lf-item-meta { font-size: .63em; color: var(--faint); margin-top: 3px; display: flex; gap: 6px; align-items: center; }
.lf-type-lost  { background: rgba(239,68,68,.12); color: #f87171; padding: 1px 7px; border-radius: 6px; font-weight: 700; font-size: .9em; }
.lf-type-found { background: rgba(16,185,129,.12); color: #34d399; padding: 1px 7px; border-radius: 6px; font-weight: 700; font-size: .9em; }
.lf-resolve-btn {
  background: none; border: 1px solid var(--border);
  border-radius: 6px; color: var(--muted);
  font-size: .65em; font-weight: 700; padding: 2px 7px;
  cursor: pointer; font-family: inherit; margin-left: auto;
}
.lf-empty { text-align: center; color: var(--muted); font-size: .8em; padding: 18px; border: 1px dashed var(--border); border-radius: var(--r-sm); }

/* â”€â”€ ANNOUNCEMENTS â”€â”€ */
.ann-card {
  background: var(--bg-card);
  border: 1px solid var(--border-soft);
  border-radius: var(--r-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.ann-inner { padding: 16px 18px; }
.ann-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.ann-title-row { font-size: 1em; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 8px; }
.ann-exp-badge { font-size: .62em; color: var(--muted); background: var(--bg-panel); border: 1px solid var(--border); padding: 2px 8px; border-radius: 8px; font-weight: 500; }
.ann-post-btn {
  background: rgba(139,92,246,.12); border: 1px solid rgba(139,92,246,.28);
  color: #a78bfa; padding: 6px 14px; border-radius: 10px;
  font-size: .74em; font-weight: 700; cursor: pointer; font-family: inherit;
  transition: background .2s;
}
.ann-post-btn:hover { background: rgba(139,92,246,.22); }
.ann-list { display: flex; flex-direction: column; gap: 8px; }
.ann-item {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 11px 13px;
  position: relative; overflow: hidden;
  animation: fadeUp .25s ease;
}
.ann-item::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--violet); border-radius: 3px 0 0 3px;
}
.ann-item.tag-mess::before { background: var(--amber); }
.ann-item.tag-event::before { background: var(--blue); }
.ann-item.tag-academic::before { background: var(--green); }
.ann-text { font-size: .85em; color: var(--text); line-height: 1.55; font-weight: 500; margin-bottom: 7px; }
.ann-meta { display: flex; align-items: center; gap: 7px; flex-wrap: wrap; }
.ann-tag { font-size: .63em; font-weight: 700; padding: 2px 8px; border-radius: 7px; text-transform: uppercase; letter-spacing: .5px; }
.tag-general { background: rgba(139,92,246,.12); color: #a78bfa; }
.tag-mess { background: rgba(245,158,11,.12); color: #fbbf24; }
.tag-event { background: rgba(59,130,246,.12); color: #60a5fa; }
.tag-academic { background: rgba(16,185,129,.12); color: #34d399; }
.ann-time { font-size: .63em; color: var(--faint); }
.ann-del-btn { margin-left: auto; background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.2); color: #f87171; padding: 2px 7px; border-radius: 6px; font-size: .63em; cursor: pointer; font-weight: 700; }
.ann-empty { text-align: center; color: var(--muted); font-size: .8em; padding: 16px; }

/* â”€â”€ MODAL â”€â”€ */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.82); z-index: 1000; align-items: flex-end; justify-content: center; }
.modal.open { display: flex; }
.mbox {
  background: var(--bg-card); border-radius: 24px 24px 0 0;
  padding: 22px 20px 40px; width: 100%; max-width: 540px;
  max-height: 88vh; overflow-y: auto;
  border: 1px solid var(--border); border-bottom: none;
  animation: slideUp .28s cubic-bezier(.34,1.2,.64,1);
}
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
@keyframes fadeUp { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
.mh { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.mh-title { font-size: 1.15em; font-weight: 800; color: var(--text); }
.mx { background: var(--bg-panel); border: 1px solid var(--border); color: var(--muted); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: .9em; display: flex; align-items: center; justify-content: center; }
.m-label { font-size: .72em; font-weight: 700; color: var(--muted); margin-bottom: 6px; margin-top: 14px; text-transform: uppercase; letter-spacing: 1px; }
.m-input {
  width: 100%; background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 11px 13px; color: var(--text);
  font-size: .88em; font-family: inherit; outline: none;
  transition: border-color .2s; resize: none;
}
.m-input:focus { border-color: var(--violet); }
.m-input::placeholder { color: var(--faint); }
.m-select {
  width: 100%; background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 11px 13px; color: var(--text);
  font-size: .88em; font-family: inherit; outline: none; appearance: none;
}
.m-btn-row { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
.m-btn {
  padding: 13px; border: none; border-radius: 12px;
  font-size: .9em; font-weight: 800; cursor: pointer; font-family: inherit;
  transition: opacity .15s; text-align: center;
}
.m-btn-green { background: #10b981; color: #fff; }
.m-btn-amber { background: #f59e0b; color: #fff; }
.m-btn-red   { background: #ef4444; color: #fff; }
.m-btn-secondary { background: var(--bg-panel); border: 1px solid var(--border); color: var(--muted); }
.m-btn:hover { opacity: .88; }
.m-adm-section { margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(239,68,68,.2); }
.m-adm-label { font-size: .7em; color: #ef4444; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
.m-adm-row { display: flex; gap: 7px; flex-wrap: wrap; }
.m-adm-btn {
  flex: 1; min-width: 70px; padding: 8px; border-radius: 9px;
  background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.2);
  color: #fca5a5; font-size: .78em; font-weight: 700;
  cursor: pointer; font-family: inherit; text-align: center;
}

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  background: var(--bg-raised); color: var(--text); border: 1px solid var(--border);
  padding: 10px 20px; border-radius: 30px; font-size: .82em; font-weight: 700;
  opacity: 0; transition: opacity .3s; z-index: 9999;
  pointer-events: none; white-space: nowrap; box-shadow: var(--shadow);
}

/* â”€â”€ ADMIN BAR â”€â”€ */
#admin-bar {
  display: none; position: fixed; top: 10px; right: 10px;
  background: rgba(239,68,68,.18); border: 1px solid rgba(239,68,68,.4);
  color: #f87171; padding: 5px 13px; border-radius: 18px;
  font-size: .7em; font-weight: 700; z-index: 600; cursor: pointer;
}
#admin-bar.show { display: block; }

/* â”€â”€ REFRESH BTN â”€â”€ */
.ref-btn {
  position: fixed; bottom: 20px; right: 16px;
  background: linear-gradient(135deg,#6366f1,#8b5cf6);
  color: #fff; border: none; border-radius: 28px; padding: 11px 18px;
  font-size: .82em; font-weight: 800; cursor: pointer;
  box-shadow: 0 4px 16px rgba(99,102,241,.45);
  z-index: 999; font-family: inherit; transition: transform .15s;
}
.ref-btn:hover { transform: scale(1.04); }

/* â”€â”€ CAMPUS UNO TILE â”€â”€ */
.cu-tile {
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  padding: 16px 20px; border-radius: var(--r-lg);
  background: linear-gradient(135deg,#1e1b4b,#1e3a8a,#0c4a6e);
  border: 1px solid rgba(99,102,241,.4);
  box-shadow: 0 6px 24px rgba(99,102,241,.2);
  text-decoration: none; cursor: pointer;
  transition: transform .2s, box-shadow .2s;
  -webkit-tap-highlight-color: transparent;
}
.cu-tile:hover { transform: translateY(-2px); box-shadow: 0 10px 32px rgba(99,102,241,.35); }
.cu-tile-left { display: flex; align-items: center; gap: 12px; }
.cu-tile-icon { font-size: 1.8em; background: rgba(255,255,255,.1); padding: 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); }
.cu-tile-name { font-size: 1em; font-weight: 800; color: #fff; letter-spacing: -.2px; }
.cu-tile-sub { font-size: .75em; color: rgba(255,255,255,.5); margin-top: 2px; }
.cu-tile-arrow { font-size: 1.3em; color: rgba(255,255,255,.6); }
body.light .cu-tile { background: linear-gradient(135deg,#4f46e5,#2563eb,#0369a1); }

/* â”€â”€ FOOTER â”€â”€ */
.footer {
  max-width: 640px; margin: 28px auto 0;
  padding: 0 18px 10px;
}
.footer-div { height: 1px; background: linear-gradient(90deg,transparent,var(--border),transparent); margin-bottom: 18px; }
.footer-inner { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
.footer-brand { font-size: .95em; font-weight: 900; background: linear-gradient(120deg,#a78bfa,#60a5fa,#34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.footer-sub { font-size: .62em; color: var(--faint); }
.footer-devs { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: center; }
.dev-chip { font-size: .72em; font-weight: 700; padding: 3px 11px; border-radius: 20px; background: rgba(139,92,246,.1); border: 1px solid rgba(139,92,246,.25); color: #a78bfa; }
.footer-amp { font-size: .7em; color: var(--faint); }
.footer-copy { font-size: .62em; color: var(--faint); }

/* â”€â”€ NIGHT â”€â”€ */
.night-banner {
  display: none; border-radius: var(--r-lg);
  padding: 20px; text-align: center; margin: 14px 0;
  background: linear-gradient(135deg,rgba(15,10,40,.95),rgba(30,10,60,.95));
  border: 1px solid rgba(139,92,246,.35);
  box-shadow: 0 6px 28px rgba(99,0,255,.15);
}
.night-banner.show { display: block; }
.night-emoji { font-size: 1.8em; margin-bottom: 6px; }
.night-txt { font-size: 1.1em; font-weight: 800; background: linear-gradient(135deg,#a78bfa,#818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.night-sub { font-size: .74em; color: #6b5fa0; margin-top: 4px; }

/* â”€â”€ LAST UPDATED â”€â”€ */
.lu-bar { display: flex; align-items: center; justify-content: flex-end; gap: 5px; font-size: .62em; color: var(--faint); margin-bottom: 6px; }
.lu-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: cspulse 2s infinite; }

/* Mobile */
@media(max-width:380px) {
  .wknd-card { flex-direction: column; align-items: flex-start; }
  .wt-num { font-size: 1em; }
}

/* â”€â”€ SUGGESTIONS â”€â”€ */
.sug-card {
  background: var(--bg-card);
  border: 1px solid var(--border-soft);
  border-radius: var(--r-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  margin-bottom: 4px;
}
.sug-stripe { height: 3px; background: linear-gradient(90deg,#10b981,#3b82f6,#8b5cf6); }
.sug-inner { padding: 16px 18px 18px; }
.sug-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.sug-icon { font-size: 1.6em; }
.sug-title { font-size: .95em; font-weight: 800; color: var(--text); }
.sug-sub { font-size: .7em; color: var(--muted); margin-top: 2px; }
.sug-input {
  width: 100%; background: var(--bg-panel);
  border: 1px solid var(--border); border-radius: var(--r-sm);
  padding: 11px 13px; color: var(--text);
  font-size: .85em; font-family: inherit;
  outline: none; resize: none; box-sizing: border-box;
  transition: border-color .2s;
  line-height: 1.5;
}
.sug-input:focus { border-color: var(--violet); }
.sug-input::placeholder { color: var(--faint); }
.sug-btn {
  background: linear-gradient(135deg,#10b981,#3b82f6);
  border: none; border-radius: 20px;
  padding: 8px 16px; color: #fff;
  font-size: .78em; font-weight: 700;
  font-family: inherit; cursor: pointer;
  transition: opacity .2s;
}
.sug-btn:hover { opacity: .85; }

/* â”€â”€ LF CSS REMOVED â”€â”€ */
</style>
</head>
<body>
<div id="toast"></div>
<div id="admin-bar" onclick="adminLogout()">ğŸ” Admin Â· tap to exit</div>

<!-- TOPBAR -->
<div class="topbar">
  <span class="brand">FundBASEU</span>
  <div class="topbar-right">
    <button class="pill-btn" id="theme-btn">ğŸŒ™ Dark</button>
  </div>
</div>

<!-- HERO -->
<div class="hero">
  <div class="hero-sub">Real-time campus status Â· by students, for students</div>
  <a href="https://sway.cloud.microsoft/CuEoSACHmG0wvSfR?ref=Link&loc=play" target="_blank" style="display:inline-flex;align-items:center;gap:4px;background:rgba(139,92,246,.1);padding:5px 14px;border-radius:12px;color:#a78bfa;text-decoration:none;font-size:.72em;font-weight:700;border:1px solid rgba(139,92,246,.2);">ğŸ“¢ FundBASEU Updates â†’</a>
</div>

<!-- STATS -->
<div class="stats-row">
  <div class="stat-chip"><span class="stat-n" id="liveCount">0</span><span class="stat-l">ğŸ‘¥ Live Now</span></div>
  <div class="stat-chip"><span class="stat-n" id="totalVis">0</span><span class="stat-l">ğŸ“Š Visitors</span></div>
</div>

<!-- SEMESTER COUNTDOWN -->
<div id="wknd-banner"></div>

<!-- MAIN WRAP -->
<div class="wrap">

  <!-- NIGHT BANNER -->
  <div class="night-banner" id="night-banner">
    <div class="night-emoji">ğŸŒ™âœ¨</div>
    <div class="night-txt">BASEU Never Sleeps</div>
    <div class="night-sub">It's late â€” but you're not alone</div>
  </div>

  <!-- CAMPUS UNO -->
  <div style="margin: 16px 0;">
    <a href="https://campus.uno/" target="_blank" rel="noopener" class="cu-tile">
      <div class="cu-tile-left">
        <span class="cu-tile-icon">ğŸ“</span>
        <div><div class="cu-tile-name">Campus Uno</div><div class="cu-tile-sub">Your all-in-one campus platform</div></div>
      </div>
      <span class="cu-tile-arrow">â†’</span>
    </a>
  </div>

  <!-- ANNOUNCEMENTS -->
  <div class="ann-card">
    <div class="ann-inner">
      <div class="ann-header">
        <div class="ann-title-row">ğŸ“¢ Announcements <span class="ann-exp-badge">12hr expiry</span></div>
        <button class="ann-post-btn" onclick="openAnnModal()">+ Post</button>
      </div>
      <div id="ann-list"><div class="ann-empty">No announcements yet</div></div>
    </div>
  </div>

  <!-- NEXT MEAL -->
  <div class="sec-head"><div class="sec-title">Next Meal</div></div>
  <div class="meal-block" id="meal-block">
    <div class="meal-stripe"></div>
    <div class="meal-inner">
      <div class="meal-top">
        <div>
          <div class="meal-name-row">
            <span class="meal-emoji" id="meal-emoji">ğŸ´</span>
            <span class="meal-name" id="meal-name">â€”</span>
          </div>
          <div class="meal-day" id="meal-day"></div>
        </div>
        <!-- Avg rating always visible top-right -->
        <div class="meal-avg" id="meal-avg-display">
          <span class="meal-avg-num" id="avg-num">â€”</span>
          <span class="meal-avg-stars" id="avg-stars"></span>
          <span class="meal-avg-count" id="avg-count"></span>
        </div>
      </div>

      <!-- Menu chips â€” ALWAYS shown -->
      <div class="meal-chips" id="meal-chips"></div>

      <!-- MEAL RATING â€” inline below menu -->
      <div class="meal-rating-section">
        <div class="meal-rating-header">
          <span class="mrl">Rate this meal</span>
        </div>
        <div id="star-row" class="star-row">
          <button class="star-btn" onclick="setRating(1)" data-v="1">â­</button>
          <button class="star-btn" onclick="setRating(2)" data-v="2">â­</button>
          <button class="star-btn" onclick="setRating(3)" data-v="3">â­</button>
          <button class="star-btn" onclick="setRating(4)" data-v="4">â­</button>
          <button class="star-btn" onclick="setRating(5)" data-v="5">â­</button>
        </div>
        <div id="meal-rated-msg" style="display:none;" class="meal-rated-msg">âœ… Rated! Thanks.</div>
        <div class="bar-chart" id="rating-bars"></div>
      </div>
    </div>
  </div>

  <!-- CAMPUS STATUS -->
  <div class="sec-head">
    <div class="sec-title">Campus Status</div>
    <div class="lu-bar"><div class="lu-dot"></div><span>Updated <span id="last-upd">â€”</span></span></div>
  </div>

  <div class="status-grid">
    <div class="s-card" id="mess-card" onclick="openStatusModal('mess')">
      <span class="s-card-icon">ğŸ½ï¸</span>
      <span class="s-card-name">Mess</span>
      <span class="s-card-badge bdg-gray" id="mess-avail">Not Updated</span>
      <div class="s-card-cv" id="mess-cv"></div>
      <div class="s-card-ts" id="mess-ts"></div>
    </div>
    <div class="s-card" id="nandini-card" onclick="openStatusModal('nandini')">
      <span class="s-card-icon">ğŸ¥›</span>
      <span class="s-card-name">Nandini</span>
      <span class="s-card-badge bdg-gray" id="nandini-avail">Not Updated</span>
      <div class="s-card-cv" id="nandini-cv"></div>
      <div class="s-card-ts" id="nandini-ts"></div>
    </div>
    <div class="s-card" id="nescafe-card" onclick="openStatusModal('nescafe')">
      <span class="s-card-icon">â˜•</span>
      <span class="s-card-name">NescafÃ©</span>
      <span class="s-card-badge bdg-gray" id="nescafe-avail">Not Updated</span>
      <div class="s-card-cv" id="nescafe-cv"></div>
      <div class="s-card-ts" id="nescafe-ts"></div>
    </div>
    <div class="s-card" id="gym-card" onclick="openStatusModal('gym')">
      <span class="s-card-icon">ğŸ‹ï¸</span>
      <span class="s-card-name">Gym</span>
      <span class="s-card-badge bdg-gray" id="gym-avail">Not Updated</span>
      <div class="s-card-cv" id="gym-cv"></div>
      <div class="s-card-ts" id="gym-ts"></div>
    </div>
    <div class="s-card" id="bad-card" onclick="openStatusModal('bad')">
      <span class="s-card-icon">ğŸ¸</span>
      <span class="s-card-name">Badminton</span>
      <span class="s-card-badge bdg-gray" id="bad-avail">Not Updated</span>
      <div class="s-card-cv" id="bad-cv"></div>
      <div class="s-card-ts" id="bad-ts"></div>
    </div>
    <div class="s-card" id="doc-card" onclick="openStatusModal('doc')">
      <span class="s-card-icon">ğŸ¥</span>
      <span class="s-card-name">Doctor</span>
      <span class="s-card-badge bdg-gray" id="doc-avail">Not Updated</span>
      <div class="s-card-cv" id="doc-cv"></div>
      <div class="s-card-ts" id="doc-ts"></div>
    </div>
  </div>

  <!-- CLASS SIGNAL SYSTEM -->
  <div class="sec-head">
    <div class="sec-title">ğŸ« Class Signal Â· Live</div>
    <span style="font-size:.62em;color:var(--faint);">45min auto-reset</span>
  </div>
  <div style="font-size:.74em;color:var(--muted);margin-bottom:12px;line-height:1.5;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);">
    ğŸ’¡ Tap your lecture hall to update status. 2 confirmations make it live.
  </div>
  <div class="class-signal-grid" id="class-grid"></div>

  <!-- SEMESTER TICKER -->
  <div id="sem-ticker"></div>

  <!-- SUGGESTIONS -->
  <div class="sec-head">
    <div class="sec-title">ğŸ’¡ Suggestions</div>
  </div>
  <div class="sug-card">
    <div class="sug-stripe"></div>
    <div class="sug-inner">
      <div class="sug-header">
        <span class="sug-icon">ğŸ’¡</span>
        <div>
          <div class="sug-title">Got a suggestion?</div>
          <div class="sug-sub">Anonymous Â· goes straight to the team</div>
        </div>
      </div>
      <textarea class="sug-input" id="sug-text" maxlength="280" rows="3" placeholder="Share feedback, ideas, complaints... anything. We read every one."></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <span style="font-size:.62em;color:var(--faint);" id="sug-ct">0/280</span>
        <button class="sug-btn" onclick="submitSuggestion()">Send anonymously â†’</button>
      </div>
      <div id="sug-thanks" style="display:none;text-align:center;font-size:.82em;font-weight:700;color:var(--green);padding:10px 0 2px;">âœ… Sent! Thank you ğŸ™</div>
    </div>
  </div>
  <footer class="footer">
    <div class="footer-div"></div>
    <div class="footer-inner">
      <div class="footer-brand">FundBASEU</div>
      <div class="footer-sub">Campus Intelligence Platform</div>
      <div class="footer-devs">
        <span style="font-size:.7em;color:var(--muted);">Built by</span>
        <span class="dev-chip">Vardhan</span>
        <span class="footer-amp">&amp;</span>
        <span class="dev-chip">Athul</span>
      </div>
      <div class="footer-copy">Â© 2026 FundBASEU Â· All Rights Reserved</div>
    </div>
  </footer>

</div>

<button class="ref-btn" onclick="location.reload()">ğŸ”„ Refresh</button>

<!-- MODAL -->
<div class="modal" id="modal" onclick="bgClose(event)">
  <div class="mbox" id="mbox"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var ILOCK = "fundbaseu2024";
var T_MESS=2, T_GYM=2, T_NESCAFE=2, T_NANDINI=2, T_BAD=2, T_DOC=2;
var CS_THRESH = 2, CS_TTL = 2700000; // 45 min
var ANN_EXP = 43200000; // 12hr

// Lecture halls
var ROOMS = ["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","LH9"];

// Faculty / prof list for class signal
var FACULTY = [
  "â€” Not sure / Any",
  "Dr. Bidur","Dr. Megha","Dr. Irfan","Dr. Shameer",
  "Dr. Nageshwar","Dr. Ishfaq","Dr. Muzaffar","Dr. Kasturi",
  "Dr. Moushmi","Dr. Sushmita","Dr. Asha","Dr. Mahesh","Dean",
  "âœï¸ Visiting Faculty (type name)"
];

// â”€â”€ FIREBASE â”€â”€
firebase.initializeApp({
  apiKey:"AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
  authDomain:"fundbaseu-tracker.firebaseapp.com",
  databaseURL:"https://fundbaseu-tracker-default-rtdb.firebaseio.com",
  projectId:"fundbaseu-tracker"
});
var db = firebase.database();

var pr = db.ref("presence").push();
pr.set(true); pr.onDisconnect().remove();
db.ref("presence").on("value",function(s){ setText("liveCount",s.numChildren()); });
db.ref("totalVisitors").transaction(function(c){ return (c||0)+1; });
db.ref("totalVisitors").on("value",function(s){ setText("totalVis",s.val()||0); });

var devId = localStorage.getItem("did") || (function(){
  var id="d_"+Math.random().toString(36).slice(2,11);
  localStorage.setItem("did",id); return id;
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ge(id){ return document.getElementById(id); }
function setText(id,v){ var e=ge(id); if(e) e.textContent=v; }
function ago(t){ if(!t) return ""; var m=Math.floor((Date.now()-t)/60000); if(m<1) return "just now"; if(m===1) return "1m ago"; if(m<60) return m+"m ago"; var h=Math.floor(m/60); if(h<24) return h+"hr ago"; return Math.floor(h/24)+"d ago"; }
function esc(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function toast(msg){ var t=ge("toast"); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._x); t._x=setTimeout(function(){ t.style.opacity="0"; },2800); }

// Admin
var isAdmin = sessionStorage.getItem("adm")==="1";
if(isAdmin) ge("admin-bar").classList.add("show");
function checkAdmin(){
  if(isAdmin) return true;
  var pw=prompt("ğŸ” Admin password:");
  if(pw===ILOCK){ isAdmin=true; sessionStorage.setItem("adm","1"); ge("admin-bar").classList.add("show"); toast("Admin access granted"); return true; }
  toast("âŒ Wrong password"); return false;
}
function adminLogout(){ if(!confirm("Exit admin?")) return; isAdmin=false; sessionStorage.removeItem("adm"); ge("admin-bar").classList.remove("show"); toast("Logged out"); }

// Modal
function closeModal(){ ge("modal").classList.remove("open"); }
function bgClose(e){ if(e.target===ge("modal")) closeModal(); }
function openModal(html){ ge("mbox").innerHTML=html; ge("modal").classList.add("open"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEMESTER COUNTDOWN
//  Even sem: Jan 1 â†’ May 15   (approx)
//  Odd  sem: Aug 1 â†’ Dec 20   (approx)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSemesterInfo(now){
  var y = now.getFullYear();
  var m = now.getMonth(); // 0-indexed

  // Define semester windows (month is 0-indexed)
  var even = { start: new Date(y, 0, 6),  end: new Date(y, 4, 15) }; // Jan 6 â€“ May 15
  var odd  = { start: new Date(y, 7, 1),  end: new Date(y, 11, 20) }; // Aug 1 â€“ Dec 20

  // Are we inside even sem?
  if(now >= even.start && now <= even.end){
    return { name:"Even Semester", sem:"even", phase:"active", end: even.end };
  }
  // Are we inside odd sem?
  if(now >= odd.start && now <= odd.end){
    return { name:"Odd Semester", sem:"odd", phase:"active", end: odd.end };
  }
  // Between May 15 and Aug 1 â€” summer break, count to odd sem start
  if(now > even.end && now < odd.start){
    return { name:"Odd Semester", sem:"odd", phase:"upcoming", start: odd.start };
  }
  // Between Dec 20 and Jan 6 next year â€” winter break, count to even sem start
  var nextEven = { start: new Date(y+1, 0, 6) };
  return { name:"Even Semester", sem:"even", phase:"upcoming", start: nextEven.start };
}

function renderCountdown(){
  var now = new Date();
  var el  = ge("wknd-banner");
  var sem = getSemesterInfo(now);

  var semColor = sem.sem==="even"
    ? "linear-gradient(135deg,#0c1a40,#1a2a5e,#0a2a40)"   // blue â€” even
    : "linear-gradient(135deg,#1a0c2e,#2d1450,#0e1a30)";  // violet â€” odd

  var borderColor = sem.sem==="even"
    ? "rgba(59,130,246,.45)"
    : "rgba(139,92,246,.45)";

  var glowColor = sem.sem==="even"
    ? "rgba(59,130,246,.18)"
    : "rgba(139,92,246,.18)";

  var accentColor = sem.sem==="even" ? "#60a5fa" : "#a78bfa";

  if(sem.phase === "active"){
    // Counting DOWN to semester end
    var diff = sem.end - now;
    if(diff <= 0){
      // Semester just ended â€” re-evaluate next tick
      setTimeout(renderCountdown, 3000); return;
    }
    var totalDays  = Math.round((sem.end - new Date(sem.end.getFullYear(), sem.sem==="even"?0:7, sem.sem==="even"?6:1)) / 86400000);
    var daysLeft   = Math.floor(diff / 86400000);
    var hoursLeft  = Math.floor((diff % 86400000) / 3600000);
    var minsLeft   = Math.floor((diff % 3600000)  / 60000);
    var pct        = Math.max(0, Math.round(((totalDays - daysLeft) / totalDays) * 100));

    // Motivational message based on how far in
    var msgs;
    if(daysLeft > 60)      msgs = ["Long road ahead ğŸ“š","Semester just started ğŸŒ±","Pace yourself â˜•"];
    else if(daysLeft > 30) msgs = ["Midpoint grind ğŸ’ª","Halfway there ğŸƒ","Keep going ğŸ”¥"];
    else if(daysLeft > 14) msgs = ["Almost there âš¡","Final stretch ğŸ","Push through ğŸ’¥"];
    else                   msgs = ["Last few days! ğŸ‰","Finish strong ğŸ”¥","Nearly done!! ğŸŠ"];
    var msg = msgs[Math.floor(Date.now()/3600000) % msgs.length];

    el.innerHTML =
      '<div class="wknd-card" style="background:'+semColor+';border-color:'+borderColor+';box-shadow:0 0 40px '+glowColor+';">' +
        '<div class="wknd-left">' +
          '<div class="wknd-label" style="color:'+accentColor+';">ğŸ“… '+sem.name+' ends in</div>' +
          '<div class="wknd-msg">'+msg+'</div>' +
          '<div class="wknd-sub">Ends '+sem.end.toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"})+'</div>' +
          '<div style="margin-top:8px;background:rgba(255,255,255,.07);border-radius:6px;overflow:hidden;height:5px;width:100%;">'+
            '<div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,'+accentColor+',#34d399);border-radius:6px;transition:width 1s ease;"></div>'+
          '</div>'+
          '<div style="font-size:.6em;color:rgba(255,255,255,.3);margin-top:3px;">'+pct+'% complete Â· '+daysLeft+' day'+(daysLeft!==1?"s":"")+' left</div>'+
        '</div>' +
        '<div class="wknd-timer">' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(daysLeft).padStart(2,"0")+'</span><span class="wt-lbl">Days</span></div>' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(hoursLeft).padStart(2,"0")+'</span><span class="wt-lbl">Hrs</span></div>' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(minsLeft).padStart(2,"0")+'</span><span class="wt-lbl">Min</span></div>' +
        '</div>' +
      '</div>';

  } else {
    // BREAK â€” counting UP to next semester
    var diff2   = sem.start - now;
    var days2   = Math.floor(diff2 / 86400000);
    var hours2  = Math.floor((diff2 % 86400000) / 3600000);
    var mins2   = Math.floor((diff2 % 3600000)  / 60000);
    var breakMsg = days2 > 30 ? "Enjoy the break! â˜€ï¸" : days2 > 7 ? "Break winding down ğŸŒ…" : "Sem starts soon ğŸ˜¬";

    el.innerHTML =
      '<div class="wknd-card" style="background:'+semColor+';border-color:'+borderColor+';box-shadow:0 0 40px '+glowColor+';">' +
        '<div class="wknd-left">' +
          '<div class="wknd-label" style="color:'+accentColor+';">ğŸ‰ '+sem.name+' starts in</div>' +
          '<div class="wknd-msg">'+breakMsg+'</div>' +
          '<div class="wknd-sub">Starts '+sem.start.toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"})+'</div>' +
        '</div>' +
        '<div class="wknd-timer">' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(days2).padStart(2,"0")+'</span><span class="wt-lbl">Days</span></div>' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(hours2).padStart(2,"0")+'</span><span class="wt-lbl">Hrs</span></div>' +
          '<div class="wt-blk"><span class="wt-num" style="color:'+accentColor+';">'+String(mins2).padStart(2,"0")+'</span><span class="wt-lbl">Min</span></div>' +
        '</div>' +
      '</div>';
  }
}
renderCountdown(); setInterval(renderCountdown, 30000);

// â”€â”€ SEMESTER END TICKER (simple inline strip) â”€â”€
function renderSemTicker(){
  var el = ge("sem-ticker"); if(!el) return;
  var now = new Date();
  var sem = getSemesterInfo(now);
  var txt, color, bg;
  if(sem.phase === "active"){
    var diff = sem.end - now;
    var days = Math.floor(diff / 86400000);
    var label = days <= 0 ? "Semester ends today! ğŸ‰"
              : days === 1 ? "Semester ends tomorrow ğŸ"
              : "This semester ends in ~" + days + " day" + (days!==1?"s":"");
    txt   = "ğŸ“… " + label + " Â· " + sem.name;
    color = sem.sem==="even" ? "#60a5fa" : "#a78bfa";
    bg    = sem.sem==="even" ? "rgba(59,130,246,.08)" : "rgba(139,92,246,.08)";
  } else {
    var diff2 = sem.start - now;
    var days2 = Math.floor(diff2 / 86400000);
    txt   = "ğŸ‰ On break Â· " + sem.name + " starts in ~" + days2 + " day" + (days2!==1?"s":"");
    color = sem.sem==="even" ? "#60a5fa" : "#a78bfa";
    bg    = sem.sem==="even" ? "rgba(59,130,246,.08)" : "rgba(139,92,246,.08)";
  }
  el.innerHTML = '<div style="text-align:center;font-size:.74em;font-weight:700;color:'+color+';background:'+bg+';border:1px solid '+color.replace("f","4")+'4;border-radius:20px;padding:6px 14px;margin:10px 0 4px;">'+txt+'</div>';
}
renderSemTicker(); setInterval(renderSemTicker, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESS MENU DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var bf13={Monday:"Vada+Sambar+Chutney+Shavige",Tuesday:"Poha+Fruits+Chowchow Bath+Chutney",Wednesday:"Plain Dosa+Aloo+Chutney+Egg",Thursday:"Bisi Belle Bath+Bread Jam+Fruits",Friday:"Green Moong Dosa+Oats+Chutney",Saturday:"Tomato Bath+Puliyogare+Chutney",Sunday:"Masala Dosa+Aloo+Chutney"};
var bf24={Monday:"Millets Khichdi+Vada+Sambar+Idly",Tuesday:"Lemon Rice+Bread Jam+Fruits",Wednesday:"Ragi Dosa+Dalia+Tomato Chutney+Egg",Thursday:"Onion Uthappam+Mangalore Bajji+Chutney",Friday:"Dal Khichdi+Dosa+Chutney",Saturday:"Pongal+Bread Jam+Fruits",Sunday:"Set Dosa+Chutney"};
var dm={Monday:{L:"Poori/Ragi Ball+Rice+Drumstick+Channa+Curd",S:"Cutlet+Tea",D:"Dal Makhni+Rice+Dal+Veg"},Tuesday:{L:"Methi Chapathi+Rice+Dal+Veg Pulav+Curd",S:"Kabuli Husli+Tea",D:"Soyabean+Radish Sambhar+Chapati"},Wednesday:{L:"Chapathi/Ragi+Rice+Paneer+Sprouts Sambhar",S:"Samosa+Tea",D:"Chapathi+Rice+Aloo+Rasam"},Thursday:{L:"Paratha+Rajma+Jeera Rice+Pudina Rice+Curd",S:"Vada Pav+Tea",D:"Chapathi+Egg Curry+Dal Palak+Salad"},Friday:{L:"Palak Chapati+Bhindi+Chicken Biryani+Curd",S:"Bhel Puri+Tea",D:"Chapathi+Rice+Dal+Veg"},Saturday:{L:"Chapathi+Rice+Dal+Mix Veg Beans+Curd",S:"Masala Vada+Tea",D:"Chapathi+Dal+Veg+Salad"},Sunday:{L:"Mushroom/Paneer Biryani+Salad",S:"Pav Bhaji+Tea",D:"Chapathi+Beetroot Palya+Veg"}};
var DAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function wkPat(d){ var fd=new Date(d.getFullYear(),d.getMonth(),1),wk=Math.ceil((d.getDate()+fd.getDay())/7); return(wk===1||wk===3)?"w13":"w24"; }
function nxMeal(){ var n=new Date(),h=n.getHours(),day=DAYS[n.getDay()]; if(h>=22){var t=new Date(n);t.setDate(t.getDate()+1);return{date:t,day:DAYS[t.getDay()],meal:"Breakfast"};} if(h>=18)return{date:n,day:day,meal:"Dinner"}; if(h>=15)return{date:n,day:day,meal:"Snacks"}; if(h>=10)return{date:n,day:day,meal:"Lunch"}; return{date:n,day:day,meal:"Breakfast"}; }
function getMnu(date,day,meal){ if(meal==="Breakfast") return (wkPat(date)==="w13"?bf13:bf24)[day]||""; var k={Lunch:"L",Snacks:"S",Dinner:"D"}[meal]; return dm[day]?dm[day][k]||"":""; }

function updMealBanner(){
  var n=nxMeal();
  var emojiMap={Breakfast:"ğŸ³",Lunch:"ğŸ½ï¸",Snacks:"â˜•",Dinner:"ğŸŒ™"};
  setText("meal-emoji", emojiMap[n.meal]||"ğŸ´");
  setText("meal-name", n.meal);
  setText("meal-day", n.day);
  // Always render menu chips
  var menu = getMnu(n.date,n.day,n.meal)||"";
  var chipsEl = ge("meal-chips");
  if(chipsEl){
    var items = menu ? menu.split("+").map(function(s){ return s.trim(); }).filter(Boolean) : ["Menu not available"];
    chipsEl.innerHTML = items.map(function(i){ return '<span class="m-chip">'+esc(i)+'</span>'; }).join('');
  }
  // Only re-setup rating if the meal period changed
  var newKey = getMealKey(n);
  if(newKey !== currentMealKey){
    // Detach old listener
    if(currentMealKey) db.ref("mealRatings/"+currentMealKey+"/votes").off();
    setupMealRating(n);
  }
}
updMealBanner(); setInterval(updMealBanner, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEAL RATING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentMealKey = "";
var selectedRating = 0;

function getMealKey(mealInfo){
  var d = mealInfo.date;
  return "rating_" + d.getFullYear() + "_" + (d.getMonth()+1) + "_" + d.getDate() + "_" + mealInfo.meal;
}

function setRating(v){
  selectedRating = v;
  document.querySelectorAll(".star-btn").forEach(function(b, i){
    b.classList.toggle("active", i < v);
  });
  clearTimeout(window._ratingTimer);
  window._ratingTimer = setTimeout(function(){ submitRating(); }, 600);
}

function submitRating(){
  if(!selectedRating || !currentMealKey) return;
  var devKey = "mr_" + currentMealKey;
  if(localStorage.getItem(devKey)){ toast("Already rated this meal!"); return; }
  db.ref("mealRatings/" + currentMealKey + "/votes").push({v: selectedRating, ts: Date.now()});
  localStorage.setItem(devKey, selectedRating);
  ge("star-row").style.opacity = "0.4";
  ge("star-row").style.pointerEvents = "none";
  ge("meal-rated-msg").style.display = "block";
  toast("â­ Meal rated!");
}

function setupMealRating(mealInfo){
  currentMealKey = getMealKey(mealInfo);
  var devKey = "mr_" + currentMealKey;
  var alreadyRated = !!localStorage.getItem(devKey);
  selectedRating = 0;
  // Reset stars display
  var starRow = ge("star-row");
  var ratedMsg = ge("meal-rated-msg");
  if(starRow){
    starRow.style.opacity = alreadyRated ? "0.4" : "1";
    starRow.style.pointerEvents = alreadyRated ? "none" : "auto";
    document.querySelectorAll(".star-btn").forEach(function(b){ b.classList.remove("active"); });
  }
  if(ratedMsg) ratedMsg.style.display = alreadyRated ? "block" : "none";
  // Always show avg display (show dash if no votes)
  var avgEl = ge("meal-avg-display");
  if(avgEl) avgEl.style.display = "flex";
  setText("avg-num", "â€”"); setText("avg-stars", ""); setText("avg-count", "");
  // Live rating listener
  db.ref("mealRatings/" + currentMealKey + "/votes").on("value", function(snap){
    var counts=[0,0,0,0,0], total=0, sum=0;
    snap.forEach(function(c){
      var d=c.val(); if(d&&d.v>=1&&d.v<=5){ counts[d.v-1]++; sum+=d.v; total++; }
    });
    var avg = total>0 ? (sum/total).toFixed(1) : null;
    if(avg){
      setText("avg-num", avg);
      var stars="", n=Math.round(parseFloat(avg));
      for(var i=0;i<5;i++) stars+=(i<n)?"â­":"â˜†";
      setText("avg-stars", stars);
      setText("avg-count", total+" vote"+(total!==1?"s":""));
    } else {
      setText("avg-num","â€”"); setText("avg-stars",""); setText("avg-count","");
    }
    // Render bars
    var barsEl=ge("rating-bars");
    if(barsEl&&total>0){
      var max=Math.max.apply(null,counts);
      barsEl.innerHTML=[5,4,3,2,1].map(function(star){
        var ct=counts[star-1], pct=max>0?Math.round((ct/max)*100):0;
        return '<div class="bar-row"><span class="bar-lbl">'+star+'</span><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%"></div></div><span class="bar-ct">'+ct+'</span></div>';
      }).join('');
    } else if(barsEl){ barsEl.innerHTML=""; }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTING ENGINE (simplified & stable)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var confirmed = {};

function doVote(place, value, thresh){
  var dvRef = db.ref(place+"_dv/"+devId);
  dvRef.once("value", function(snap){
    if(snap.exists()) return toast("Already voted for " + place);
    dvRef.set({v:value, ts:Date.now()});
    db.ref(place+"_voteCount").transaction(function(c){ return (c||0)+1; }, function(err,ok,sn){
      if(err||!ok||!sn){ dvRef.remove(); return toast("Error, try again"); }
      var count = sn.val(), rem = thresh - count;
      if(count >= thresh){
        db.ref(place).set({status:value, ts:Date.now()}, function(){
          db.ref(place+"_voteCount").remove();
          db.ref(place+"_dv").remove();
        });
        toast("âœ… Community confirmed!");
      } else {
        toast("Vote recorded! " + rem + " more needed.");
      }
    });
  });
  closeModal();
}

function adminSet(place, value){
  if(!checkAdmin()) return;
  db.ref(place).set({status:value, ts:Date.now()});
  db.ref(place+"_voteCount").remove();
  db.ref(place+"_dv").remove();
  toast("âœ… Override applied!"); closeModal();
}

function resetPlace(place){
  if(!checkAdmin()) return;
  db.ref(place).remove();
  db.ref(place+"_voteCount").remove();
  db.ref(place+"_dv").remove();
  toast("ğŸ”„ Reset"); closeModal();
}

function listenPlace(place, thresh, onStatus){
  db.ref(place).on("value", function(snap){
    var d = snap.val();
    if(!d||!d.status){ onStatus(null); return; }
    onStatus(d);
  });
  db.ref(place+"_voteCount").on("value", function(snap){
    var c = snap.val()||0;
    var el = ge(place+"-cv"); if(el) el.textContent = c>0 ? "ğŸ—³ "+c+"/"+thresh+" votes" : "";
  });
}

// Paint cards
var CC = {
  green:  {dark:"linear-gradient(135deg,#052e16,#064e3b)", dark_b:"#10b981", light_b:"#10b981", light_bg:"rgba(16,185,129,.08)"},
  red:    {dark:"linear-gradient(135deg,#450a0a,#7f1d1d)", dark_b:"#ef4444", light_b:"#ef4444", light_bg:"rgba(239,68,68,.07)"},
  amber:  {dark:"linear-gradient(135deg,#451a03,#78350f)", dark_b:"#f59e0b", light_b:"#f59e0b", light_bg:"rgba(245,158,11,.08)"},
  dark:   null
};
function paintCard(id, ck){
  var c=ge(id); if(!c) return;
  var isLight=document.body.classList.contains("light");
  if(!ck||ck==="dark"){ c.style.background=""; c.style.borderColor=""; c.style.boxShadow=""; return; }
  var p=CC[ck]; if(!p) return;
  if(isLight){ c.style.background=p.light_bg; c.style.borderColor=p.light_b; c.style.boxShadow="0 2px 12px rgba(0,0,0,.08)"; }
  else { c.style.background=p.dark; c.style.borderColor=p.dark_b; c.style.boxShadow="0 4px 20px rgba(0,0,0,.4)"; }
}
function getColorFromBadgeText(txt){
  var t=(txt||"").toLowerCase();
  if(!t||t==="not updated") return "dark";
  if(t.includes("closed")||t.includes("not available")||t.includes("cancelled")) return "red";
  if(t.includes("crowded")||t.includes("awaiting")||t.includes("waiting")) return "amber";
  if(t.includes("open")||t.includes("available")||t.includes("ongoing")||t.includes("on campus")) return "green";
  return "dark";
}

function renderStatusCard(place, text, timestamp, thresh){
  var s=ge(place+"-avail"), tEl=ge(place+"-ts");
  if(s){ s.textContent=text; s.className="s-card-badge"; }
  var ck=getColorFromBadgeText(text);
  if(ck==="green"&&s) s.classList.add("bdg-green");
  else if(ck==="red"&&s) s.classList.add("bdg-red");
  else if(ck==="amber"&&s) s.classList.add("bdg-amber");
  else if(s) s.classList.add("bdg-gray");
  if(tEl) tEl.textContent=timestamp?ago(timestamp):"";
  paintCard(place+"-card", ck);
}

// MESS
listenPlace("mess",T_MESS,function(d){
  if(!d){ renderStatusCard("mess","Not Updated",null,T_MESS); return; }
  var st=(d.status||"").trim().toLowerCase();
  if(st==="food available") renderStatusCard("mess","âœ… Food Available",d.ts,T_MESS);
  else if(st==="not available"||st==="food not available") renderStatusCard("mess","âŒ Not Available",d.ts,T_MESS);
  else renderStatusCard("mess",d.status,d.ts,T_MESS);
});
// NANDINI
listenPlace("nandini",T_NANDINI,function(d){
  if(!d){ renderStatusCard("nandini","Not Updated",null,T_NANDINI); return; }
  var st=(d.status||"").trim().toLowerCase();
  if(st==="open") renderStatusCard("nandini","âœ… Open",d.ts,T_NANDINI);
  else if(st==="closed") renderStatusCard("nandini","ğŸ”’ Closed",d.ts,T_NANDINI);
  else renderStatusCard("nandini",d.status,d.ts,T_NANDINI);
});
// NESCAFE
listenPlace("nescafe",T_NESCAFE,function(d){
  if(!d){ renderStatusCard("nescafe","Not Updated",null,T_NESCAFE); return; }
  var st=(d.status||"").trim().toLowerCase();
  if(st==="open") renderStatusCard("nescafe","âœ… Open",d.ts,T_NESCAFE);
  else if(st==="closed") renderStatusCard("nescafe","ğŸ”’ Closed",d.ts,T_NESCAFE);
  else renderStatusCard("nescafe",d.status,d.ts,T_NESCAFE);
});
// GYM
listenPlace("gym",T_GYM,function(d){
  if(!d){ renderStatusCard("gym","Not Updated",null,T_GYM); return; }
  var st=(d.status||"").trim().toLowerCase();
  if(st==="open") renderStatusCard("gym","âœ… Open",d.ts,T_GYM);
  else if(st.includes("crowded")) renderStatusCard("gym","âš ï¸ Crowded",d.ts,T_GYM);
  else if(st==="closed") renderStatusCard("gym","ğŸ”’ Closed",d.ts,T_GYM);
  else renderStatusCard("gym",d.status,d.ts,T_GYM);
});
// BADMINTON
listenPlace("bad",T_BAD,function(d){
  if(!d){ renderStatusCard("bad","Not Updated",null,T_BAD); return; }
  var st=(d.status||"").trim().toLowerCase();
  if(st==="open") renderStatusCard("bad","âœ… Open",d.ts,T_BAD);
  else if(st.includes("crowded")) renderStatusCard("bad","âš ï¸ Crowded",d.ts,T_BAD);
  else if(st==="closed") renderStatusCard("bad","ğŸ”’ Closed",d.ts,T_BAD);
  else renderStatusCard("bad",d.status,d.ts,T_BAD);
});
// DOCTOR
listenPlace("doc",T_DOC,function(d){
  if(!d){ renderStatusCard("doc","Not Updated",null,T_DOC); return; }
  if(d.status==="On Campus") renderStatusCard("doc","âœ… On Campus",d.ts,T_DOC);
  else renderStatusCard("doc","âŒ Not Available",d.ts,T_DOC);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openStatusModal(place){
  var cfg = {
    mess:    {icon:"ğŸ½ï¸",name:"Mess",    opts:[{v:"Food Available",l:"âœ… Food Available",c:"m-btn-green"},{v:"Not Available",l:"âŒ Not Available",c:"m-btn-red"}],thresh:T_MESS},
    nandini: {icon:"ğŸ¥›",name:"Nandini", opts:[{v:"Open",l:"âœ… Open",c:"m-btn-green"},{v:"Closed",l:"ğŸ”’ Closed",c:"m-btn-red"}],thresh:T_NANDINI},
    nescafe: {icon:"â˜•",name:"NescafÃ©",  opts:[{v:"Open",l:"âœ… Open",c:"m-btn-green"},{v:"Closed",l:"ğŸ”’ Closed",c:"m-btn-red"}],thresh:T_NESCAFE},
    gym:     {icon:"ğŸ‹ï¸",name:"Gym",     opts:[{v:"Open",l:"âœ… Open",c:"m-btn-green"},{v:"Open Â· Crowded",l:"âš ï¸ Crowded",c:"m-btn-amber"},{v:"Closed",l:"ğŸ”’ Closed",c:"m-btn-red"}],thresh:T_GYM},
    bad:     {icon:"ğŸ¸",name:"Badminton",opts:[{v:"Open",l:"âœ… Open",c:"m-btn-green"},{v:"Open Â· Crowded",l:"âš ï¸ Crowded",c:"m-btn-amber"},{v:"Closed",l:"ğŸ”’ Closed",c:"m-btn-red"}],thresh:T_BAD},
    doc:     {icon:"ğŸ¥",name:"Doctor",   opts:[{v:"On Campus",l:"âœ… On Campus",c:"m-btn-green"},{v:"Not Available",l:"âŒ Not Available",c:"m-btn-red"}],thresh:T_DOC}
  };
  var c = cfg[place]; if(!c) return;
  var h = '<div class="mh"><span class="mh-title">'+c.icon+' '+c.name+'</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h += '<div style="font-size:.78em;color:var(--muted);margin-bottom:12px;">Needs '+c.thresh+' confirmation'+(c.thresh>1?"s":"")+' to go live</div>';
  h += '<div class="m-btn-row">';
  c.opts.forEach(function(o){ h += '<button class="m-btn '+o.c+'" onclick="doVote(\''+place+'\',\''+o.v+'\','+c.thresh+')">'+o.l+'</button>'; });
  h += '</div>';
  if(isAdmin){
    h += '<div class="m-adm-section"><div class="m-adm-label">Admin Override</div><div class="m-adm-row">';
    c.opts.forEach(function(o){ h += '<button class="m-adm-btn" onclick="adminSet(\''+place+'\',\''+o.v+'\')">'+o.l+'</button>'; });
    h += '<button class="m-adm-btn" onclick="resetPlace(\''+place+'\')">ğŸ”„ Reset</button></div></div>';
  }
  h += '<button class="m-btn m-btn-secondary" style="margin-top:14px;" onclick="closeModal()">Close</button>';
  openModal(h);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLASS SIGNAL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildClassGrid(){
  var grid = ge("class-grid"); if(!grid) return;
  grid.innerHTML = ROOMS.map(function(room){
    return '<div class="cs-card" id="cs-'+room+'" onclick="openClassModal(\''+room+'\')">' +
      '<div class="cs-dot cs-dot-gray" id="csdot-'+room+'"></div>' +
      '<div class="cs-room-name">'+room+'</div>' +
      '<span class="cs-badge bdg-gray" id="csbdg-'+room+'">Not Set</span>' +
      '<div class="cs-prof" id="csprof-'+room+'" style="font-size:.62em;color:var(--violet);margin-top:2px;min-height:14px;font-weight:600;"></div>' +
      '<div class="cs-timer" id="cstmr-'+room+'"></div>' +
      '<div class="cs-conf" id="csconf-'+room+'"></div>' +
    '</div>';
  }).join('');
}
buildClassGrid();

// Clean expired class signals
function cleanClassSignals(){
  db.ref("classSignals").once("value",function(snap){
    var now=Date.now();
    snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)>CS_TTL) db.ref("classSignals/"+c.key).remove(); });
  });
}
cleanClassSignals(); setInterval(cleanClassSignals, 60000);

// Update remaining time labels
setInterval(function(){
  ROOMS.forEach(function(room){
    var key = room.replace(/\s/g,"_");
    var tsEl = ge("cstmr-"+room);
    if(!tsEl||!tsEl._ts) return;
    var rem = Math.max(0, CS_TTL - (Date.now()-tsEl._ts));
    if(rem <= 0){ tsEl.textContent=""; return; }
    var mins = Math.ceil(rem/60000);
    tsEl.textContent = "â± "+mins+"m left";
  });
}, 10000);

// Listen to all class signals
db.ref("classSignals").on("value",function(snap){
  // Reset all first
  ROOMS.forEach(function(room){
    var card=ge("cs-"+room), dot=ge("csdot-"+room), bdg=ge("csbdg-"+room), tmr=ge("cstmr-"+room), conf=ge("csconf-"+room), prof=ge("csprof-"+room);
    if(!card) return;
    card.className="cs-card"; dot.className="cs-dot cs-dot-gray";
    bdg.className="cs-badge bdg-gray"; bdg.textContent="Not Set";
    if(tmr){ tmr.textContent=""; tmr._ts=null; }
    if(conf) conf.textContent="";
    if(prof) prof.textContent="";
  });
  var now=Date.now();
  snap.forEach(function(c){
    var d=c.val(); if(!d) return;
    if(now-d.ts>CS_TTL) return;
    var room=d.room; if(!room||ROOMS.indexOf(room)<0) return;
    var card=ge("cs-"+room), dot=ge("csdot-"+room), bdg=ge("csbdg-"+room), tmr=ge("cstmr-"+room), conf=ge("csconf-"+room), profEl=ge("csprof-"+room);
    if(!card) return;
    var st=d.status, cv=d.confirmations||1;
    var rem=Math.max(0,CS_TTL-(now-d.ts)), mins=Math.ceil(rem/60000);
    if(st==="ongoing"){
      card.className="cs-card cs-active-green"; dot.className="cs-dot cs-dot-green";
      bdg.className="cs-badge bdg-green"; bdg.textContent="ğŸŸ¢ Class Ongoing";
    } else if(st==="waiting"){
      card.className="cs-card cs-active-amber"; dot.className="cs-dot cs-dot-amber";
      bdg.className="cs-badge bdg-amber"; bdg.textContent="ğŸŸ¡ Waiting";
    } else if(st==="cancelled"){
      card.className="cs-card cs-active-red"; dot.className="cs-dot cs-dot-red";
      bdg.className="cs-badge bdg-red"; bdg.textContent="ğŸ”´ Cancelled";
    }
    if(tmr){ tmr.textContent="â± "+mins+"m"; tmr._ts=d.ts; }
    if(conf) conf.textContent=cv>=CS_THRESH?"âœ… "+cv+" confirmed":"ğŸ—³ "+cv+"/"+CS_THRESH;
    // Show prof if set and not the "not sure" placeholder
    if(profEl){
      var profName = d.prof || "";
      profEl.textContent = (profName && profName !== "â€” Not sure / Any") ? "ğŸ‘¤ "+profName : "";
    }
  });
});

function openClassModal(room){
  db.ref("classSignals").orderByChild("room").equalTo(room).once("value",function(snap){
    var existing=null, existingKey=null, now=Date.now();
    snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)<CS_TTL){ existing=d; existingKey=c.key; } });

    var currentProf = existing ? (existing.prof||"") : "";
    var profOpts = FACULTY.map(function(f){
      return '<option value="'+esc(f)+'"'+(f===currentProf?' selected':'')+'>'+esc(f)+'</option>';
    }).join('');

    var h='<div class="mh"><span class="mh-title">ğŸ« '+room+'</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    // Show current status if exists
    if(existing){
      var stLabel={"ongoing":"ğŸŸ¢ Class Ongoing","waiting":"ğŸŸ¡ Students Waiting","cancelled":"ğŸ”´ Cancelled"}[existing.status]||existing.status;
      var cv=existing.confirmations||1;
      var profDisplay=(existing.prof&&existing.prof!=="â€” Not sure / Any")?" Â· "+existing.prof:"";
      h+='<div style="background:var(--bg-panel);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 12px;margin-bottom:14px;font-size:.8em;color:var(--muted);">Current: <strong style="color:var(--text);">'+stLabel+esc(profDisplay)+'</strong> Â· '+cv+'/'+CS_THRESH+' confirmed</div>';
    }
    h+='<div class="m-label">Who\'s the professor? (optional)</div>';
    h+='<select class="m-select" id="cs-prof-sel" onchange="onProfChange(this)">'+profOpts+'</select>';
    h+='<div id="cs-visiting-wrap" style="display:none;margin-top:8px;"><input class="m-input" id="cs-visiting-name" maxlength="50" placeholder="Enter visiting faculty name..." style="margin-top:0;"></div>';
    h+='<div class="m-label" style="margin-top:14px;">What\'s the class status?</div>';
    h+='<div class="m-btn-row">';
    h+='<button class="m-btn m-btn-green" onclick="setClassSignal(\''+room+'\',\'ongoing\')">ğŸŸ¢ Class Ongoing</button>';
    h+='<button class="m-btn m-btn-amber" onclick="setClassSignal(\''+room+'\',\'waiting\')">ğŸŸ¡ Students Waiting</button>';
    h+='<button class="m-btn m-btn-red" onclick="setClassSignal(\''+room+'\',\'cancelled\')">ğŸ”´ Cancelled / Free</button>';
    h+='</div>';
    if(isAdmin && existingKey){
      h+='<div class="m-adm-section"><div class="m-adm-label">Admin</div><button class="m-adm-btn" onclick="clearClassSignal(\''+existingKey+'\')">ğŸ—‘ Clear Signal</button></div>';
    }
    h+='<button class="m-btn m-btn-secondary" style="margin-top:14px;" onclick="closeModal()">Close</button>';
    openModal(h);
  });
}

function onProfChange(sel){
  var wrap = ge("cs-visiting-wrap");
  if(wrap) wrap.style.display = sel.value === "âœï¸ Visiting Faculty (type name)" ? "block" : "none";
}

function setClassSignal(room, status){
  var profSel = ge("cs-prof-sel");
  var profRaw = profSel ? profSel.value : "";
  var profName = profRaw;
  // If visiting faculty, use the typed name
  if(profRaw === "âœï¸ Visiting Faculty (type name)"){
    var vInput = ge("cs-visiting-name");
    var vName = vInput ? vInput.value.trim() : "";
    profName = vName ? "Visiting: "+vName : "Visiting Faculty";
  }

  // Per-slot key: allow re-reporting each class period (not just daily)
  // Key = room + date + approx 45min slot index
  var slotIdx = Math.floor(Date.now() / CS_TTL);
  var devKey = "cs_" + room + "_" + slotIdx + "_" + devId;

  if(localStorage.getItem(devKey)){
    toast("You already reported " + room + " for this period!");
    closeModal(); return;
  }

  db.ref("classSignals").orderByChild("room").equalTo(room).once("value",function(snap){
    var existing=null, existingKey=null, now=Date.now();
    snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)<CS_TTL){ existing=d; existingKey=c.key; } });

    if(existing && existing.status===status){
      // Confirm existing â€” update prof if new info provided
      var cv=(existing.confirmations||1)+1;
      var update = {confirmations:cv, ts:Date.now()};
      if(profName && profName!=="â€” Not sure / Any") update.prof=profName;
      db.ref("classSignals/"+existingKey).update(update);
      localStorage.setItem(devKey, "1");
      toast("âœ… Confirmed! "+cv+"/"+CS_THRESH+" agree."+(cv>=CS_THRESH?" Now live!":""));
    } else {
      // New signal or different status â€” overwrite
      if(existingKey) db.ref("classSignals/"+existingKey).remove();
      db.ref("classSignals").push({
        room: room, status: status,
        prof: profName || "â€” Not sure / Any",
        ts: Date.now(), confirmations: 1, posterId: devId
      });
      localStorage.setItem(devKey, "1");
      toast("ğŸ“¡ Signal posted! 1 more confirmation needed.");
    }
    closeModal();
  });
}

function clearClassSignal(key){
  if(!checkAdmin()) return;
  db.ref("classSignals/"+key).remove();
  toast("Cleared"); closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  var inp = document.getElementById("sug-text");
  if(inp) inp.addEventListener("input", function(){
    var ct = document.getElementById("sug-ct");
    if(ct) ct.textContent = this.value.length + "/280";
  });
})();

function submitSuggestion(){
  var inp = ge("sug-text");
  var txt = (inp ? inp.value : "").trim();
  if(!txt) return toast("Write something first ğŸ’¡");
  var devKey = "sug_" + new Date().toDateString();
  if(localStorage.getItem(devKey)) return toast("Already sent one today. Thanks!");
  db.ref("suggestions").push({ text: txt, ts: Date.now() });
  localStorage.setItem(devKey, "1");
  inp.value = ""; ge("sug-ct").textContent = "0/280";
  ge("sug-thanks").style.display = "block";
  setTimeout(function(){ ge("sug-thanks").style.display = "none"; }, 4000);
  toast("ğŸ’¡ Suggestion sent!");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANNOUNCEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAnnModal(){
  if(!checkAdmin()) return;
  var h='<div class="mh"><span class="mh-title">ğŸ“¢ Post Announcement</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+='<textarea class="m-input" id="ann-in" rows="4" placeholder="Announcement text..."></textarea>';
  h+='<select class="m-select" id="ann-tag" style="margin-top:10px;"><option value="general">General</option><option value="mess">ğŸ› Mess</option><option value="event">ğŸ‰ Event</option><option value="academic">ğŸ“š Academic</option></select>';
  h+='<div class="m-btn-row"><button class="m-btn m-btn-green" onclick="postAnn()">Post</button><button class="m-btn m-btn-secondary" onclick="closeModal()">Cancel</button></div>';
  openModal(h);
}
function postAnn(){
  var t=((ge("ann-in")||{}).value||"").trim(); if(!t) return alert("Enter text");
  var tag=(ge("ann-tag")||{}).value||"general";
  db.ref("announcements").push({text:t,tag:tag,ts:Date.now()});
  toast("ğŸ“¢ Posted!"); closeModal();
}
function delAnn(id){ if(!checkAdmin()) return; if(!confirm("Delete?")) return; db.ref("announcements/"+id).remove(); toast("Deleted"); }
function cleanAnn(){ db.ref("announcements").once("value",function(snap){ var now=Date.now(); snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)>ANN_EXP) db.ref("announcements/"+c.key).remove(); }); }); }
cleanAnn(); setInterval(cleanAnn,300000);

db.ref("announcements").orderByChild("ts").on("value",function(snap){
  var posts=[], now=Date.now();
  snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)<ANN_EXP) posts.push({id:c.key,...d}); });
  posts.reverse();
  var el=ge("ann-list");
  if(!posts.length){ el.innerHTML='<div class="ann-empty">ğŸ“­ No announcements yet</div>'; return; }
  el.innerHTML='<div class="ann-list">'+posts.map(function(p){
    var exp=Math.ceil((ANN_EXP-(now-p.ts))/60000);
    var expTxt=exp>60?Math.ceil(exp/60)+"hr left":exp+"m left";
    return '<div class="ann-item tag-'+(p.tag||"general")+'">'+
      '<div class="ann-text">'+esc(p.text)+'</div>'+
      '<div class="ann-meta">'+
        '<span class="ann-tag tag-'+(p.tag||"general")+'">'+(p.tag||"general")+'</span>'+
        '<span class="ann-time">'+ago(p.ts)+' Â· â± '+expTxt+'</span>'+
        (isAdmin?'<button class="ann-del-btn" onclick="delAnn(\''+p.id+'\')">ğŸ—‘</button>':'')+
      '</div>'+
    '</div>';
  }).join('')+'</div>';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAST UPDATED + NIGHT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLastUpdated(){
  var n=new Date();
  var h=n.getHours().toString().padStart(2,"0"), m=n.getMinutes().toString().padStart(2,"0");
  setText("last-upd", h+":"+m);
}
updateLastUpdated(); setInterval(updateLastUpdated,60000);

function applyNightMode(){
  var h=new Date().getHours();
  var night=h>=22||h<6;
  var b=ge("night-banner"); if(b) b.classList.toggle("show",night);
}
applyNightMode(); setInterval(applyNightMode,60000);

// Auto food not available
var mealEndTimes=[{h:9,m:30,meal:"Breakfast"},{h:14,m:30,meal:"Lunch"},{h:18,m:30,meal:"Snacks"},{h:21,m:30,meal:"Dinner"}];
function checkAutoFoodStatus(){
  var now=new Date(), h=now.getHours(), m=now.getMinutes(), total=h*60+m;
  mealEndTimes.forEach(function(me){
    var end=me.h*60+me.m;
    if(total>=end && total<end+30){
      db.ref("mess").once("value",function(snap){
        var d=snap.val();
        if(!d||d.status==="Food Available") db.ref("mess").set({status:"Not Available",ts:Date.now(),autoSet:true});
      });
    }
  });
}
checkAutoFoodStatus(); setInterval(checkAutoFoodStatus,60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  var btn=ge("theme-btn"), body=document.body;
  function setTheme(mode){
    if(mode==="light"){ body.classList.add("light"); btn.textContent="â˜€ï¸ Light"; localStorage.setItem("theme","light"); }
    else { body.classList.remove("light"); btn.textContent="ğŸŒ™ Dark"; localStorage.setItem("theme","dark"); }
    setTimeout(function(){
      ROOMS.forEach(function(r){ /* repaint if needed */ });
    }, 50);
  }
  var saved=localStorage.getItem("theme");
  setTheme(saved==="dark"?"dark":"light");
  btn.addEventListener("click",function(){ setTheme(body.classList.contains("light")?"dark":"light"); });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  var deferred=null;
  function standalone(){ return window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone===true; }
  function mkBtn(){
    var b=document.getElementById("install-btn"); if(b) return b;
    b=document.createElement("button"); b.id="install-btn";
    b.textContent="ğŸ“² Add to Home";
    b.style.cssText="display:none;position:fixed;bottom:20px;left:16px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:28px;padding:11px 17px;font-size:.82em;font-weight:800;cursor:pointer;box-shadow:0 4px 14px rgba(16,185,129,.35);z-index:999;font-family:inherit;";
    document.body.appendChild(b); return b;
  }
  window.addEventListener("beforeinstallprompt",function(e){
    e.preventDefault(); deferred=e;
    if(!standalone()) mkBtn().style.display="block";
  });
  mkBtn().addEventListener("click",async function(){
    if(standalone()){ toast("Already added!"); return; }
    if(deferred){ deferred.prompt(); await deferred.userChoice; deferred=null; mkBtn().style.display="none"; }
    else{ alert("To add:\nâ€¢ iPhone: Share â†’ Add to Home Screen\nâ€¢ Android: Menu â‹® â†’ Add to Home screen"); }
  });
})();
</script>
</body>
</html>
