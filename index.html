<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
/* â•â•â• CSS CUSTOM PROPERTIES â•â•â• */
:root{
  --bg-main:#0b0b18;
  --bg-card:#141428;
  --bg-panel:#1a1a32;
  --bg-raised:#1e1e38;

  --text-main:#f0f0ff;
  --text-muted:#8892aa;
  --text-faint:#4a5568;

  --accent-violet:#8b5cf6;
  --accent-blue:#3b82f6;
  --accent-teal:#14b8a6;
  --accent-green:#10b981;

  --border-main:#1e1e3a;
  --border-soft:#252542;
  --shadow-main:0 8px 32px rgba(0,0,0,0.55);
  --shadow-card:0 4px 20px rgba(0,0,0,0.4);
  --radius-lg:18px;
  --radius-md:14px;
  --radius-sm:10px;
}

body.light-theme{
  --bg-main:#f0f2f8;
  --bg-card:#ffffff;
  --bg-panel:#eef0f8;
  --bg-raised:#e8eaf4;

  --text-main:#111827;
  --text-muted:#4b5563;
  --text-faint:#9ca3af;

  --border-main:#dde1f0;
  --border-soft:#e5e8f5;
  --shadow-main:0 6px 24px rgba(15,23,42,0.1);
  --shadow-card:0 2px 12px rgba(15,23,42,0.07);
}

/* â•â•â• RESET & BASE â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:'Inter',sans-serif;
  background:var(--bg-main);
  min-height:100vh;
  padding:12px 14px 100px;
  color:var(--text-main);
  transition:background 0.3s ease,color 0.3s ease;
  -webkit-font-smoothing:antialiased;
}

.container{max-width:600px;margin:0 auto;}

/* â•â•â• TOAST â•â•â• */
#toast{
  position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
  background:var(--bg-raised);color:var(--text-main);border:1px solid var(--border-main);
  padding:10px 20px;border-radius:30px;font-size:0.82em;font-weight:600;
  opacity:0;transition:opacity 0.3s;z-index:9999;white-space:nowrap;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);pointer-events:none;
}

/* â•â•â• ADMIN BAR â•â•â• */
#admin-bar{
  display:none;position:fixed;top:10px;right:10px;
  background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.45);
  color:#f87171;padding:5px 14px;border-radius:20px;font-size:0.7em;font-weight:700;
  z-index:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
}
#admin-bar.show{display:block;}

/* â•â•â• HEADER â•â•â• */
header{text-align:center;margin-bottom:16px;padding-top:8px;}

.header-top{
  display:flex;align-items:center;justify-content:flex-end;
  margin-bottom:10px;
}

#theme-toggle{
  padding:7px 16px;
  border-radius:20px;
  border:1px solid var(--border-main);
  background:var(--bg-card);
  color:var(--text-muted);
  font-weight:600;font-size:0.78em;
  cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:all 0.2s ease;
  flex-shrink:0;
}
#theme-toggle:hover{
  background:var(--bg-raised);
  color:var(--text-main);
}

header h1{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1.75em;font-weight:800;
  background:linear-gradient(135deg,#a78bfa,#60a5fa,#34d399);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-0.5px;margin-bottom:4px;
  line-height:1.2;
}

header p{font-size:0.74em;color:var(--text-muted);margin-bottom:10px;font-weight:500;}

.header-links{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;}

.upd-link{
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(139,92,246,0.1);padding:5px 12px;
  border-radius:14px;color:#a78bfa;text-decoration:none;
  font-size:0.72em;font-weight:600;border:1px solid rgba(139,92,246,0.2);
  transition:all 0.2s;
}
.upd-link:hover{background:rgba(139,92,246,0.18);}

.cu-link{
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(59,130,246,0.12);padding:5px 14px;
  border-radius:14px;color:#60a5fa;text-decoration:none;
  font-size:0.72em;font-weight:700;border:1px solid rgba(59,130,246,0.25);
  transition:all 0.2s;
}
.cu-link:hover{background:rgba(59,130,246,0.2);}

/* â•â•â• NOTIFICATION BANNER â•â•â• */
.notif-banner{
  display:none;background:linear-gradient(135deg,rgba(79,70,229,0.2),rgba(30,58,95,0.3));
  border:1px solid rgba(99,102,241,0.4);border-radius:var(--radius-md);
  padding:11px 14px;margin:10px 0;font-size:0.8em;color:#a5b4fc;
  align-items:center;gap:10px;flex-wrap:wrap;
}
.notif-banner.show{display:flex;}
.notif-btn{
  background:#4f46e5;border:none;color:white;padding:6px 14px;
  border-radius:8px;font-size:0.82em;font-weight:700;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
}

/* â•â•â• MEAL BANNER â€” REDESIGNED â•â•â• */
.meal-banner{
  background:var(--bg-card);
  border:1px solid var(--border-soft);
  border-radius:var(--radius-lg);
  padding:0;
  margin:10px 0 14px;
  overflow:hidden;
  box-shadow:var(--shadow-card);
  position:relative;
}

.meal-banner-inner{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px 20px 18px;
  text-align:center;
  background:linear-gradient(160deg,
    rgba(99,102,241,0.08) 0%,
    rgba(59,130,246,0.06) 50%,
    rgba(20,184,166,0.05) 100%
  );
}

.meal-banner-accent{
  height:3px;
  width:100%;
  background:linear-gradient(90deg,#8b5cf6,#3b82f6,#14b8a6);
}

.meal-label{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.6em;font-weight:800;
  color:var(--accent-violet);
  letter-spacing:2.5px;text-transform:uppercase;
  margin-bottom:4px;
}

.meal-time-row{
  display:flex;align-items:center;justify-content:center;gap:10px;
  margin-bottom:8px;
}

.meal-name{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1.6em;font-weight:800;
  color:var(--text-main);
  letter-spacing:-0.5px;
}

.meal-dot{
  width:6px;height:6px;border-radius:50%;
  background:var(--accent-blue);opacity:0.5;
}

.meal-day{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.9em;font-weight:600;
  color:var(--text-muted);
}

.meal-menu-text{
  font-size:0.84em;color:var(--text-muted);
  line-height:1.65;font-weight:400;
  max-width:420px;
  margin:0 auto;
}

.meal-menu-items{
  display:flex;flex-wrap:wrap;justify-content:center;gap:5px;
  margin-top:10px;
}
.meal-item-chip{
  background:rgba(99,102,241,0.1);
  border:1px solid rgba(99,102,241,0.18);
  color:var(--text-muted);
  padding:3px 10px;border-radius:20px;
  font-size:0.75em;font-weight:500;
}

body.light-theme .meal-item-chip{
  background:rgba(99,102,241,0.08);
  border-color:rgba(99,102,241,0.15);
}

/* â•â•â• STATS BAR â•â•â• */
.stats-bar{
  display:flex;justify-content:center;gap:24px;margin:4px 0 14px;
  flex-wrap:wrap;
}
.s-box{
  display:flex;align-items:center;gap:7px;
  background:var(--bg-card);border:1px solid var(--border-main);
  border-radius:30px;padding:5px 14px;
  box-shadow:var(--shadow-card);
}
.s-num{font-family:'Plus Jakarta Sans',sans-serif;font-size:0.92em;font-weight:700;color:var(--text-main);}
.s-lbl{font-size:0.72em;color:var(--text-muted);font-weight:500;}

/* â•â•â• SECTION LABEL â•â•â• */
.sec-lbl{
  font-family:'Plus Jakarta Sans',sans-serif;font-size:0.63em;font-weight:800;
  letter-spacing:2.5px;text-transform:uppercase;color:var(--text-faint);
  margin:18px 0 10px 2px;
}

/* â•â•â• GRID â€” 4-col for small status tiles â•â•â• */
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-bottom:10px;
}
@media(min-width:400px){.grid{grid-template-columns:repeat(4,1fr);gap:10px;}}

/* â•â•â• CARD â€” uniform small square tiles â•â•â• */
.card{
  border-radius:var(--radius-md);
  padding:13px 12px 11px;
  cursor:pointer;
  border:1px solid var(--border-main);
  transition:transform 0.2s,box-shadow 0.25s,background 0.4s,border-color 0.4s;
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;
  background:var(--bg-card);
  box-shadow:var(--shadow-card);
  min-height:108px;
  display:flex;flex-direction:column;
  justify-content:space-between;
  gap:3px;
}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-main);}
.card:active{transform:scale(0.97);}

/* Wide bar cards (Faculty, Suggest) â€” span full width */
.card.bar-card{
  grid-column:1/-1;
  min-height:unset;
  flex-direction:row;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 18px;
}
.bar-card .bar-left{display:flex;align-items:center;gap:12px;}
.bar-card .bar-icon{font-size:1.5em;line-height:1;}
.bar-card .bar-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:0.97em;font-weight:800;color:var(--text-main);}
.bar-card .bar-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.bar-card .bar-sbdg{min-width:120px;text-align:center;}

/* Tile inner layout */
.tile-head{display:flex;align-items:flex-start;justify-content:space-between;}
.tile-icon{font-size:1.5em;line-height:1;}
.tile-name{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.78em;font-weight:800;
  color:var(--text-main);
  margin-top:4px;line-height:1.2;
}
.ct{font-family:'Plus Jakarta Sans',sans-serif;font-size:0.78em;font-weight:800;color:var(--text-main);}
.ci{font-size:1.2em;}
.ch{display:flex;align-items:flex-start;justify-content:space-between;}

/* â•â•â• STATUS BADGES â•â•â• */
.sbdg{
  display:block;padding:5px 11px;border-radius:20px;
  font-size:0.74em;font-weight:700;margin:2px 0;text-align:center;width:100%;
  transition:all 0.3s;
}
.s-green{background:rgba(16,185,129,0.2);color:#34d399;border:1px solid rgba(16,185,129,0.35);}
.s-red{background:rgba(239,68,68,0.2);color:#f87171;border:1px solid rgba(239,68,68,0.35);}
.s-amber{background:rgba(245,158,11,0.2);color:#fbbf24;border:1px solid rgba(245,158,11,0.35);}
.s-blue{background:rgba(59,130,246,0.2);color:#93c5fd;border:1px solid rgba(59,130,246,0.35);}
.s-gray{background:rgba(100,116,139,0.15);color:var(--text-muted);border:1px solid rgba(100,116,139,0.25);}
.s-purple{background:rgba(139,92,246,0.2);color:#c4b5fd;border:1px solid rgba(139,92,246,0.3);}
.s-teal{background:rgba(20,184,166,0.2);color:#5eead4;border:1px solid rgba(20,184,166,0.35);}

/* Light theme badge overrides */
body.light-theme .s-green{background:rgba(16,185,129,0.12);color:#059669;}
body.light-theme .s-red{background:rgba(239,68,68,0.1);color:#dc2626;}
body.light-theme .s-amber{background:rgba(245,158,11,0.12);color:#d97706;}
body.light-theme .s-blue{background:rgba(59,130,246,0.1);color:#2563eb;}
body.light-theme .s-gray{background:rgba(100,116,139,0.1);color:#64748b;}
body.light-theme .s-purple{background:rgba(139,92,246,0.1);color:#7c3aed;}
body.light-theme .s-teal{background:rgba(20,184,166,0.12);color:#0d9488;}

/* â•â•â• COMMUNITY BADGE â•â•â• */
.cb{
  display:inline-flex;align-items:center;gap:4px;
  font-size:0.64em;font-weight:700;margin-top:4px;padding:3px 9px;
  border-radius:8px;line-height:1.4;
}
.cb-ok{background:rgba(16,185,129,0.12);color:#34d399;border:1px solid rgba(16,185,129,0.25);}
.cb-wait{background:rgba(245,158,11,0.12);color:#fbbf24;border:1px solid rgba(245,158,11,0.25);}
.cb-none{background:rgba(100,116,139,0.08);color:var(--text-faint);border:1px solid rgba(100,116,139,0.15);}

.mc{font-size:0.7em;color:var(--text-muted);margin-top:5px;background:rgba(255,255,255,0.03);padding:5px 8px;border-radius:8px;line-height:1.45;}
.tc{font-size:0.63em;color:var(--text-faint);margin-top:4px;text-align:center;}
.vc{font-size:0.63em;color:var(--accent-violet);margin-top:2px;text-align:center;}

/* â•â•â• ANNOUNCEMENTS â€” FIXED â•â•â• */
.ann-wrap{
  margin:12px 0;
  border-radius:var(--radius-lg);
  padding:18px;
  background:var(--bg-card);
  border:1px solid var(--border-soft);
  box-shadow:var(--shadow-card);
}

.ann-wrap-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;flex-wrap:wrap;gap:8px;
}

.ann-title{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.92em;font-weight:800;
  color:var(--text-main);
  display:flex;align-items:center;gap:8px;
}
.ann-title-badge{
  font-size:0.65em;color:var(--text-muted);font-weight:400;
  background:var(--bg-panel);border:1px solid var(--border-main);
  padding:2px 8px;border-radius:10px;
}

.ann-post-btn{
  background:rgba(139,92,246,0.12);
  border:1px solid rgba(139,92,246,0.3);
  color:#a78bfa;
  padding:7px 16px;border-radius:10px;
  font-size:0.75em;font-weight:700;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:all 0.2s ease;
  display:inline-flex;align-items:center;gap:5px;
}
.ann-post-btn:hover{background:rgba(139,92,246,0.22);transform:translateY(-1px);}

.ann-list-inner{display:flex;flex-direction:column;gap:10px;}

.ann-card{
  background:var(--bg-panel);
  border:1px solid var(--border-main);
  border-radius:var(--radius-sm);
  padding:13px 15px;
  transition:transform 0.2s ease,box-shadow 0.2s ease;
  position:relative;
  overflow:hidden;
}
.ann-card::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  border-radius:3px 0 0 3px;
  background:var(--accent-violet);
}
.ann-card.tag-mess-card::before{background:#f59e0b;}
.ann-card.tag-event-card::before{background:#3b82f6;}
.ann-card.tag-academic-card::before{background:#10b981;}

.ann-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-card);}

.ann-txt{
  color:var(--text-main);
  font-size:0.87em;line-height:1.55;
  margin-bottom:8px;
  font-weight:500;
}

.ann-meta{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  color:var(--text-muted);
}

.ann-empty{
  text-align:center;color:var(--text-muted);
  font-size:0.82em;padding:20px 14px;
  background:var(--bg-panel);border-radius:var(--radius-sm);
  border:1px dashed var(--border-main);
}

.ann-tag{font-size:0.65em;font-weight:700;padding:2px 8px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px;}
.tag-mess{background:rgba(245,158,11,0.15);color:#d97706;}
.tag-event{background:rgba(59,130,246,0.15);color:#3b82f6;}
.tag-academic{background:rgba(16,185,129,0.15);color:#059669;}
.tag-general{background:rgba(100,116,139,0.12);color:var(--text-muted);}

body.light-theme .tag-mess{background:rgba(245,158,11,0.12);}
body.light-theme .tag-event{background:rgba(59,130,246,0.1);}
body.light-theme .tag-academic{background:rgba(16,185,129,0.1);}

.ann-ts{font-size:0.65em;color:var(--text-faint);}
.ann-exp{font-size:0.65em;color:var(--text-faint);}
.ann-del{
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);
  color:#f87171;padding:2px 7px;border-radius:6px;font-size:0.65em;
  cursor:pointer;font-weight:700;margin-left:auto;
}

/* â•â•â• IMMEDIATE UPDATES â•â•â• */
.imm-wrap{
  margin-top:14px;border:1px solid rgba(245,158,11,0.25);
  border-radius:var(--radius-lg);padding:16px;
  background:var(--bg-card);box-shadow:var(--shadow-card);
}
.imm-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:0.95em;font-weight:800;color:#fbbf24;margin-bottom:10px;}
.imm-card{
  background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.18);
  border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px;
  font-size:0.83em;color:#fde68a;line-height:1.5;animation:fu .3s ease;
}
.imm-meta{font-size:0.65em;color:#78350f;margin-top:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.dv-btn{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.2);color:#f87171;padding:2px 8px;border-radius:6px;font-size:0.7em;cursor:pointer;font-weight:700;}

/* â•â•â• HEARTBEAT â•â•â• */
.hb-wrap{
  margin-top:14px;border:1px solid rgba(255,77,109,0.22);
  border-radius:var(--radius-lg);padding:16px;
  background:var(--bg-card);position:relative;overflow:hidden;
  box-shadow:var(--shadow-card);
}
.hb-wrap::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#ff4d6d,#ff758c,#ff4d6d);background-size:200%;animation:shimmer 2s infinite;}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
.hb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.hb-tit{font-family:'Plus Jakarta Sans',sans-serif;font-size:0.95em;font-weight:800;color:#ff4d6d;display:flex;align-items:center;gap:6px;}
.pdot{width:8px;height:8px;border-radius:50%;background:#ff4d6d;animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}
.hb-rules{
  background:rgba(255,77,109,0.06);border:1px solid rgba(255,77,109,0.16);
  border-radius:var(--radius-sm);padding:10px 12px;margin:8px 0;
  font-size:0.74em;color:#fca5a5;line-height:1.7;
}
.hb-rules strong{color:#ff4d6d;display:block;margin-bottom:3px;font-family:'Plus Jakarta Sans',sans-serif;}
.hb-row{display:flex;gap:8px;margin:8px 0 2px;}
.hb-in{
  flex:1;background:rgba(255,255,255,0.05);
  border:1px solid var(--border-main);border-radius:var(--radius-sm);
  padding:9px 11px;color:var(--text-main);font-size:0.83em;
  font-family:'Inter',sans-serif;outline:none;
  transition:border-color 0.2s;
}
.hb-in:focus{border-color:#ff4d6d;}
.hb-in::placeholder{color:var(--text-faint);}
.chct{font-size:0.65em;color:var(--text-faint);text-align:right;margin-bottom:6px;}
.chct.warn{color:#f59e0b;}
.btn-hb{
  background:#ff4d6d;color:white;border:none;border-radius:var(--radius-sm);
  padding:9px 14px;font-weight:700;font-size:0.83em;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;white-space:nowrap;transition:opacity 0.2s;
}
.btn-hb:hover{opacity:0.88;}
.hb-feed{display:flex;flex-direction:column;gap:7px;margin-top:8px;max-height:280px;overflow-y:auto;}
.hb-card{
  background:rgba(255,77,109,0.06);border:1px solid rgba(255,77,109,0.16);
  border-radius:var(--radius-sm);padding:10px 12px;display:flex;gap:10px;
  align-items:center;animation:fu .3s ease;
}
@keyframes fu{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.hb-txt{font-size:0.83em;color:#fca5a5;flex:1;line-height:1.4;}
.hb-r{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:44px;}
.uv-btn{
  background:rgba(255,77,109,0.15);border:1px solid rgba(255,77,109,0.28);
  color:#ff4d6d;border-radius:8px;padding:4px 7px;font-size:0.76em;
  font-weight:700;cursor:pointer;width:100%;text-align:center;
}
.uv-btn.voted{opacity:0.4;cursor:default;}
.tbar{height:2px;background:rgba(255,77,109,0.12);border-radius:2px;margin-top:5px;overflow:hidden;}
.tfil{height:100%;background:#ff4d6d;border-radius:2px;transition:width 1s linear;}
.hb-empty{text-align:center;color:var(--text-faint);font-size:0.78em;padding:18px;}

/* â•â•â• MODAL â•â•â• */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:flex-end;justify-content:center;}
.modal.active{display:flex;}
.mbox{
  background:var(--bg-card);border-radius:24px 24px 0 0;
  padding:22px 18px 38px;width:100%;max-width:520px;
  max-height:90vh;overflow-y:auto;
  border:1px solid var(--border-main);border-bottom:none;
  animation:su .28s ease;
}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mh{
  font-family:'Plus Jakarta Sans',sans-serif;font-size:1.2em;font-weight:800;
  color:var(--text-main);margin-bottom:16px;
  display:flex;justify-content:space-between;align-items:center;
}
.mx{
  background:var(--bg-panel);border:1px solid var(--border-main);
  color:var(--text-muted);width:30px;height:30px;border-radius:50%;
  cursor:pointer;font-size:0.9em;display:flex;align-items:center;justify-content:center;
}
.bst{display:flex;flex-direction:column;gap:9px;margin-top:10px;}
.mb{
  padding:13px;border:none;border-radius:11px;font-size:0.92em;
  font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  transition:opacity 0.15s;
}
.mb:active{opacity:0.85;}
.mb.g{background:#10b981;color:white;}
.mb.r{background:#ef4444;color:white;}
.mb.a{background:#f59e0b;color:white;}
.mb.t{background:#0d9488;color:white;}
.mb.x{background:var(--bg-panel);color:var(--text-muted);margin-top:6px;border:1px solid var(--border-main);}
.mi{
  width:100%;background:var(--bg-panel);border:1px solid var(--border-main);
  border-radius:10px;padding:11px;color:var(--text-main);font-size:0.88em;
  font-family:'Inter',sans-serif;outline:none;margin-top:8px;
  transition:border-color 0.2s;
}
.mi:focus{border-color:var(--accent-violet);}
.msel{
  width:100%;background:var(--bg-panel);border:1px solid var(--border-main);
  border-radius:10px;padding:11px;color:var(--text-main);font-size:0.88em;
  font-family:'Inter',sans-serif;outline:none;margin-top:8px;
}
.adm-sec{margin-top:14px;padding-top:12px;border-top:1px solid rgba(239,68,68,0.2);}
.adm-lbl{font-size:0.72em;color:#ef4444;font-weight:700;margin-bottom:8px;}
.adm-row{display:flex;flex-wrap:wrap;gap:8px;}
.adm-btn{
  flex:1;min-width:80px;padding:9px 8px;
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.22);
  color:#fca5a5;border-radius:9px;font-size:0.8em;font-weight:700;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;text-align:center;
}

/* â•â•â• BUTTONS â•â•â• */
.ref-btn{
  position:fixed;bottom:20px;right:16px;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  color:white;border:none;border-radius:30px;padding:11px 18px;
  font-size:0.82em;font-weight:700;cursor:pointer;
  box-shadow:0 4px 16px rgba(99,102,241,0.45);z-index:999;
  font-family:'Plus Jakarta Sans',sans-serif;transition:transform 0.15s;
}
.ref-btn:hover{transform:scale(1.04);}

/* â•â•â• CARD COLOR â€” DARK GRADIENT â•â•â• */
/* Light theme overrides â€” flatter colors */
body.light-theme .card[style*="linear-gradient"]{
  background:var(--bg-card) !important;
}

/* â•â•â• FOOTER â•â•â• */
.site-footer{
  margin-top:28px;
  padding-bottom:10px;
}

.footer-divider{
  height:1px;
  background:linear-gradient(90deg,transparent,var(--border-main),var(--border-main),transparent);
  margin-bottom:20px;
}

.footer-inner{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
  text-align:center;
}

.footer-brand{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:3px;
}

.footer-logo-text{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1em;
  font-weight:800;
  background:linear-gradient(135deg,#a78bfa,#60a5fa,#34d399);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-0.3px;
}

.footer-tagline{
  font-size:0.65em;
  color:var(--text-faint);
  font-weight:500;
  letter-spacing:0.3px;
}

.footer-meta{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

.footer-devs{
  display:flex;
  align-items:center;
  gap:7px;
  flex-wrap:wrap;
  justify-content:center;
}

.footer-dev-label{
  font-size:0.7em;
  color:var(--text-muted);
  font-weight:500;
}

.footer-dev-names{
  display:flex;
  align-items:center;
  gap:6px;
}

.dev-chip{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.72em;
  font-weight:700;
  padding:3px 11px;
  border-radius:20px;
  background:rgba(139,92,246,0.1);
  border:1px solid rgba(139,92,246,0.25);
  color:#a78bfa;
}

body.light-theme .dev-chip{
  background:rgba(139,92,246,0.08);
  border-color:rgba(139,92,246,0.2);
  color:#7c3aed;
}

.footer-amp{
  font-size:0.7em;
  color:var(--text-faint);
  font-weight:600;
}

.footer-copy{
  font-size:0.63em;
  color:var(--text-faint);
  font-weight:500;
  letter-spacing:0.2px;
}

/* â•â•â• MOBILE â•â•â• */
@media(max-width:399px){
  body{padding:10px 10px 100px;}
  header h1{font-size:1.4em;}
  .grid{grid-template-columns:repeat(2,1fr);gap:8px;}
  .card{padding:11px 10px 9px;min-height:100px;}
  .tile-icon{font-size:1.3em;}
  .tile-name{font-size:0.73em;}
  .sbdg{font-size:0.68em;padding:4px 8px;}
  .cb{font-size:0.58em;}
  .meal-name{font-size:1.3em;}
  .ann-wrap{padding:0;}
  .cu-tile-title{font-size:1em;}
  .bar-card{padding:12px 14px;}
}
/* â•â•â• CAMPUS UNO BIG TILE â•â•â• */
.campus-uno-tile{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin:14px 0;
  padding:20px 22px;
  border-radius:var(--radius-lg);
  text-decoration:none;
  background:linear-gradient(135deg,#1e1b4b 0%,#1e3a8a 55%,#0c4a6e 100%);
  border:1px solid rgba(99,102,241,0.45);
  box-shadow:0 8px 28px rgba(99,102,241,0.25);
  cursor:pointer;
  transition:transform 0.2s,box-shadow 0.2s;
  -webkit-tap-highlight-color:transparent;
}
.campus-uno-tile:hover{transform:translateY(-3px);box-shadow:0 12px 36px rgba(99,102,241,0.38);}
.campus-uno-tile:active{transform:scale(0.98);}
.cu-tile-left{display:flex;align-items:center;gap:14px;}
.cu-tile-icon{
  font-size:2em;line-height:1;
  background:rgba(255,255,255,0.12);
  padding:10px;border-radius:12px;
  border:1px solid rgba(255,255,255,0.15);
}
.cu-tile-title{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1.1em;font-weight:800;
  color:#ffffff;
  letter-spacing:-0.3px;
}
.cu-tile-sub{
  font-size:0.78em;color:rgba(255,255,255,0.6);
  font-weight:400;margin-top:2px;
}
.cu-tile-arrow{
  font-size:1.5em;color:rgba(255,255,255,0.7);
  font-weight:300;flex-shrink:0;
}
body.light-theme .campus-uno-tile{
  background:linear-gradient(135deg,#4f46e5 0%,#2563eb 55%,#0369a1 100%);
  border-color:rgba(79,70,229,0.4);
  box-shadow:0 6px 24px rgba(79,70,229,0.28);
}

/* â•â•â• ANNOUNCEMENTS â€” distinctive â•â•â• */
.ann-wrap{
  margin:12px 0;
  border-radius:var(--radius-lg);
  overflow:hidden;
  /* Distinctive gradient border effect */
  background:linear-gradient(var(--bg-main),var(--bg-main)) padding-box,
             linear-gradient(135deg,#8b5cf6,#3b82f6,#14b8a6) border-box;
  border:2px solid transparent;
  box-shadow:0 6px 24px rgba(139,92,246,0.2);
}
.ann-wrap-inner{
  background:var(--bg-card);
  border-radius:calc(var(--radius-lg) - 2px);
  padding:16px 18px 18px;
}
body.light-theme .ann-wrap{
  background:linear-gradient(var(--bg-main),var(--bg-main)) padding-box,
             linear-gradient(135deg,#8b5cf6,#3b82f6,#14b8a6) border-box;
  box-shadow:0 4px 18px rgba(139,92,246,0.14);
}

/* â•â•â• NIGHT BANNER â•â•â• */
.night-banner{
  display:none;
  background:linear-gradient(135deg,rgba(15,10,40,0.95),rgba(30,10,60,0.95));
  border:1px solid rgba(139,92,246,0.4);
  border-radius:var(--radius-lg);
  padding:22px 20px;
  margin:10px 0 16px;
  text-align:center;
  box-shadow:0 8px 32px rgba(99,0,255,0.2);
}
.night-banner.show{display:block;}
.night-banner-emoji{font-size:2em;margin-bottom:8px;}
.night-banner-text{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1.3em;font-weight:800;
  background:linear-gradient(135deg,#a78bfa,#818cf8,#c4b5fd);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-0.3px;
}
.night-banner-sub{font-size:0.78em;color:#7c6fa0;margin-top:5px;font-weight:500;}

/* â•â•â• NIGHT MASK (tiles after Campus Uno during night) â•â•â• */
.night-mask-wrap{position:relative;}
.night-overlay{
  display:none;
  position:absolute;inset:0;
  background:rgba(11,11,24,0.88);
  border-radius:var(--radius-lg);
  z-index:50;
  align-items:center;justify-content:center;
  backdrop-filter:blur(3px);
}
.night-overlay.show{display:flex;}
.night-overlay-txt{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:0.82em;font-weight:700;color:#6b5fa0;
  text-align:center;letter-spacing:0.5px;
}
body.light-theme .night-overlay{background:rgba(200,200,240,0.88);}
body.light-theme .night-overlay-txt{color:#9980c0;}

/* â•â•â• SUGGEST TILE â€” open big card â•â•â• */
.suggest-open-wrap{
  background:var(--bg-card);
  border:2px solid rgba(139,92,246,0.35);
  border-radius:var(--radius-lg);
  padding:18px 18px 14px;
  margin-bottom:10px;
  box-shadow:0 6px 24px rgba(139,92,246,0.15);
}
.suggest-open-header{
  display:flex;align-items:center;gap:10px;margin-bottom:12px;
}
.suggest-open-icon{font-size:1.4em;}
.suggest-open-title{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1em;font-weight:800;color:var(--text-main);
}
.suggest-open-sub{font-size:0.72em;color:var(--text-muted);margin-top:2px;}
.suggest-open-input{
  width:100%;background:var(--bg-panel);border:1px solid var(--border-main);
  border-radius:var(--radius-sm);padding:11px 12px;color:var(--text-main);
  font-size:0.85em;font-family:'Inter',sans-serif;outline:none;
  resize:none;transition:border-color 0.2s;min-height:80px;
}
.suggest-open-input:focus{border-color:var(--accent-violet);}
.suggest-open-input::placeholder{color:var(--text-faint);}
.suggest-open-btn{
  background:linear-gradient(135deg,#7c3aed,#6366f1);color:white;border:none;
  border-radius:var(--radius-sm);padding:10px 20px;font-weight:700;font-size:0.85em;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  margin-top:10px;width:100%;transition:opacity 0.2s;
}
.suggest-open-btn:hover{opacity:0.88;}
.suggest-feed-inline{margin-top:12px;max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:7px;}
.sug-inline-card{
  background:var(--bg-panel);border:1px solid var(--border-soft);
  border-radius:var(--radius-sm);padding:9px 11px;
  font-size:0.78em;color:var(--text-muted);line-height:1.4;
}

/* â•â•â• HEARTBEAT REDESIGN â•â•â• */
.hb-chat-header{
  display:flex;align-items:center;gap:10px;margin-bottom:12px;
}
.hb-chat-title{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:1.05em;font-weight:800;color:#ff4d6d;
  display:flex;align-items:center;gap:7px;
}
.hb-chat-desc{
  font-size:0.85em;color:#ff8fa3;font-weight:600;
  margin-bottom:12px;
  line-height:1.5;
  padding:10px 12px;
  background:rgba(255,77,109,0.08);
  border-radius:var(--radius-sm);
  border-left:3px solid #ff4d6d;
}
/* Floating message overlay */
#hb-float-overlay{
  position:fixed;inset:0;pointer-events:none;z-index:9000;overflow:hidden;
}
.hb-float-msg{
  position:absolute;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:clamp(1.1em,4vw,1.6em);
  font-weight:800;
  color:#ff4d6d;
  text-shadow:0 0 20px rgba(255,77,109,0.5),0 2px 8px rgba(0,0,0,0.4);
  max-width:80vw;
  word-break:break-word;
  text-align:center;
  line-height:1.3;
  animation:hbFloat 60s forwards;
  pointer-events:none;
}
@keyframes hbFloat{
  0%{opacity:0;transform:scale(0.7);}
  5%{opacity:1;transform:scale(1);}
  70%{opacity:1;}
  100%{opacity:0;transform:scale(1.05);}
}

/* â•â•â• LAST UPDATED â•â•â• */
.last-updated-bar{
  display:flex;align-items:center;justify-content:flex-end;gap:5px;
  font-size:0.62em;color:var(--text-faint);
  margin-bottom:6px;font-weight:500;
}
.last-updated-dot{
  width:5px;height:5px;border-radius:50%;
  background:#10b981;animation:pulse 2s infinite;
}

/* â•â•â• JS PAINTS CARD COLORS â•â•â• */
</style>
</head>
<body class="light-theme">
<script>
// Apply saved theme immediately before paint to prevent flash
if(localStorage.getItem("theme")==="dark") document.body.classList.remove("light-theme");
</script>
<div id="toast"></div>
<div id="admin-bar" onclick="adminLogout()">ğŸ” Admin Â· tap to exit</div>

<div class="container">
  <div class="header-top">
    <button id="theme-toggle">ğŸŒ™ Dark</button>
  </div>

  <header>
    <h1>FundBASEU Tracker</h1>
    <p>Real-time campus status Â· by students, for students</p>
    <div class="header-links">
      <a href="https://sway.cloud.microsoft/CuEoSACHmG0wvSfR?ref=Link&loc=play" target="_blank" class="upd-link">ğŸ“¢ FundBASEU Updates â†’</a>
    </div>
  </header>

  <div class="notif-banner" id="notif-banner">
    <div style="flex:1;">ğŸ”” Get meal reminders at 7:30am Â· 12:30pm Â· 5pm Â· 7:30pm
    <div id="notif-st" style="font-size:0.72em;color:#818cf8;margin-top:3px;"></div></div>
    <button class="notif-btn" id="notif-btn" onclick="reqNotif()">Enable</button>
  </div>

  <!-- NIGHT BANNER -->
  <div class="night-banner" id="night-banner">
    <div class="night-banner-emoji">ğŸŒ™âœ¨</div>
    <div class="night-banner-text">BASEU Never Sleeps</div>
    <div class="night-banner-sub">It's late â€” but you're not alone</div>
  </div>

  <!-- CAMPUS UNO TILE â€” above announcements -->
  <a href="https://campus.uno/" target="_blank" rel="noopener noreferrer" class="campus-uno-tile">
    <div class="cu-tile-left">
      <span class="cu-tile-icon">ğŸ“</span>
      <div>
        <div class="cu-tile-title">Campus Uno</div>
        <div class="cu-tile-sub">Your all-in-one campus platform</div>
      </div>
    </div>
    <span class="cu-tile-arrow">â†’</span>
  </a>

  <!-- ANNOUNCEMENTS (top) â€” distinctive card -->
  <div class="ann-wrap">
   <div class="ann-wrap-inner">
    <div class="ann-wrap-header">
      <div class="ann-title">ğŸ“¢ Announcements <span class="ann-title-badge">12hr expiry</span></div>
      <button class="ann-post-btn" onclick="openAnnPost()">+ Post</button>
    </div>
    <div id="ann-list"><div class="ann-empty">No announcements yet</div></div>
   </div>
  </div>

  <!-- NEXT MEAL BANNER -->
  <div class="meal-banner" id="meal-banner">
    <div class="meal-banner-accent"></div>
    <div class="meal-banner-inner">
      <span class="meal-label" id="meal-label-top">Next Meal</span>
      <div class="meal-time-row">
        <span class="meal-name" id="meal-name-top">â€”</span>
        <span class="meal-dot"></span>
        <span class="meal-day" id="meal-day-top"></span>
      </div>
      <div class="meal-menu-items" id="meal-menu-top"></div>
    </div>
  </div>

  <div class="stats-bar">
    <div class="s-box"><span class="s-num" id="liveCount">0</span><span class="s-lbl">ğŸ‘¥ Live Now</span></div>
    <div class="s-box"><span class="s-num" id="totalVis">0</span><span class="s-lbl">ğŸ“Š Visitors</span></div>
  </div>

  <div class="last-updated-bar">
    <div class="last-updated-dot"></div>
    <span>Last updated: <span id="last-updated-time">â€”</span></span>
  </div>

  <div class="sec-lbl">Campus Status</div>

  <div class="night-mask-wrap">
  <div class="night-overlay" id="night-overlay"><div class="night-overlay-txt">ğŸŒ™ Tracker sleeps too<br><span style="font-size:0.85em;opacity:0.7;">Check back after 6am</span></div></div>

  <div class="grid">

    <!-- MESS â€” small square -->
    <div class="card" id="mess-card" onclick="openModal('mess')">
      <div class="tile-head"><span class="tile-icon">ğŸ½ï¸</span></div>
      <span class="tile-name">Mess</span>
      <span class="sbdg s-gray" id="mess-avail">Not Updated</span>
      <div class="cb cb-none" id="mess-cb">â¬œ No votes yet</div>
      <div class="vc" id="mess-vc"></div>
      <div class="tc" id="mess-ts"></div>
    </div>

    <!-- NANDINI â€” small square -->
    <div class="card" id="nandini-card" onclick="openModal('nandini')">
      <div class="tile-head"><span class="tile-icon">ğŸ¥›</span></div>
      <span class="tile-name">Nandini</span>
      <span class="sbdg s-gray" id="nandini-avail">Not Updated</span>
      <div class="cb cb-none" id="nandini-cb">â¬œ No votes yet</div>
      <div class="vc" id="nandini-vc"></div>
      <div class="tc" id="nandini-ts"></div>
    </div>

    <!-- NESCAFÃ‰ â€” small square -->
    <div class="card" id="nescafe-card" onclick="openModal('nescafe')">
      <div class="tile-head"><span class="tile-icon">â˜•</span></div>
      <span class="tile-name">NescafÃ©</span>
      <span class="sbdg s-gray" id="nescafe-avail">Not Updated</span>
      <div class="cb cb-none" id="nescafe-cb">â¬œ No votes yet</div>
      <div class="vc" id="nescafe-vc"></div>
      <div class="tc" id="nescafe-ts"></div>
    </div>

    <!-- GYM â€” small square -->
    <div class="card" id="gym-card" onclick="openModal('gym')">
      <div class="tile-head"><span class="tile-icon">ğŸ‹ï¸</span></div>
      <span class="tile-name">Gym</span>
      <span class="sbdg s-gray" id="gym-avail">Not Updated</span>
      <div class="cb cb-none" id="gym-cb">â¬œ No votes yet</div>
      <div class="vc" id="gym-vc"></div>
      <div class="tc" id="gym-ts"></div>
    </div>

    <!-- BADMINTON â€” small square -->
    <div class="card" id="bad-card" onclick="openModal('bad')">
      <div class="tile-head"><span class="tile-icon">ğŸ¸</span></div>
      <span class="tile-name">Badminton</span>
      <span class="sbdg s-gray" id="bad-avail">Not Updated</span>
      <div class="cb cb-none" id="bad-cb">â¬œ No votes yet</div>
      <div class="vc" id="bad-vc"></div>
      <div class="vc" id="bad-pend"></div>
      <div class="tc" id="bad-ts"></div>
    </div>

    <!-- DOCTOR â€” small square -->
    <div class="card" id="doc-card" onclick="openModal('doc')">
      <div class="tile-head"><span class="tile-icon">ğŸ¥</span></div>
      <span class="tile-name">Doctor</span>
      <span class="sbdg s-gray" id="doc-avail">Not Updated</span>
      <div class="cb cb-none" id="doc-cb">â¬œ No votes yet</div>
      <div class="vc" id="doc-vc"></div>
      <div class="vc" id="doc-pend"></div>
      <div class="tc" id="doc-ts"></div>
    </div>

    <!-- FACULTY â€” wide bar (spans full row) -->
    <div class="card bar-card" onclick="openFacultyLocator()">
      <div class="bar-left">
        <span class="bar-icon">ğŸ“</span>
        <div>
          <div class="bar-title">Faculty Locator</div>
          <div class="tc" id="fac-summary" style="text-align:left;margin-top:3px;"></div>
        </div>
      </div>
      <div class="bar-right">
        <span class="sbdg s-purple bar-sbdg">Tap to locate â†’</span>
      </div>
    </div>

  </div><!-- end grid -->
  </div><!-- end night-mask-wrap -->

  <!-- SUGGEST OPEN TILE â€” always visible, always open -->
  <div class="suggest-open-wrap">
    <div class="suggest-open-header">
      <span class="suggest-open-icon">ğŸ’¡</span>
      <div>
        <div class="suggest-open-title">Suggestions & Ideas</div>
        <div class="suggest-open-sub">Help make BASEU better â€” share anything</div>
      </div>
    </div>
    <textarea class="suggest-open-input" id="sug-open-in" rows="3" placeholder="Ideas, bugs, complaints, requests..."></textarea>
    <button class="suggest-open-btn" onclick="doSugOpen()">Submit Suggestion</button>
    <div class="suggest-feed-inline" id="sug-feed-inline"></div>
  </div>

  <!-- IMMEDIATE UPDATES -->
  <div class="imm-wrap" id="imm-wrap" style="display:none;">
    <div class="imm-title">ğŸ”´ Immediate Updates <span style="font-size:0.6em;color:#78350f;font-weight:400;margin-left:4px;">5 downvotes = removed</span></div>
    <div id="imm-list"></div>
  </div>

  <!-- HEARTBEAT ZONE -->
  <div class="hb-wrap">
    <div class="hb-chat-header">
      <div class="hb-chat-title"><div class="pdot"></div>ğŸ’¬ Campus Chat</div>
      <span style="font-size:0.68em;color:#7f3040;margin-left:auto;">anonymous Â· disappearing</span>
    </div>
    <div class="hb-chat-desc">
      ğŸ˜´ Bored? Chat your heart out here â€” anonymously.<br>
      <span style="font-size:0.88em;opacity:0.8;">Messages appear big on screen &amp; vanish in 60 seconds. Say anything.</span>
    </div>
    <div class="hb-row">
      <input class="hb-in" id="hb-txt" maxlength="80" placeholder="What's on your mind right now..." oninput="updateCC()">
      <button class="btn-hb" onclick="postHB()">Send</button>
    </div>
    <div class="chct" id="chct">0 / 80</div>
    <div class="hb-feed" id="hb-feed"><div class="hb-empty">No messages yet Â· be the first to chat</div></div>
  </div>

  <!-- FLOATING MESSAGE OVERLAY -->
  <div id="hb-float-overlay"></div>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-divider"></div>
    <div class="footer-inner">
      <div class="footer-brand">
        <span class="footer-logo-text">FundBASEU</span>
        <span class="footer-tagline">Campus Intelligence Platform</span>
      </div>
      <div class="footer-meta">
        <div class="footer-devs">
          <span class="footer-dev-label">Built by</span>
          <span class="footer-dev-names">
            <span class="dev-chip">Vardhan</span>
            <span class="footer-amp">&amp;</span>
            <span class="dev-chip">Athul</span>
          </span>
        </div>
        <div class="footer-copy">Â© 2026 FundBASEU Â· All Rights Reserved</div>
      </div>
    </div>
  </footer>

</div>

<button class="ref-btn" onclick="location.reload()">ğŸ”„ Refresh</button>

<div class="modal" id="modal" onclick="bgClose(event)">
  <div class="mbox" id="mbox"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var ILOCK = "fundbaseu2024"; // â† change this
//Voting thresholds
var T_MESS=3, T_GYM=1, T_NESCAFE=2, T_NANDINI=2, T_BAD=2, T_DOC=1, T_PROF=1;
// Time thresholds (ms)
var HB_VOTES=5, HB_TTL=60000, IMM_DV=5, ANN_EXP=43200000;

// Faculty list â€” 12 professors
var FACULTY = [
  "Dr.Bidur",
  "Dr.Megha",
  "Dr.Irfan",
  "Dr.Shameer",
  "Dr.Nageshwar",
  "Dr.Ishfaq",
  "Dr.Muzaffar",
  "Dr.Kasturi",
  "Dr.Moushmi",
  "Dr.Sushmita",
  "Dean",
  "Dr.Asha"
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey:"AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
  authDomain:"fundbaseu-tracker.firebaseapp.com",
  databaseURL:"https://fundbaseu-tracker-default-rtdb.firebaseio.com",
  projectId:"fundbaseu-tracker"
});
var db = firebase.database();

var pr = db.ref("presence").push();
pr.set(true); pr.onDisconnect().remove();
db.ref("presence").on("value",function(s){ setText("liveCount",s.numChildren()); });
db.ref("totalVisitors").transaction(function(c){ return (c||0)+1; });
db.ref("totalVisitors").on("value",function(s){ setText("totalVis",s.val()||0); });

var devId = localStorage.getItem("did") || (function(){ var id="d_"+Math.random().toString(36).slice(2,11); localStorage.setItem("did",id); return id; })();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ge(id){ return document.getElementById(id); }
function setText(id,v){ var e=ge(id); if(e) e.textContent=v; }
function ago(t){ if(!t) return ""; var m=Math.floor((Date.now()-t)/60000); if(m<1) return "just now"; if(m===1) return "1m ago"; if(m<60) return m+"m ago"; var h=Math.floor(m/60); if(h<24) return h+"hr ago"; return Math.floor(h/24)+"d ago"; }
function ts(t){ if(!t) return ""; var d=new Date(t); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
function esc(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function toast(msg){ var t=ge("toast"); t.textContent=msg; t.style.opacity="1"; clearTimeout(t._x); t._x=setTimeout(function(){ t.style.opacity="0"; },2800); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD COLOR â€” applied directly via style + border
//  This bypasses ALL CSS specificity issues
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CARD_COLORS = {
  green:  { bg:"linear-gradient(135deg,#052e16,#064e3b)", border:"#10b981", glow:"rgba(16,185,129,0.3)", lightBg:"rgba(16,185,129,0.08)", lightBorder:"#10b981" },
  red:    { bg:"linear-gradient(135deg,#450a0a,#7f1d1d)", border:"#ef4444", glow:"rgba(239,68,68,0.3)",  lightBg:"rgba(239,68,68,0.07)",  lightBorder:"#ef4444" },
  amber:  { bg:"linear-gradient(135deg,#451a03,#78350f)", border:"#f59e0b", glow:"rgba(245,158,11,0.3)", lightBg:"rgba(245,158,11,0.08)", lightBorder:"#f59e0b" },
  teal:   { bg:"linear-gradient(135deg,#042f2e,#134e4a)", border:"#14b8a6", glow:"rgba(20,184,166,0.3)", lightBg:"rgba(20,184,166,0.08)", lightBorder:"#14b8a6" },
  blue:   { bg:"linear-gradient(135deg,#0c1a4a,#1e3a8a)", border:"#3b82f6", glow:"rgba(59,130,246,0.3)", lightBg:"rgba(59,130,246,0.08)", lightBorder:"#3b82f6" },
  purple: { bg:"linear-gradient(135deg,#1e1b4b,#312e81)", border:"#818cf8", glow:"rgba(129,140,248,0.3)",lightBg:"rgba(99,102,241,0.08)", lightBorder:"#6366f1" },
  dark:   { bg:"",                                        border:"",         glow:"none",                lightBg:"",                      lightBorder:"" }
};

function paintCard(id, colorKey){
  var card = ge(id);
  if (!card) return;
  var c = CARD_COLORS[colorKey] || CARD_COLORS.dark;
  var isLight = document.body.classList.contains("light-theme");
  if(colorKey === "dark" || !colorKey){
    card.style.background = "";
    card.style.borderColor = "";
    card.style.boxShadow = "";
    return;
  }
  if(isLight){
    card.style.background = c.lightBg || "";
    card.style.borderColor = c.lightBorder || "";
    card.style.boxShadow = "0 2px 12px "+c.glow;
  } else {
    card.style.background = c.bg;
    card.style.borderColor = c.border;
    card.style.boxShadow = "0 4px 20px "+c.glow;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMMUNITY BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setCB(id, votes, done, thresh){
  var e = ge(id+"-cb"); if(!e) return;
  if(done){ e.className="cb cb-ok"; e.textContent="âœ… Community Confirmed"; }
  else if(votes>=1){ e.className="cb cb-wait"; e.textContent="âš ï¸ Awaiting ("+votes+"/"+(thresh||3)+")"; }
  else{ e.className="cb cb-none"; e.textContent="â¬œ No votes yet"; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var isAdmin = sessionStorage.getItem("adm")==="1";
if(isAdmin) ge("admin-bar").classList.add("show");

function checkAdmin(){
  if(isAdmin) return true;
  var pw=prompt("ğŸ” Admin password:");
  if(pw===ILOCK){ isAdmin=true; sessionStorage.setItem("adm","1"); ge("admin-bar").classList.add("show"); toast("ğŸ” Admin access granted"); return true; }
  toast("âŒ Wrong password"); return false;
}
function adminLogout(){ if(!confirm("Exit admin?")) return; isAdmin=false; sessionStorage.removeItem("adm"); ge("admin-bar").classList.remove("show"); toast("Logged out"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var nOn=false, lnk="";
function initNotif(){
  if(!("Notification" in window)) return;
  if(Notification.permission==="granted"){ ge("notif-banner").style.display="none"; startNotif(); }
  else if(Notification.permission==="default") ge("notif-banner").classList.add("show");
}
function reqNotif(){
  ge("notif-btn").textContent="...";
  Notification.requestPermission().then(function(p){
    if(p==="granted"){ ge("notif-banner").classList.remove("show"); startNotif(); toast("ğŸ”” Meal reminders on!"); }
    else{ ge("notif-st").textContent="Denied â€” enable in browser settings"; ge("notif-btn").textContent="Enable"; }
  });
}
function startNotif(){ if(nOn) return; nOn=true; chkMeal(); setInterval(chkMeal,60000); }
function chkMeal(){
  if(Notification.permission!=="granted") return;
  var n=new Date(),h=n.getHours(),m=n.getMinutes(),k=h+":"+m;
  if(k===lnk) return;
  [{h:7,m:30,t:"ğŸ³ Breakfast is served!",b:"Head to mess!"},{h:12,m:30,t:"ğŸ½ï¸ Lunch time!",b:"Mess open for Lunch!"},{h:17,m:0,t:"â˜• Snacks time!",b:"Snacks at mess!"},{h:19,m:30,t:"ğŸŒ™ Dinner ready!",b:"Dinner served at mess!"}]
  .forEach(function(x){ if(h===x.h&&m===x.m){ new Notification(x.t,{body:x.b}); lnk=k; } });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKER (removed) â€” activity log still kept for internal use
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
db.ref("actLog").orderByChild("ts").limitToLast(20).on("value",function(snap){ /* kept for logAct */ });
function logAct(msg){ db.ref("actLog").push({msg:msg,ts:Date.now()}); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESS MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var bf13={Monday:"Vada+Sambar+Chutney+Shavige",Tuesday:"Poha+Fruits+Chowchow Bath+Chutney",Wednesday:"Plain Dosa+Aloo+Chutney+Egg",Thursday:"Bisi Belle Bath+Bread Jam+Fruits",Friday:"Green Moong Dosa+Oats+Chutney",Saturday:"Tomato Bath+Puliyogare+Chutney",Sunday:"Masala Dosa+Aloo+Chutney"};
var bf24={Monday:"Millets Khichdi+Vada+Sambar+Idly",Tuesday:"Lemon Rice+Bread Jam+Fruits",Wednesday:"Ragi Dosa+Dalia+Tomato Chutney+Egg",Thursday:"Onion Uthappam+Mangalore Bajji+Chutney",Friday:"Dal Khichdi+Dosa+Chutney",Saturday:"Pongal+Bread Jam+Fruits",Sunday:"Set Dosa+Chutney"};
var dm={Monday:{L:"Poori/Ragi Ball+Rice+Drumstick+Channa+Curd",S:"Cutlet+Tea",D:"Dal Makhni+Rice+Dal+Veg"},Tuesday:{L:"Methi Chapathi+Rice+Dal+Veg Pulav+Curd",S:"Kabuli Husli+Tea",D:"Soyabean+Radish Sambhar+Chapati"},Wednesday:{L:"Chapathi/Ragi+Rice+Paneer+Sprouts Sambhar",S:"Samosa+Tea",D:"Chapathi+Rice+Aloo+Rasam"},Thursday:{L:"Paratha+Rajma+Jeera Rice+Pudina Rice+Curd",S:"Vada Pav+Tea",D:"Chapathi+Egg Curry+Dal Palak+Salad"},Friday:{L:"Palak Chapati+Bhindi+Chicken Biryani+Curd",S:"Bhel Puri+Tea",D:"Chapathi+Rice+Dal+Veg"},Saturday:{L:"Chapathi+Rice+Dal+Mix Veg Beans+Curd",S:"Masala Vada+Tea",D:"Chapathi+Dal+Veg+Salad"},Sunday:{L:"Mushroom/Paneer Biryani+Salad",S:"Pav Bhaji+Tea",D:"Chapathi+Beetroot Palya+Veg"}};
var DAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function wkPat(d){ var fd=new Date(d.getFullYear(),d.getMonth(),1),wk=Math.ceil((d.getDate()+fd.getDay())/7); return(wk===1||wk===3)?"w13":"w24"; }
function nxMeal(){ var n=new Date(),h=n.getHours(),day=DAYS[n.getDay()]; if(h>=22){var t=new Date(n);t.setDate(t.getDate()+1);return{date:t,day:DAYS[t.getDay()],meal:"Breakfast"};} if(h>=18)return{date:n,day:day,meal:"Dinner"}; if(h>=15)return{date:n,day:day,meal:"Snacks"}; if(h>=10)return{date:n,day:day,meal:"Lunch"}; return{date:n,day:day,meal:"Breakfast"}; }
function getMnu(date,day,meal){ if(meal==="Breakfast") return (wkPat(date)==="w13"?bf13:bf24)[day]||""; var k={Lunch:"L",Snacks:"S",Dinner:"D"}[meal]; return dm[day]?dm[day][k]||"":""; }
function updMess(){ var n=nxMeal(); setText("mess-meal","Next: "+n.meal); setText("mess-menu",getMnu(n.date,n.day,n.meal)); }
updMess(); setInterval(updMess,60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEXT MEAL BANNER (top of page)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updMealBanner(){
  var n=nxMeal();
  var mealEmoji = {Breakfast:"ğŸ³",Lunch:"ğŸ½ï¸",Snacks:"â˜•",Dinner:"ğŸŒ™"};
  setText("meal-label-top", (mealEmoji[n.meal]||"ğŸ´") + "  Next Up");
  setText("meal-name-top", n.meal);
  setText("meal-day-top", n.day);
  // Render menu items as chips
  var menu = getMnu(n.date,n.day,n.meal)||"";
  var menuEl = document.getElementById("meal-menu-top");
  if(menuEl){
    if(menu){
      var items = menu.split("+").map(function(s){ return s.trim(); }).filter(Boolean);
      menuEl.innerHTML = items.map(function(i){ return '<span class="meal-item-chip">'+esc(i)+'</span>'; }).join('');
    } else {
      menuEl.innerHTML = '<span class="meal-item-chip">Menu not available</span>';
    }
  }
}
updMealBanner(); setInterval(updMealBanner,60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTING ENGINE
//  Uses atomic _voteCount so confirmed state is reliable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var confirmed = {};

function doVote(place, value, thresh){
  var dvRef = db.ref(place+"_dv/"+devId);
  dvRef.once("value",function(snap){
    if(snap.exists()) return toast("Already voted for "+place);
    dvRef.set({v:value,ts:Date.now()});

    db.ref(place+"_votedFor").once("value",function(vf){
      var cur=vf.val();
      if(cur && cur!==value){
        dvRef.remove();
        return toast("Vote in progress for: "+cur);
      }
      if(!cur) db.ref(place+"_votedFor").set(value);

      db.ref(place+"_voteCount").transaction(function(c){ return (c||0)+1; },function(err,ok,sn){
        if(err||!ok||!sn){ dvRef.remove(); return toast("Error voting, try again"); }
        var count=sn.val(), rem=thresh-count;
        if(count>=thresh){
          confirmed[place]=true;
          var writeVal = value.trim(); // normalise before writing
          console.log("WRITE:", place, writeVal);
          db.ref(place).set({status:writeVal,ts:Date.now()},function(){
            db.ref(place+"_voteCount").remove();
            db.ref(place+"_votedFor").remove();
            db.ref(place+"_dv").remove();
            db.ref(place+"_pend").remove();
          });
          logAct("âœ… "+thresh+"/"+thresh+" confirmed: "+place+" â†’ "+writeVal);
          toast("âœ… Community confirmed!");
        } else {
          db.ref(place+"_pend").set("Awaiting "+rem+" more confirmation(s)");
          logAct("ğŸ—³ï¸ "+place+" vote "+count+"/"+thresh+": "+value);
          toast("Vote recorded! "+rem+" more needed.");
        }
      });
    });
  });
  closeModal();
}

function adminSet(place, value){
  if(!checkAdmin()) return;
  db.ref(place).set({status:value,ts:Date.now()});
  db.ref(place+"_voteCount").remove();
  db.ref(place+"_votedFor").remove();
  db.ref(place+"_dv").remove();
  db.ref(place+"_pend").remove();
  logAct("ğŸ” Admin set: "+place+" â†’ "+value);
  toast("âœ… Override applied!"); closeModal();
}

function resetPlace(place){
  if(!checkAdmin()) return;
  db.ref(place).remove();
  db.ref(place+"_voteCount").remove();
  db.ref(place+"_votedFor").remove();
  db.ref(place+"_dv").remove();
  db.ref(place+"_pend").remove();
  logAct("ğŸ”„ Reset: "+place);
  toast("ğŸ”„ Reset to Not Updated"); closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenPlace(place, thresh, onStatus){
  db.ref(place).on("value",function(snap){
    var d=snap.val();
    if(!d||!d.status){
      confirmed[place]=false;
      // Clear stale device vote lock so user can vote in a new round
      db.ref(place+"_dv/"+devId).once("value",function(dvSnap){
        if(dvSnap.exists()) db.ref(place+"_dv/"+devId).remove();
      });
      setCB(place,0,false,thresh);
      onStatus(null);
      return;
    }
    confirmed[place]=true;
    setCB(place,0,true,thresh);
    onStatus(d);
  });
  db.ref(place+"_voteCount").on("value",function(snap){
    var c=snap.val()||0;
    var e=ge(place+"-vc"); if(e) e.textContent=c>0?"Votes: "+c:"";
    if(!confirmed[place]) setCB(place,c,false,thresh);
  });
  db.ref(place+"_pend").on("value",function(snap){
    var e=ge(place+"-pend"); if(e) e.textContent=(!confirmed[place]&&snap.val())?snap.val():"";
  });
}

// MESS
listenPlace("mess",T_MESS,function(d){
  var s=ge("mess-avail"),tEl=ge("mess-ts");
  if(!d){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  var status=(d.status||"").trim().toLowerCase();
  console.log("READ: mess â†’", JSON.stringify(d.status), "â†’ normalised:", status);
  if(status==="food available"){ s.className="sbdg s-green"; s.textContent="âœ… Food Available"; }
  else if(status==="not available"||status==="food not available"){ s.className="sbdg s-red"; s.textContent="âŒ Not Available"; }
  else { console.warn("mess unknown status:", d.status); s.className="sbdg s-gray"; s.textContent="âš  Unknown: "+d.status; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// NANDINI
listenPlace("nandini",T_NANDINI,function(d){
  var s=ge("nandini-avail"),tEl=ge("nandini-ts");
  if(!d){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  var status=(d.status||"").trim().toLowerCase();
  console.log("READ: nandini â†’", JSON.stringify(d.status), "â†’ normalised:", status);
  if(status==="open"){ s.className="sbdg s-green"; s.textContent="âœ… Open"; }
  else if(status==="closed"){ s.className="sbdg s-red"; s.textContent="ğŸ”’ Closed"; }
  else { console.warn("nandini unknown status:", d.status); s.className="sbdg s-gray"; s.textContent="âš  Unknown: "+d.status; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// NESCAFE
listenPlace("nescafe",T_NESCAFE,function(d){
  var s=ge("nescafe-avail"),tEl=ge("nescafe-ts");
  if(!d){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  var status=(d.status||"").trim().toLowerCase();
  console.log("READ: nescafe â†’", JSON.stringify(d.status), "â†’ normalised:", status);
  if(status==="open"){ s.className="sbdg s-green"; s.textContent="âœ… Open"; }
  else if(status==="closed"){ s.className="sbdg s-red"; s.textContent="ğŸ”’ Closed"; }
  else { console.warn("nescafe unknown status:", d.status); s.className="sbdg s-gray"; s.textContent="âš  Unknown: "+d.status; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// GYM
listenPlace("gym",T_GYM,function(d){
  var s=ge("gym-avail"),tEl=ge("gym-ts");
  if(!d){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  var status=(d.status||"").trim().toLowerCase();
  console.log("READ: gym â†’", JSON.stringify(d.status), "â†’ normalised:", status);
  if(status==="open"){ s.className="sbdg s-green"; s.textContent="âœ… Open"; }
  else if(status==="open Â· crowded"||status==="open crowded"||status==="crowded"){ s.className="sbdg s-amber"; s.textContent="âš ï¸ Open Â· Crowded"; }
  else if(status==="closed"){ s.className="sbdg s-red"; s.textContent="ğŸ”’ Closed"; }
  else { console.warn("gym unknown status:", d.status); s.className="sbdg s-gray"; s.textContent="âš  Unknown: "+d.status; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// BADMINTON
listenPlace("bad",T_BAD,function(d){
  var s=ge("bad-avail"),tEl=ge("bad-ts");
  if(!d||!s){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  var st=d.status||"Not Updated";
  if(st==="Full"){ s.className="sbdg s-red"; }
  else if(st.includes("1")||st.includes("2")){ s.className="sbdg s-amber"; }
  else { s.className="sbdg s-green"; }
  s.textContent=st;
  if(tEl) tEl.textContent=ago(d.ts);
});

// DOCTOR ON CAMPUS
listenPlace("doc",T_DOC,function(d){
  var s=ge("doc-avail"),tEl=ge("doc-ts");
  if(!d){ s.className="sbdg s-gray"; s.textContent="Not Updated"; if(tEl) tEl.textContent=""; return; }
  if(d.status==="On Campus"){ s.className="sbdg s-green"; s.textContent="âœ… On Campus"; }
  else { s.className="sbdg s-red"; s.textContent="âŒ Not Available"; }
  if(tEl) tEl.textContent=ago(d.ts);
});

// Suggestions
db.ref("suggestions").on("value",function(snap){ setText("sug-count",(snap.numChildren()||0)+" suggestion(s)"); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FACULTY LOCATOR (single tile â†’ modal with all faculty)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var facConf = {};
var facStatuses = {}; // cache latest status per key

function isOfficeHours(){
  var h=new Date().getHours();
  return h>=9 && h<18; // 9amâ€“6pm = office hours; outside = auto Out of Office
}

function getFacDisplay(key){
  // If outside office hours, auto show Out of Office regardless of DB status
  if(!isOfficeHours()) return {badge:"ğŸŒ™ Out of Office", color:"s-gray", auto:true};
  var d=facStatuses[key];
  if(!d) return {badge:"Not Updated", color:"s-gray", auto:false};
  if(d.status==="In Cabin") return {badge:"ğŸšª In Cabin", color:"s-teal", auto:false};
  if(d.status==="Not in Cabin") return {badge:"ğŸš« Not in Cabin", color:"s-red", auto:false};
  if(d.status==="In Class") return {badge:"ğŸ« In Class", color:"s-green", auto:false};
  if(d.status==="Admin")    return {badge:"ğŸ¢ Admin", color:"s-amber", auto:false};
  if(d.status==="On Leave") return {badge:"ğŸ–ï¸ On Leave", color:"s-red", auto:false};
  return {badge:d.status, color:"s-blue", auto:false};
}

function initFacultyListeners(){
  FACULTY.forEach(function(name,i){
    var key = "fac_"+i;
    listenFaculty(key, T_PROF);
  });
  // Re-check display every minute in case time crosses 6pm or 9am boundary
  setInterval(updateFacSummary, 60000);
}

function updateFacSummary(){
  if(!isOfficeHours()){
    setText("fac-summary","ğŸŒ™ Out of Office");
    return;
  }
  var updated=0, total=FACULTY.length;
  FACULTY.forEach(function(_,i){ if(facStatuses["fac_"+i]) updated++; });
  setText("fac-summary", updated+"/"+total+" updated");
}

function openFacultyLocator(){
  var officeHours=isOfficeHours();
  var rows = FACULTY.map(function(name,i){
    var key="fac_"+i;
    var disp=getFacDisplay(key);
    var short=name.replace(/^(Dr\.|Prof\.)\s/,"");
    var d=facStatuses[key];
    var ts_txt=(!disp.auto&&d)?ago(d.ts):"";
    var clickable=officeHours?"onclick=\"openFacModal("+i+")\"":"";
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid #1e1e35;'+(officeHours?'cursor:pointer;':'')+'" '+clickable+'>'+
      '<span style="font-size:0.88em;color:#e2e8f0;font-weight:600;">ğŸ‘¤ '+esc(short)+'</span>'+
      '<span style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">'+
        '<span class="sbdg '+disp.color+'" style="padding:3px 8px;font-size:0.72em;">'+disp.badge+'</span>'+
        (ts_txt?'<span style="font-size:0.6em;color:#444;">'+ts_txt+'</span>':'')+
      '</span></div>';
  }).join('');

  var officeNote=officeHours?'<p style="color:#888;font-size:0.78em;margin-bottom:10px;">Tap any faculty to update their location</p>':
    '<p style="color:#f59e0b;font-size:0.78em;margin-bottom:10px;">ğŸŒ™ Outside office hours (9amâ€“6pm) â€” all faculty shown as Out of Office</p>';

  var h='<div class="mh"><span>ğŸ“ Faculty Locator</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+=officeNote;
  h+='<div style="max-height:65vh;overflow-y:auto;">'+rows+'</div>';
  h+='<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';
  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function listenFaculty(key, thresh){
  db.ref(key).on("value",function(snap){
    var d=snap.val();
    if(!d||!d.status){
      facConf[key]=false;
      facStatuses[key]=null;
      // Clear stale device vote lock so user can vote in a new round
      db.ref(key+"_dv/"+devId).once("value",function(dvSnap){
        if(dvSnap.exists()) db.ref(key+"_dv/"+devId).remove();
      });
      setCB(key,0,false,thresh);
    } else {
      facConf[key]=true;
      facStatuses[key]=d;
      setCB(key,0,true,thresh);
    }
    updateFacSummary();
  });
  db.ref(key+"_voteCount").on("value",function(snap){
    var c=snap.val()||0;
    if(!facConf[key]) setCB(key,c,false,thresh);
  });
}

initFacultyListeners();
updateFacSummary();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adminRow(place, options){
  if(!isAdmin) return '';
  var btns = options.map(function(o){
    return '<button class="adm-btn" onclick="adminSet(\''+place+'\',\''+o.v+'\')">'+o.l+'</button>';
  }).join('');
  return '<div class="adm-sec"><div class="adm-lbl">ğŸ” Admin Override</div><div class="adm-row">'+btns+'</div></div>';
}

function openModal(place){
  var h='<div class="mh"><span>';

  if(place==='mess'){
    h+='ğŸ½ï¸ Mess</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'mess\',\'Food Available\','+T_MESS+')">âœ… Food Available</button>'+
      '<button class="mb r" onclick="doVote(\'mess\',\'Not Available\','+T_MESS+')">âŒ Not Available</button>'+
    '</div>'+
    adminRow('mess',[{v:'Food Available',l:'âœ… Food Available'},{v:'Not Available',l:'âŒ Not Available'}])+
    (isAdmin?'<button class="adm-btn" style="width:100%;margin-top:8px;" onclick="resetPlace(\'mess\')">ğŸ”„ Reset</button>':'')+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='nandini'){
    h+='ğŸ¥› Nandini</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'nandini\',\'Open\','+T_NANDINI+')">âœ… Open</button>'+
      '<button class="mb r" onclick="doVote(\'nandini\',\'Closed\','+T_NANDINI+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('nandini',[{v:'Open',l:'âœ… Open'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    (isAdmin?'<button class="adm-btn" style="width:100%;margin-top:8px;" onclick="resetPlace(\'nandini\')">ğŸ”„ Reset</button>':'')+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='nescafe'){
    h+='â˜• NescafÃ©</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'nescafe\',\'Open\','+T_NESCAFE+')">âœ… Open</button>'+
      '<button class="mb r" onclick="doVote(\'nescafe\',\'Closed\','+T_NESCAFE+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('nescafe',[{v:'Open',l:'âœ… Open'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    (isAdmin?'<button class="adm-btn" style="width:100%;margin-top:8px;" onclick="resetPlace(\'nescafe\')">ğŸ”„ Reset</button>':'')+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='gym'){
    h+='ğŸ‹ï¸ Gym</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'gym\',\'Open\','+T_GYM+')">âœ… Open</button>'+
      '<button class="mb a" onclick="doVote(\'gym\',\'Open Â· Crowded\','+T_GYM+')">âš ï¸ Open Â· Crowded</button>'+
      '<button class="mb r" onclick="doVote(\'gym\',\'Closed\','+T_GYM+')">ğŸ”’ Closed</button>'+
    '</div>'+
    adminRow('gym',[{v:'Open',l:'âœ… Open'},{v:'Open Â· Crowded',l:'âš ï¸ Crowded'},{v:'Closed',l:'ğŸ”’ Closed'}])+
    (isAdmin?'<button class="adm-btn" style="width:100%;margin-top:8px;" onclick="resetPlace(\'gym\')">ğŸ”„ Reset</button>':'')+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='bad'){
    h+='ğŸ¸ Badminton</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">How many courts FREE? (needs '+T_BAD+')</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'bad\',\'4 Free\','+T_BAD+')">ğŸŸ¢ All 4 Free</button>'+
      '<button class="mb g" onclick="doVote(\'bad\',\'3 Free\','+T_BAD+')">ğŸŸ¢ 3 Free</button>'+
      '<button class="mb a" onclick="doVote(\'bad\',\'2 Free\','+T_BAD+')">ğŸŸ¡ 2 Free</button>'+
      '<button class="mb a" onclick="doVote(\'bad\',\'1 Free\','+T_BAD+')">ğŸŸ¡ 1 Free</button>'+
      '<button class="mb r" onclick="doVote(\'bad\',\'Full\','+T_BAD+')">ğŸ”´ All Full</button>'+
    '</div>'+
    adminRow('bad',[
      {v:'4 Free',l:'ğŸŸ¢ 4 Free'},
      {v:'3 Free',l:'ğŸŸ¢ 3 Free'},
      {v:'2 Free',l:'ğŸŸ¡ 2 Free'},
      {v:'1 Free',l:'ğŸŸ¡ 1 Free'},
      {v:'Full',l:'ğŸ”´ Full'}  
    ])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='doc'){
    h+='ğŸ¥ Doctor on Campus</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Is the doctor on campus? (needs '+T_DOC+')</p>';
    h+='<div class="bst">'+
      '<button class="mb g" onclick="doVote(\'doc\',\'On Campus\','+T_DOC+')">âœ… Yes â€” Doctor on Campus</button>'+
      '<button class="mb r" onclick="doVote(\'doc\',\'Not Available\','+T_DOC+')">âŒ No â€” Not Available</button>'+
    '</div>'+
    adminRow('doc',[{v:'On Campus',l:'âœ… On Campus'},{v:'Not Available',l:'âŒ Not Available'}])+
    '<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';

  } else if(place==='sug'){
    h+='ğŸ’¡ Suggestions</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
    h+='<textarea class="mi" id="sug-in" rows="4" placeholder="Share an idea or bug report..."></textarea>';
    h+='<div class="bst"><button class="mb g" onclick="doSug()">Submit</button></div>';
    h+='<hr style="border:none;border-top:1px solid #2a2a3e;margin:14px 0;">';
    h+='<div id="sug-feed" style="max-height:200px;overflow-y:auto;"></div>';
    h+='<button class="mb x" style="margin-top:10px;" onclick="closeModal()">Close</button>';
    setTimeout(function(){
      db.ref("suggestions").orderByChild("ts").limitToLast(10).once("value",function(snap){
        var a=[]; snap.forEach(function(c){ a.push(c.val()); }); a.reverse();
        var e=ge("sug-feed"); if(!e) return;
        e.innerHTML=a.length?a.map(function(s){ return '<div style="background:rgba(255,255,255,0.03);border:1px solid #2a2a3e;border-radius:9px;padding:9px;margin-bottom:7px;font-size:0.8em;color:#94a3b8;">'+esc(s.text||'')+'<div style="font-size:0.7em;color:#444;margin-top:3px;">'+ago(s.ts)+'</div></div>'; }).join('') : '<p style="color:#444;text-align:center;padding:10px;">No suggestions yet</p>';
      });
    },100);
  }

  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function openFacModal(idx){
  if(!isOfficeHours()){ toast("ğŸŒ™ Faculty locator is active 9amâ€“6pm only"); return; }
  var key="fac_"+idx, name=FACULTY[idx];
  var h='<div class="mh"><span>ğŸ‘¤ '+esc(name)+'</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+='<p style="color:#888;font-size:0.8em;margin-bottom:10px;">Is '+esc(name.split(' ')[1]||name)+' in their cabin?</p>';
  h+='<div class="bst">'+
    '<button class="mb t" onclick="doVote(\''+key+'\',\'In Cabin\','+T_PROF+')">ğŸšª In Cabin</button>'+
    '<button class="mb r" onclick="doVote(\''+key+'\',\'Not in Cabin\','+T_PROF+')">ğŸš« Not in Cabin</button>'+
  '</div>';
  if(isAdmin){
    h+='<div class="adm-sec"><div class="adm-lbl">ğŸ” Admin Override</div><div class="adm-row">'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'In Cabin\')">In Cabin</button>'+
      '<button class="adm-btn" onclick="adminSet(\''+key+'\',\'Not in Cabin\')">Not in Cabin</button>'+
    '</div></div>';
  }
  h+='<button class="mb x" style="margin-top:14px;" onclick="closeModal()">Close</button>';
  ge("mbox").innerHTML=h;
  ge("modal").classList.add("active");
}

function closeModal(){ ge("modal").classList.remove("active"); }
function bgClose(e){ if(e.target===ge("modal")) closeModal(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSug(){
  var t=(ge("sug-in")||{}).value||""; t=t.trim();
  if(!t) return alert("Please enter something");
  db.ref("suggestions").push({text:t,ts:Date.now()});
  logAct("ğŸ’¡ Suggestion submitted");
  toast("Thanks!"); closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANNOUNCEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAnnPost(){
  if(!checkAdmin()) return;
  var h='<div class="mh"><span>ğŸ“¢ Post Announcement</span><button class="mx" onclick="closeModal()">âœ•</button></div>';
  h+='<textarea class="mi" id="ann-in" rows="4" placeholder="Announcement text..."></textarea>';
  h+='<select class="msel" id="ann-tag"><option value="general">General</option><option value="mess">ğŸ› Mess</option><option value="event">ğŸ‰ Event</option><option value="academic">ğŸ“š Academic</option></select>';
  h+='<div class="bst"><button class="mb g" onclick="postAnn()">Post Announcement</button><button class="mb x" onclick="closeModal()">Cancel</button></div>';
  ge("mbox").innerHTML=h; ge("modal").classList.add("active");
}
function postAnn(){
  var t=(ge("ann-in")||{}).value||""; t=t.trim();
  var tag=(ge("ann-tag")||{}).value||"general";
  if(!t) return alert("Please enter text");
  db.ref("announcements").push({text:t,tag:tag,ts:Date.now()});
  logAct("ğŸ“¢ Announcement posted");
  toast("ğŸ“¢ Posted!"); closeModal();
}
function delAnn(id){ if(!checkAdmin()) return; if(!confirm("Delete?")) return; db.ref("announcements/"+id).remove(); toast("Deleted"); }
function cleanAnn(){ db.ref("announcements").once("value",function(snap){ var now=Date.now(); snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)>ANN_EXP) db.ref("announcements/"+c.key).remove(); }); }); }
cleanAnn(); setInterval(cleanAnn,300000);

db.ref("announcements").orderByChild("ts").on("value",function(snap){
  var posts=[],now=Date.now();
  snap.forEach(function(c){ var d=c.val(); if(d&&(now-d.ts)<ANN_EXP) posts.push({id:c.key,...d}); });
  posts.reverse();
  var con=ge("ann-list");
  if(!posts.length){ con.innerHTML='<div class="ann-empty">ğŸ“­ No announcements yet</div>'; return; }
  con.innerHTML='<div class="ann-list-inner">'+posts.map(function(p){
    var exp=Math.ceil((ANN_EXP-(now-p.ts))/60000);
    var expTxt=exp>60?Math.ceil(exp/60)+"hr left":exp+"m left";
    var cardClass="ann-card tag-"+(p.tag||"general")+"-card";
    return '<div class="'+cardClass+'">'+
      '<div class="ann-txt">'+esc(p.text)+'</div>'+
      '<div class="ann-meta">'+
        '<span class="ann-tag tag-'+(p.tag||"general")+'">'+(p.tag||"general")+'</span>'+
        '<span class="ann-ts">'+ago(p.ts)+'</span>'+
        '<span class="ann-exp">â± '+expTxt+'</span>'+
        (isAdmin?'<button class="ann-del" onclick="delAnn(\''+p.id+'\')">ğŸ—‘</button>':'')+
      '</div>'+
    '</div>';
  }).join('')+'</div>';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMMEDIATE UPDATES + DOWNVOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
db.ref("immediateUpdates").orderByChild("ts").limitToLast(10).on("value",function(snap){
  var sec=ge("imm-wrap"),con=ge("imm-list"),posts=[];
  snap.forEach(function(c){ posts.push({id:c.key,...c.val()}); });
  posts.reverse();
  if(!posts.length){ sec.style.display="none"; return; }
  sec.style.display="block";
  con.innerHTML=posts.map(function(p){
    var dv=p.downvotes||0,dvd=!!localStorage.getItem("idv_"+p.id);
    return '<div class="imm-card">'+esc(p.text)+
      '<div class="imm-meta">ğŸ”´ Crowd verified Â· '+ago(p.ts)+
      ' <span style="color:#92400e;">'+dv+'/5 downvotes</span>'+
      '<button class="dv-btn" onclick="'+(dvd?'toast(\'Already downvoted\')':'dvImm(\''+p.id+'\')')+'" '+(dvd?'style="opacity:0.4;"':'')+'>ğŸ‘</button>'+
      (isAdmin?'<button class="ann-del" onclick="admDel(\''+p.id+'\')">ğŸ—‘</button>':'')+
      '</div></div>';
  }).join('');
});

function dvImm(id){
  var k="idv_"+id; if(localStorage.getItem(k)) return toast("Already downvoted");
  localStorage.setItem(k,"1");
  db.ref("immediateUpdates/"+id).transaction(function(d){ if(!d) return d; d.downvotes=(d.downvotes||0)+1; return d; },function(err,ok,snap){
    if(!snap) return; var d=snap.val();
    if(d&&d.downvotes>=IMM_DV){ db.ref("immediateUpdates/"+id).remove(); logAct("ğŸ—‘ï¸ Update removed by community"); toast("Post removed by community"); }
    else toast("Downvoted ("+(d?d.downvotes:1)+"/5)");
  });
}
function admDel(id){ if(!checkAdmin()) return; db.ref("immediateUpdates/"+id).remove(); toast("Deleted"); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEARTBEAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCC(){ var v=ge("hb-txt").value,c=ge("chct"); c.textContent=v.length+" / 80"; c.className="chct"+(v.length>70?" warn":""); }
function postHB(){
  var t=ge("hb-txt").value.trim();
  if(!t) return alert("Write something"); if(t.length>80) return alert("Max 80 chars");
  db.ref("heartbeat").push({text:t,ts:Date.now(),upvotes:0,graduated:false});
  showFloatingMessage(t);
  logAct("ğŸ’¬ Chat: \""+t.slice(0,28)+(t.length>28?"â€¦":"")+"\"");
  ge("hb-txt").value=""; ge("chct").textContent="0 / 80";
}
function uvHB(id){
  var k="hbv_"+id; if(localStorage.getItem(k)) return toast("Already upvoted");
  localStorage.setItem(k,"1");
  db.ref("heartbeat/"+id).transaction(function(d){ if(!d) return d; d.upvotes=(d.upvotes||0)+1; return d; },function(err,ok,snap){
    if(!snap) return; var d=snap.val();
    if(d&&d.upvotes>=HB_VOTES&&!d.graduated){
      db.ref("immediateUpdates").push({text:d.text,ts:Date.now()});
      db.ref("heartbeat/"+id).update({graduated:true});
      logAct("ğŸ”´ Heartbeat graduated!");
      setTimeout(function(){ db.ref("heartbeat/"+id).remove(); },2500);
    }
  });
}
function cleanHB(){ db.ref("heartbeat").once("value",function(snap){ var now=Date.now(); snap.forEach(function(c){ var d=c.val(); if(d&&!d.graduated&&(now-d.ts)>HB_TTL) db.ref("heartbeat/"+c.key).remove(); }); }); }
cleanHB(); setInterval(cleanHB,30000);

db.ref("heartbeat").on("value",function(snap){
  var feed=ge("hb-feed"),now=Date.now(),posts=[];
  snap.forEach(function(c){ var d=c.val(); if(d&&!d.graduated) posts.push({id:c.key,...d}); });
  posts.sort(function(a,b){ return b.ts-a.ts; });
  if(!posts.length){ feed.innerHTML='<div class="hb-empty">No messages yet Â· be the first to chat</div>'; return; }
  feed.innerHTML=posts.map(function(p){
    var rem=Math.max(0,HB_TTL-(now-p.ts)),pct=(rem/HB_TTL)*100,secs=Math.ceil(rem/1000);
    var opacity=Math.max(0.3,pct/100);
    return '<div class="hb-card" style="opacity:'+opacity+';border-color:rgba(255,77,109,'+Math.min(0.4,opacity*0.5)+');">'+
      '<div style="flex:1;">'+
        '<div class="hb-txt" style="font-size:1em;font-weight:700;color:#ff8fa3;letter-spacing:-0.2px;">'+esc(p.text)+'</div>'+
        '<div style="font-size:0.6em;color:#7f3040;margin-top:4px;">â± fades in '+secs+'s</div>'+
        '<div class="tbar"><div class="tfil" style="width:'+pct+'%"></div></div>'+
      '</div></div>';
  }).join('');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initNotif();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAST UPDATED TIME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLastUpdated(){
  var now=new Date();
  var h=now.getHours().toString().padStart(2,'0');
  var m=now.getMinutes().toString().padStart(2,'0');
  var day=now.toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
  setText("last-updated-time", day+" Â· "+h+":"+m);
}
updateLastUpdated(); setInterval(updateLastUpdated, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NIGHT MODE (10pmâ€“6am)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isNight(){
  var h=new Date().getHours();
  return h>=22 || h<6;
}
function applyNightMode(){
  var night=isNight();
  var banner=ge("night-banner");
  var overlay=ge("night-overlay");
  if(banner) banner.classList.toggle("show", night);
  if(overlay) overlay.classList.toggle("show", night);
}
applyNightMode(); setInterval(applyNightMode, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO FOOD NOT AVAILABLE (30min after meal ends)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var mealEndTimes = [
  {h:9, m:30,  meal:"Breakfast"},
  {h:14, m:30, meal:"Lunch"},
  {h:18, m:30, meal:"Snacks"},
  {h:21, m:30, meal:"Dinner"}
];
function checkAutoFoodStatus(){
  var now=new Date(), h=now.getHours(), m=now.getMinutes();
  var totalMin=h*60+m;
  mealEndTimes.forEach(function(me){
    var endMin=me.h*60+me.m;
    // Window: from meal end to meal end + 30min
    if(totalMin>=endMin && totalMin<endMin+30){
      // Auto-set mess to Not Available if not already set by community
      db.ref("mess").once("value",function(snap){
        var d=snap.val();
        // Only override if current status is "Food Available" or nothing, not if already "Not Available"
        if(!d||d.status==="Food Available"){
          db.ref("mess").set({status:"Not Available",ts:Date.now(),autoSet:true});
          logAct("â° Auto: Mess â†’ Not Available after "+me.meal);
        }
      });
    }
  });
}
checkAutoFoodStatus(); setInterval(checkAutoFoodStatus, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGEST OPEN TILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSugOpen(){
  var inp=ge("sug-open-in"); if(!inp) return;
  var t=inp.value.trim();
  if(!t) return toast("Write something first!");
  db.ref("suggestions").push({text:t,ts:Date.now()});
  logAct("ğŸ’¡ Suggestion submitted");
  toast("Thanks for the suggestion! ğŸ’¡");
  inp.value="";
  loadSugFeedInline();
}
function loadSugFeedInline(){
  db.ref("suggestions").orderByChild("ts").limitToLast(5).once("value",function(snap){
    var a=[]; snap.forEach(function(c){ a.push(c.val()); }); a.reverse();
    var e=ge("sug-feed-inline"); if(!e) return;
    e.innerHTML=a.length?a.map(function(s){
      return '<div class="sug-inline-card">'+esc(s.text||'')+'<span style="font-size:0.75em;color:#444;margin-left:6px;">'+ago(s.ts)+'</span></div>';
    }).join(''):'';
  });
}
loadSugFeedInline(); setInterval(loadSugFeedInline,30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOATING CHAT MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showFloatingMessage(text){
  var overlay=ge("hb-float-overlay"); if(!overlay) return;
  var el=document.createElement("div");
  el.className="hb-float-msg";
  el.textContent=text;
  // Random position (avoid edges)
  var x=10+Math.random()*60; // 10â€“70% from left
  var y=15+Math.random()*60; // 15â€“75% from top
  el.style.left=x+"%";
  el.style.top=y+"%";
  el.style.transform="translate(-50%,-50%)";
  overlay.appendChild(el);
  setTimeout(function(){ el.remove(); },61000);
}
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO TILE BORDER + BACKGROUND COLOR ENGINE
//  (No changes needed anywhere else)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function(){

  function norm(t){
    return String(t||"")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g,"")
      .replace(/\s+/g," ")
      .trim();
  }

  function getColorFromText(text){
    var t = norm(text);

    if(!t || t==="not updated") return "dark";

    // RED CONDITIONS
    if(
      t.includes("closed") ||
      t.includes("not available") ||
      t.includes("full") ||
      t.includes("on leave") ||
      t.includes("not in cabin")
    ) return "red";

    // AMBER CONDITIONS
    if(
      t.includes("crowded") ||
      t.includes("1 free") ||
      t.includes("2 free") ||
      t.includes("awaiting")
    ) return "amber";

    // GREEN CONDITIONS
    if(
      t.includes("open") ||
      t.includes("available") ||
      t.includes("food available") ||
      t.includes("on campus") ||
      t.includes("3 free") ||
      t.includes("4 free") ||
      t.includes("in class") ||
      t.includes("in cabin")
    ) return "green";

    return "dark";
  }

  function applyAutoColors(){

    var mappings = [
      {card:"mess-card", badge:"mess-avail"},
      {card:"nandini-card", badge:"nandini-avail"},
      {card:"nescafe-card", badge:"nescafe-avail"},
      {card:"gym-card", badge:"gym-avail"},
      {card:"bad-card", badge:"bad-avail"},
      {card:"doc-card", badge:"doc-avail"}
    ];

    mappings.forEach(function(item){
      var badge = document.getElementById(item.badge);
      if(!badge) return;

      var color = getColorFromText(badge.textContent);
      if(typeof paintCard === "function"){
        paintCard(item.card, color);
      }
    });

  }

  // Run immediately
  applyAutoColors();

  // Sync live (Firebase updates)
  var observer = new MutationObserver(applyAutoColors);
  observer.observe(document.body, {
    childList:true,
    subtree:true,
    characterData:true
  });

})();
</script>

<script>
(function () {
  let deferredInstallPrompt = null;

  function isStandaloneMode() {
    return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  }

  function notify(msg) {
    if (typeof toast === "function") toast(msg);
    else alert(msg);
  }

  function ensureInstallButton() {
    let btn = document.getElementById("install-btn");
    if (btn) return btn;

    btn = document.createElement("button");
    btn.id = "install-btn";
    btn.textContent = "ğŸ“² Add to Home";
    btn.style.cssText = [
      "display:none",
      "position:fixed",
      "bottom:20px",
      "left:20px",
      "background:linear-gradient(135deg,#10b981,#059669)",
      "color:#fff",
      "border:none",
      "border-radius:30px",
      "padding:11px 17px",
      "font-size:0.82em",
      "font-weight:700",
      "cursor:pointer",
      "box-shadow:0 4px 14px rgba(16,185,129,0.35)",
      "z-index:999",
      "font-family:'Plus Jakarta Sans',sans-serif"
    ].join(";");

    document.body.appendChild(btn);
    return btn;
  }

  function showInstallBtn(show) {
    const btn = ensureInstallButton();
    btn.style.display = show ? "block" : "none";
  }

  async function installApp() {
    if (isStandaloneMode()) {
      notify("âœ… App already added to home screen");
      return;
    }

    if (deferredInstallPrompt) {
      deferredInstallPrompt.prompt();
      try {
        await deferredInstallPrompt.userChoice;
      } catch (_) {}
      deferredInstallPrompt = null;
      showInstallBtn(false);
      return;
    }

    alert(
`To add this app to your home screen:

â€¢ iPhone (Safari): Tap Share â†’ Add to Home Screen
â€¢ Android (Chrome): Tap menu â‹® â†’ Add to Home screen`
    );
  }

  window.addEventListener("beforeinstallprompt", function (e) {
    e.preventDefault();
    deferredInstallPrompt = e;
    if (!isStandaloneMode()) showInstallBtn(true);
  });

  window.addEventListener("appinstalled", function () {
    showInstallBtn(false);
    notify("âœ… Added to home screen");
  });

  const btn = ensureInstallButton();
  btn.addEventListener("click", installApp);

  if (!isStandaloneMode()) showInstallBtn(true);
})();
</script>
<!-- Campus Uno is now the big tile below the grid -->

<!-- PWA install handled above -->


<script>
(function(){

  const btn = document.getElementById("theme-toggle");
  const body = document.body;

  function setTheme(mode){
    if(mode === "light"){
      body.classList.add("light-theme");
      btn.textContent = "â˜€ï¸ Light";
      localStorage.setItem("theme","light");
    } else {
      body.classList.remove("light-theme");
      btn.textContent = "ğŸŒ™ Dark";
      localStorage.setItem("theme","dark");
    }
    // Repaint cards for new theme
    if(typeof applyAutoColors === "function") setTimeout(applyAutoColors, 50);
  }

  // Default = light theme unless user explicitly chose dark
  const saved = localStorage.getItem("theme");
  if(saved === "dark"){
    setTheme("dark");
  } else {
    setTheme("light");
  }

  btn.addEventListener("click",function(){
    if(body.classList.contains("light-theme")){
      setTheme("dark");
    } else {
      setTheme("light");
    }
  });

})();
</script>


</body>
</html>

